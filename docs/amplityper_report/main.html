<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.3.0"/>
    <title>amplityper_report.main API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#ConfigParams">ConfigParams</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ConfigParams.__init__">ConfigParams</a>
                        </li>
                        <li>
                                <a class="variable" href="#ConfigParams.ivar_pattern">ivar_pattern</a>
                        </li>
                        <li>
                                <a class="variable" href="#ConfigParams.fasta_pattern">fasta_pattern</a>
                        </li>
                        <li>
                                <a class="variable" href="#ConfigParams.tidyvcf_pattern">tidyvcf_pattern</a>
                        </li>
                        <li>
                                <a class="variable" href="#ConfigParams.fasta_split_char">fasta_split_char</a>
                        </li>
                        <li>
                                <a class="variable" href="#ConfigParams.fasta_split_index">fasta_split_index</a>
                        </li>
                        <li>
                                <a class="variable" href="#ConfigParams.ivar_split_char">ivar_split_char</a>
                        </li>
                        <li>
                                <a class="variable" href="#ConfigParams.id_split_index">id_split_index</a>
                        </li>
                        <li>
                                <a class="variable" href="#ConfigParams.hap_split_index">hap_split_index</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#parse_command_line_args">parse_command_line_args</a>
            </li>
            <li>
                    <a class="function" href="#parse_configurations">parse_configurations</a>
            </li>
            <li>
                    <a class="function" href="#construct_file_list">construct_file_list</a>
            </li>
            <li>
                    <a class="function" href="#compile_data_with_io">compile_data_with_io</a>
            </li>
            <li>
                    <a class="function" href="#collect_file_lists">collect_file_lists</a>
            </li>
            <li>
                    <a class="function" href="#generate_seq_dict">generate_seq_dict</a>
            </li>
            <li>
                    <a class="function" href="#compile_mutation_codons">compile_mutation_codons</a>
            </li>
            <li>
                    <a class="function" href="#compile_contig_depths">compile_contig_depths</a>
            </li>
            <li>
                    <a class="function" href="#generate_gene_df">generate_gene_df</a>
            </li>
            <li>
                    <a class="function" href="#construct_long_df">construct_long_df</a>
            </li>
            <li>
                    <a class="function" href="#construct_short_df">construct_short_df</a>
            </li>
            <li>
                    <a class="function" href="#compute_crude_dnds_ratio">compute_crude_dnds_ratio</a>
            </li>
            <li>
                    <a class="function" href="#assign_haplotype_names">assign_haplotype_names</a>
            </li>
            <li>
                    <a class="function" href="#aggregate_haplotype_df">aggregate_haplotype_df</a>
            </li>
            <li>
                    <a class="function" href="#main">main</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
amplityper_report<wbr>.main    </h1>

                        <div class="docstring"><p>This module compiles and evaluates the results from the Amplityper amplicon-based
haplotype phasing pipeline. In particular, it reports the haplotypes at each amplicon,
sorted by the frequencies, alongside the synonymous and nonsynonymous mutations in
those haplotypes.</p>

<pre><code>usage: at_report [-h] --results_dir RESULTS_DIR --gene_bed GENE_BED [--config CONFIG] [--resume RESUME]

options:
  -h, --help            show this help message and exit
  --results_dir RESULTS_DIR, -d RESULTS_DIR
                        Results 'root' directory to traverse in search if iVar tables and other files
  --gene_bed GENE_BED, -b GENE_BED
                        BED of amplicons where the final column contains genes associated with each amplicon
  --config CONFIG, -c CONFIG
                        YAML file used to configure module such that it avoids harcoding
  --resume RESUME, -r RESUME
                        Whether to resume if intermediate files from previous runs are detected.
</code></pre>
</div>

                        <input id="mod-main-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-main-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="ch">#!/usr/bin/env python3</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="sd">This module compiles and evaluates the results from the Amplityper amplicon-based</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="sd">haplotype phasing pipeline. In particular, it reports the haplotypes at each amplicon,</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="sd">sorted by the frequencies, alongside the synonymous and nonsynonymous mutations in</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="sd">those haplotypes.</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="sd">```</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="sd">usage: at_report [-h] --results_dir RESULTS_DIR --gene_bed GENE_BED [--config CONFIG] [--resume RESUME]</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">options:</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="sd">  -h, --help            show this help message and exit</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="sd">  --results_dir RESULTS_DIR, -d RESULTS_DIR</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="sd">                        Results &#39;root&#39; directory to traverse in search if iVar tables and other files</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">  --gene_bed GENE_BED, -b GENE_BED</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">                        BED of amplicons where the final column contains genes associated with each amplicon</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">  --config CONFIG, -c CONFIG</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">                        YAML file used to configure module such that it avoids harcoding</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">  --resume RESUME, -r RESUME</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">                        Whether to resume if intermediate files from previous runs are detected.</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">```</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="kn">import</span> <span class="nn">argparse</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="kn">import</span> <span class="nn">itertools</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">cast</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="kn">import</span> <span class="nn">amplityper_core</span> <span class="k">as</span> <span class="nn">atc</span>  <span class="c1"># type: ignore</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="kn">import</span> <span class="nn">polars</span> <span class="k">as</span> <span class="nn">pl</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="kn">from</span> <span class="nn">icecream</span> <span class="kn">import</span> <span class="n">ic</span>  <span class="c1"># type: ignore # pylint: disable=import-error</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="kn">from</span> <span class="nn">pydantic.dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="kn">from</span> <span class="nn">result</span> <span class="kn">import</span> <span class="n">Err</span><span class="p">,</span> <span class="n">Ok</span><span class="p">,</span> <span class="n">Result</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="kn">from</span> <span class="nn">strictyaml</span> <span class="kn">import</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Map</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span> <span class="n">YAMLError</span><span class="p">,</span> <span class="n">load</span>  <span class="c1"># type: ignore</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>  <span class="c1"># type: ignore # pylint: disable=import-error</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="k">class</span> <span class="nc">ConfigParams</span><span class="p">:</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="sd">    The available config parameters provided in YAML format to this module are</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">    converted into this dataclass for easier access downstream and more strict</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd">    typing of each field.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>    <span class="n">ivar_pattern</span><span class="p">:</span> <span class="n">Path</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>    <span class="n">fasta_pattern</span><span class="p">:</span> <span class="n">Path</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>    <span class="n">tidyvcf_pattern</span><span class="p">:</span> <span class="n">Path</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>    <span class="n">fasta_split_char</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>    <span class="n">fasta_split_index</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>    <span class="n">ivar_split_char</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>    <span class="n">id_split_index</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>    <span class="n">hap_split_index</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="k">def</span> <span class="nf">parse_command_line_args</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">        Parse command line arguments while passing errors onto main.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">    Args:</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">        `None`</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">    Returns:</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">        `Result[argparse.Namespace, str]`: A Result type containing an `argparse` namespace</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">        or an error message string.</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="s2">&quot;--results_dir&quot;</span><span class="p">,</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="s2">&quot;-d&quot;</span><span class="p">,</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Results &#39;root&#39; directory to traverse in search if iVar tables and other files&quot;</span><span class="p">,</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>    <span class="p">)</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="s2">&quot;--gene_bed&quot;</span><span class="p">,</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="s2">&quot;-b&quot;</span><span class="p">,</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;BED of amplicons where the final column contains genes associated with each amplicon&quot;</span><span class="p">,</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>    <span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="s2">&quot;--config&quot;</span><span class="p">,</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;YAML file used to configure module such that it avoids harcoding&quot;</span><span class="p">,</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>    <span class="p">)</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        <span class="s2">&quot;--resume&quot;</span><span class="p">,</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="s2">&quot;-r&quot;</span><span class="p">,</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to resume if intermediate files from previous runs are detected.&quot;</span><span class="p">,</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>    <span class="p">)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span><span class="s2">&quot;Arguments could not properly be parsed.&quot;</span><span class="p">)</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>    <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="k">def</span> <span class="nf">parse_configurations</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">ConfigParams</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">        This module uses the library `strictYAML` to perform very strict, statically</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">        typed configuration. This helps catch errors downstream while also doing away with</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">        most hardcoding, which is likely to cause runtime errors for other users. Like</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">        the other functions in this module, it uses Rust-like result types to handle</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">        potential errors and pass them &quot;up&quot; to the main function.</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">    Args:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">        `config_path: str`: A simple file path to a YAML-formatted config file in string</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">        format.</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">    Returns:</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="sd">        `Result[ConfigParams, str]`: A result-type containing either an instance of the</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a><span class="sd">        dataclass `ConfigParams` or an error message in string format.</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>    <span class="c1"># define the statically typed schema for the config parameters</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>    <span class="n">schema</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>        <span class="p">{</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>            <span class="s2">&quot;ivar_pattern&quot;</span><span class="p">:</span> <span class="n">Str</span><span class="p">(),</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>            <span class="s2">&quot;fasta_pattern&quot;</span><span class="p">:</span> <span class="n">Str</span><span class="p">(),</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>            <span class="s2">&quot;tidyvcf_pattern&quot;</span><span class="p">:</span> <span class="n">Str</span><span class="p">(),</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>            <span class="s2">&quot;fasta_split_char&quot;</span><span class="p">:</span> <span class="n">Str</span><span class="p">(),</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>            <span class="s2">&quot;fasta_split_index&quot;</span><span class="p">:</span> <span class="n">Int</span><span class="p">(),</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>            <span class="s2">&quot;ivar_split_char&quot;</span><span class="p">:</span> <span class="n">Str</span><span class="p">(),</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>            <span class="s2">&quot;id_split_index&quot;</span><span class="p">:</span> <span class="n">Int</span><span class="p">(),</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>            <span class="s2">&quot;hap_split_index&quot;</span><span class="p">:</span> <span class="n">Int</span><span class="p">(),</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>        <span class="p">}</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>    <span class="p">)</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>    <span class="c1"># use the schema and the provided path to parse out a dictionary of parameters</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>        <span class="n">config_dict</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>            <span class="nb">dict</span><span class="p">,</span> <span class="n">load</span><span class="p">((</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="o">/</span> <span class="n">config_path</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">(),</span> <span class="n">schema</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>        <span class="p">)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">message</span><span class="p">:</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The provided YAML file could not be parsed:</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>    <span class="k">except</span> <span class="n">YAMLError</span> <span class="k">as</span> <span class="n">message</span><span class="p">:</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The provided YAML file could not be parsed:</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">ConfigParams</span><span class="p">(</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>        <span class="n">ivar_pattern</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ivar_pattern&quot;</span><span class="p">)),</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>        <span class="n">fasta_pattern</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fasta_pattern&quot;</span><span class="p">)),</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>        <span class="n">tidyvcf_pattern</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tidyvcf_pattern&quot;</span><span class="p">)),</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>        <span class="n">fasta_split_char</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fasta_split_char&quot;</span><span class="p">)),</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>        <span class="n">fasta_split_index</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fasta_split_index&quot;</span><span class="p">)),</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>        <span class="n">ivar_split_char</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ivar_split_char&quot;</span><span class="p">)),</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>        <span class="n">id_split_index</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id_split_index&quot;</span><span class="p">)),</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="n">hap_split_index</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hap_split_index&quot;</span><span class="p">)),</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>    <span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Configurations parsed.&quot;</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>    <span class="n">ic</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>    <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="k">def</span> <span class="nf">construct_file_list</span><span class="p">(</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>    <span class="n">results_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">glob_pattern</span><span class="p">:</span> <span class="n">Path</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">        Function `construct_file_list()` uses the provided path of wildcards</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">        to expand out all available files to be compiled downstream.</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a><span class="sd">    Args:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a><span class="sd">        `results_dir: Path`: A Pathlib path instance recording the results</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="sd">        &quot;root&quot; directory, which is the top of the Amplityper results hierarchy.</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a><span class="sd">        `ivar_pattern: Path`: A Pathlib path instance containing wildcards</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">        that can be expanded to the desired files.</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">    Returns:</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">        `Result[List[Path], str]`: A Result type instance containing either</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">        a list of paths to the desired files, or an error message string.</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Constructing file list:&quot;</span><span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>    <span class="n">ic</span><span class="p">(</span><span class="n">glob_pattern</span><span class="p">)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>    <span class="c1"># collect a list of all the files to search</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>    <span class="c1"># pylint: disable-next=c-extension-no-member</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>    <span class="n">files_to_query</span> <span class="o">=</span> <span class="n">atc</span><span class="o">.</span><span class="n">build_file_list</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">results_dir</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">glob_pattern</span><span class="p">))</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>    <span class="c1"># make sure that there aren&#39;t duplicates</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>        <span class="nb">set</span><span class="p">(</span><span class="n">files_to_query</span><span class="p">)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">message</span><span class="p">:</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Redundant files present that may corrupt results:</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_to_query</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>            <span class="sa">f</span><span class="s2">&quot;No files found that match the wildcard path:</span><span class="se">\n</span><span class="si">{</span><span class="n">glob_pattern</span><span class="si">}</span><span class="se">\n</span><span class="s2">within </span><span class="si">{</span><span class="n">results_dir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>        <span class="p">)</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>    <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">files_to_query</span><span class="p">)</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="k">def</span> <span class="nf">compile_data_with_io</span><span class="p">(</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>    <span class="n">file_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParams</span><span class="p">,</span> <span class="n">whether_resume</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a><span class="sd">        Function `compile_data_with_io()` takes the list of paths and</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a><span class="sd">        reads each file, parsing it with Polars, and writing it into one</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a><span class="sd">        large temporary TSV file. This method for compiling all files into</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a><span class="sd">        one involves a great deal of read-write, but it also avoids potential</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a><span class="sd">        type mismatch issues between a type schema inferred for one dataframe</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a><span class="sd">        and the type schema inferred for the next. Downstream, the new</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a><span class="sd">        TSV can be parsed into a single dataframe where it&#39;s possible to</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a><span class="sd">        infer a type scheme from many rows.</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a><span class="sd">    Args:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="sd">        `file_list: List[Path]`: A list of paths, where each path points to</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="sd">        a TSV file generated by iVar.</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">    Returns:</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame to be queries and transformed</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">        downstream.</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">whether_resume</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="n">all_contigs</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_ipc</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">,</span> <span class="n">memory_map</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">all_contigs</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Compiling variant data for each contig.&quot;</span><span class="p">)</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>    <span class="n">ic</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>    <span class="c1"># Use core module written in Rust to traverse the file system and run</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>    <span class="c1"># read/writes quickly</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>    <span class="n">atc</span><span class="o">.</span><span class="n">collate_results</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span>  <span class="c1"># pylint: disable=c-extension-no-member</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Converting variant data to compressed arrow format.&quot;</span><span class="p">)</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>    <span class="c1"># lazily scan the new tmp tsv for usage downstream</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>    <span class="n">pl</span><span class="o">.</span><span class="n">scan_csv</span><span class="p">(</span><span class="s2">&quot;tmp.tsv&quot;</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">infer_schema_length</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="s2">&quot;POS&quot;</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">sink_ipc</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;zstd&quot;</span><span class="p">)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>    <span class="n">all_contigs</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_ipc</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">,</span> <span class="n">memory_map</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.tsv&quot;</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>    <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">all_contigs</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a><span class="k">def</span> <span class="nf">collect_file_lists</span><span class="p">(</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>    <span class="n">results_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">pattern1</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">pattern2</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">pattern3</span><span class="p">:</span> <span class="n">Path</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a><span class="sd">        Function `collect_file_lists()` quarterbacks sequential executions of</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a><span class="sd">        the `construct_file_list()` function, each with a different wildcard</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a><span class="sd">        pattern. Doing so keeps the size of `main()` more reasonable and will</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a><span class="sd">        also make potential refactoring easier in the future.</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a><span class="sd">    Args:</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="sd">        `results_dir: Path`: A Pathlib Path type pointing to the results &quot;root&quot;</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="sd">        directory to be searched with the following glob wildcard patterns.</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="sd">        `pattern1: Path`: A Pathlib Path type, which can contain wildcards to</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">        be expanded with the glob library.</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a><span class="sd">        `pattern2: Path`: A Pathlib Path type, which can contain wildcards to</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">        be expanded with the glob library.</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">        `pattern3: Path`: A Pathlib Path type, which can contain wildcards to</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="sd">        be expanded with the glob library.</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">    Returns:</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">        `Result[List[List[Path]], str]`: A Result type containing eaither a list of</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">        lists or an error message string.</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>    <span class="c1"># make a list of the iVar files to query based on the provided wildcard path</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>    <span class="n">ivar_list_result</span> <span class="o">=</span> <span class="n">construct_file_list</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="n">pattern1</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ivar_list_result</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>            <span class="sa">f</span><span class="s2">&quot;No files found at the provided wildcard path:</span><span class="se">\n</span><span class="si">{</span><span class="n">ivar_list_result</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>        <span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>    <span class="c1"># Make a list of FASTA files to pull information from</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>    <span class="n">fasta_list_result</span> <span class="o">=</span> <span class="n">construct_file_list</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="n">pattern2</span><span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fasta_list_result</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>            <span class="sa">f</span><span class="s2">&quot;No FASTAs found at the provided wildcard path:</span><span class="se">\n</span><span class="si">{</span><span class="n">fasta_list_result</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="p">)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>    <span class="c1"># Make a list of &quot;tidy&quot; vcf files to pull codon information from</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>    <span class="n">tvcf_result</span> <span class="o">=</span> <span class="n">construct_file_list</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="n">pattern3</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tvcf_result</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>            <span class="sa">f</span><span class="s2">&quot;No &#39;tidy&#39; VCF tables found at the provided wildcard path:</span><span class="se">\n</span><span class="si">{</span><span class="n">tvcf_result</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>        <span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>    <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>        <span class="p">(</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>            <span class="n">ivar_list_result</span><span class="o">.</span><span class="n">unwrap_or</span><span class="p">([]),</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>            <span class="n">fasta_list_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(),</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>            <span class="n">tvcf_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(),</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>        <span class="p">)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>    <span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="k">def</span> <span class="nf">_try_parse_int</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a><span class="sd">    Helper function that handles the possibility that a read support</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a><span class="sd">    cannot be parsed as an integer from the FASTA defline and returns</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a><span class="sd">    `None` instead of raising an unrecoverable error.</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a><span class="k">def</span> <span class="nf">_try_parse_identifier</span><span class="p">(</span><span class="n">defline</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a><span class="sd">    Helper function that splits a contig&#39;s FASTA defline by the &quot;_&quot; symbol,</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a><span class="sd">    pulls a sample id assuming it is the second item in the underscore-split</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a><span class="sd">    defline, parses out the contig name assuming that string starts with</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">    &quot;contig&quot;, and constructs an amplicon name-sample id-contig identifier</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a><span class="sd">    that will serve as a unique key for each contig across all samples</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a><span class="sd">    and amplicons.</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>    <span class="n">cleaned_defline</span> <span class="o">=</span> <span class="n">defline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>    <span class="n">items</span> <span class="o">=</span> <span class="n">cleaned_defline</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>    <span class="n">sample_id</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>    <span class="p">(</span><span class="n">haplotype</span><span class="p">,)</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="s2">&quot;haplotype&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">]</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>    <span class="n">amplicon</span> <span class="o">=</span> <span class="n">cleaned_defline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">haplotype</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>    <span class="n">amplicon</span> <span class="o">=</span> <span class="n">amplicon</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">amplicon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span> <span class="k">else</span> <span class="n">amplicon</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>    <span class="n">amplicon</span> <span class="o">=</span> <span class="n">amplicon</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">amplicon</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span> <span class="k">else</span> <span class="n">amplicon</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>    <span class="n">identifier</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">amplicon</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">haplotype</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>    <span class="k">return</span> <span class="n">identifier</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="k">def</span> <span class="nf">_is_valid_utf8</span><span class="p">(</span><span class="n">fasta_line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a><span class="sd">    Helper function that double checks that each FASTA defline is valid</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a><span class="sd">    UTF-8 text.</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>        <span class="n">fasta_line</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a><span class="k">def</span> <span class="nf">generate_seq_dict</span><span class="p">(</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>    <span class="n">input_fasta</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParams</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a><span class="sd">        The function `generate_seq_dict()` uses a series of list comprehensions</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a><span class="sd">        to 1) Test that a FASTA file can be decoded into proper UTF-8 text; 2)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="sd">        Parse out the name of the current amplicon; And 3) Parse out a FASTA&#39;s</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">        defline and extract a sample ID and a depth of coverage. It then saves</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a><span class="sd">        these pieces of information into a dictionary, where each key is a</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a><span class="sd">        contig&#39;s unique identifier, and each value is the integer depth-of-</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a><span class="sd">        coverage.</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a><span class="sd">    Args:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a><span class="sd">        `input_fasta: List[str]`: Parsed FASTA lines store as strings in a list.</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="sd">        `split_char: str`: The character, e.g. &quot;-&quot;, to use for splitting the</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="sd">        FASTA defline to parse out information.</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">    Returns:</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a><span class="sd">        `Optional[Dict[Optional[str], Optional[int]]]`: An option type, with</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">        option types being a union of type T or None, that wraps the contig</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="sd">        identifier-depth dictionary. Each item in the dictionary can also be</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a><span class="sd">        None.</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>    <span class="c1"># make sure the lines can be decoded</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>    <span class="n">decodable</span> <span class="o">=</span> <span class="p">[</span><span class="n">_is_valid_utf8</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">input_fasta</span><span class="p">]</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>    <span class="k">if</span> <span class="kc">False</span> <span class="ow">in</span> <span class="n">decodable</span><span class="p">:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>    <span class="n">deflines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">input_fasta</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)]</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>    <span class="n">supports</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>        <span class="n">_try_parse_int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">fasta_split_char</span><span class="p">)[</span><span class="n">config</span><span class="o">.</span><span class="n">fasta_split_index</span><span class="p">])</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">input_fasta</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>    <span class="p">]</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>    <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="n">_try_parse_identifier</span><span class="p">(</span><span class="n">defline</span><span class="p">)</span> <span class="k">for</span> <span class="n">defline</span> <span class="ow">in</span> <span class="n">deflines</span><span class="p">]</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">deflines</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>        <span class="n">identifiers</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>    <span class="p">),</span> <span class="s2">&quot;Mismatch between the number of deflines and number of sequences&quot;</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>    <span class="n">seq_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">identifiers</span><span class="p">,</span> <span class="n">supports</span><span class="p">))</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>    <span class="k">return</span> <span class="n">seq_dict</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="k">def</span> <span class="nf">compile_mutation_codons</span><span class="p">(</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>    <span class="n">tvcf_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">whether_resume</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="sd">        Function `compile_mutation_codons()` loops through all &quot;tidy&quot; VCF files</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">        in a provided list of Paths and creates a Polars LazyFrame containing</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">        1) A column of nucleotide mutation strings, and 2) a column of codon</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">        numbers for use with amino acid substitutions.</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">    Args:</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">        `tvcf_list: List[Path]`: A list containing Pathlib Path types pointing to</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a><span class="sd">        any number of tidy VCF files to be assessed.</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">    Returns:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame query that will be evaluated downstream.</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Compiling codon numbers for all coding mutations.&quot;</span><span class="p">)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">whether_resume</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">whether_resume</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>        <span class="n">amassed_codons</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>            <span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>        <span class="k">return</span> <span class="n">amassed_codons</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>    <span class="n">header_written</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tvcf_list</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp_file</span><span class="p">:</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="k">for</span> <span class="n">tidy_vcf</span> <span class="ow">in</span> <span class="n">tvcf_list</span><span class="p">:</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>            <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="n">variants</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">tidy_vcf</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>            <span class="c1"># do a few checks to make sure the loop doesn&#39;t hang on unexpected</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>            <span class="c1"># file writes</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="k">if</span> <span class="n">variants</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>                <span class="k">continue</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">variants</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">({</span><span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;alt&quot;</span><span class="p">}))</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>                <span class="k">continue</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="k">if</span> <span class="s2">&quot;info_ANN&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variants</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;NUC_SUB&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variants</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>                <span class="k">continue</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="n">variants</span> <span class="o">=</span> <span class="n">variants</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>                    <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ref&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;alt&quot;</span><span class="p">)],</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">,</span> <span class="s2">&quot;info_ANN&quot;</span><span class="p">])</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>            <span class="c1"># separate out nucleotide substitutions and annotations</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>            <span class="n">nuc_subs</span> <span class="o">=</span> <span class="n">variants</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>            <span class="n">anns</span> <span class="o">=</span> <span class="n">variants</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;info_ANN&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>            <span class="c1"># Separate out the tenth annotation, which is the amino acid substitution</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="n">aa_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">ann</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="mi">10</span><span class="p">]</span> <span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">anns</span><span class="p">]</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="c1"># Separate out the codon numbers and make sure they are a numeric type</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>            <span class="n">codons</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">codon</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()))</span> <span class="k">for</span> <span class="n">codon</span> <span class="ow">in</span> <span class="n">aa_vars</span><span class="p">]</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>            <span class="n">num_codons</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">codon</span><span class="p">)</span> <span class="k">if</span> <span class="n">codon</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">codon</span> <span class="ow">in</span> <span class="n">codons</span><span class="p">]</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>            <span class="c1"># decide whether to write header or just append rows</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>            <span class="k">if</span> <span class="n">header_written</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>                <span class="n">write_header</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>                <span class="n">header_written</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>                <span class="n">write_header</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>            <span class="c1"># write out</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">:</span> <span class="n">nuc_subs</span><span class="p">,</span> <span class="s2">&quot;CODON&quot;</span><span class="p">:</span> <span class="n">num_codons</span><span class="p">})</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">write_csv</span><span class="p">(</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>                <span class="n">tmp_file</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">include_header</span><span class="o">=</span><span class="n">write_header</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>            <span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;All codons compiled in temporary file.&quot;</span><span class="p">)</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>    <span class="c1"># When the full dataset is ammassed read and &quot;lazify&quot; it</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>    <span class="n">amassed_codons</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">)</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>    <span class="k">return</span> <span class="n">amassed_codons</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="k">def</span> <span class="nf">compile_contig_depths</span><span class="p">(</span><span class="n">fasta_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParams</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">        Function `compile_contig_depths()` loops through all FASTA files</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="sd">        in a provided list of FASTA Paths and creates a Polars LazyFrame containing</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="sd">        1) A column of unique identifiers for each contig, and 2) a column of read</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="sd">        supports/depths of coverage for each contig.</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a><span class="sd">    Args:</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a><span class="sd">        `fasta_list: List[Path]`: A list containing Pathlib Path types pointing to</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a><span class="sd">        any number of FASTA files to be assessed.</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a><span class="sd">    Returns:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame query that will be evaluated downstream.</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Compiling contig depths for each contig FASTA.&quot;</span><span class="p">)</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>    <span class="n">seq_dicts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fasta_list</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>    <span class="k">for</span> <span class="n">fasta</span> <span class="ow">in</span> <span class="n">fasta_list</span><span class="p">:</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>        <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fasta_contents</span><span class="p">:</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>                <span class="n">fasta_lines</span> <span class="o">=</span> <span class="n">fasta_contents</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>                    <span class="sa">f</span><span class="s2">&quot;The FASTA at the following path could not be decoded to utf-8:</span><span class="se">\n</span><span class="si">{</span><span class="n">fasta</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>                <span class="p">)</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>                <span class="k">continue</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>            <span class="n">seq_dict</span> <span class="o">=</span> <span class="n">generate_seq_dict</span><span class="p">(</span><span class="n">fasta_lines</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>            <span class="k">if</span> <span class="n">seq_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>                    <span class="sa">f</span><span class="s2">&quot;The FASTA at the following path could not be decoded to utf-8:</span><span class="se">\n</span><span class="si">{</span><span class="n">fasta</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>                <span class="p">)</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>                <span class="k">continue</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>            <span class="n">seq_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_dict</span><span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>    <span class="n">identifiers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>        <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">seq_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">seq_dict</span> <span class="ow">in</span> <span class="n">seq_dicts</span><span class="p">)</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>    <span class="p">)</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>    <span class="n">supports</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>        <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">seq_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">seq_dict</span> <span class="ow">in</span> <span class="n">seq_dicts</span><span class="p">)</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>    <span class="p">)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>    <span class="n">depth_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">(</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>        <span class="p">{</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">:</span> <span class="n">identifiers</span><span class="p">,</span> <span class="s2">&quot;Depth of Coverage&quot;</span><span class="p">:</span> <span class="n">supports</span><span class="p">}</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>    <span class="p">)</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>    <span class="k">return</span> <span class="n">depth_df</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a><span class="k">def</span> <span class="nf">generate_gene_df</span><span class="p">(</span><span class="n">gene_bed</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a><span class="sd">        Function `generate_gene_df()` uses series of joins on a BED file of amplicons</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a><span class="sd">        and genes to extract an &quot;amplicon basename&quot; alongside the start/stop positions</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a><span class="sd">        and genes associated with each amplicon.</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a><span class="sd">    Args:</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a><span class="sd">        `gene_bed: Path`: A Pathlib Path type pointing to the location of a BED file</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a><span class="sd">        with of all primers, which must contain start and stop positions for each primer,</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a><span class="sd">        amplicon names, and genes</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a><span class="sd">    Returns:</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame query that will be evaluated downstream.</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Generating gene dataframe.&quot;</span><span class="p">)</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>    <span class="n">gene_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>        <span class="n">pl</span><span class="o">.</span><span class="n">scan_csv</span><span class="p">(</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>            <span class="n">gene_bed</span><span class="p">,</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>            <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>            <span class="n">has_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>            <span class="n">new_columns</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                <span class="s2">&quot;Ref&quot;</span><span class="p">,</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                <span class="s2">&quot;Start Position&quot;</span><span class="p">,</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                <span class="s2">&quot;Stop Position&quot;</span><span class="p">,</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>                <span class="s2">&quot;NAME&quot;</span><span class="p">,</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>                <span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">,</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>                <span class="s2">&quot;INDEX&quot;</span><span class="p">,</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>                <span class="s2">&quot;Gene&quot;</span><span class="p">,</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>            <span class="p">],</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>        <span class="p">)</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_RIGHT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_LEFT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>        <span class="p">)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>        <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>            <span class="p">(</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">scan_csv</span><span class="p">(</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>                    <span class="n">gene_bed</span><span class="p">,</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>                    <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>                    <span class="n">has_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>                    <span class="n">new_columns</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>                        <span class="s2">&quot;Ref&quot;</span><span class="p">,</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>                        <span class="s2">&quot;Start Position&quot;</span><span class="p">,</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>                        <span class="s2">&quot;Stop Position&quot;</span><span class="p">,</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>                        <span class="s2">&quot;NAME&quot;</span><span class="p">,</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>                        <span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">,</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>                        <span class="s2">&quot;INDEX&quot;</span><span class="p">,</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>                        <span class="s2">&quot;Gene&quot;</span><span class="p">,</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>                    <span class="p">],</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>                <span class="p">)</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Ref&quot;</span><span class="p">,</span> <span class="s2">&quot;INDEX&quot;</span><span class="p">)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;_LEFT&quot;</span><span class="p">))</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Stop Position&quot;</span><span class="p">)</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_RIGHT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_LEFT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>                    <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">)</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>                <span class="p">)</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">)</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>                <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>            <span class="p">),</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">,</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>        <span class="p">)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>            <span class="p">(</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">scan_csv</span><span class="p">(</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>                    <span class="n">gene_bed</span><span class="p">,</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>                    <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>                    <span class="n">has_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>                    <span class="n">new_columns</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>                        <span class="s2">&quot;Ref&quot;</span><span class="p">,</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>                        <span class="s2">&quot;Start Position&quot;</span><span class="p">,</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>                        <span class="s2">&quot;Stop Position&quot;</span><span class="p">,</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>                        <span class="s2">&quot;NAME&quot;</span><span class="p">,</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>                        <span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">,</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>                        <span class="s2">&quot;INDEX&quot;</span><span class="p">,</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>                        <span class="s2">&quot;Gene&quot;</span><span class="p">,</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>                    <span class="p">],</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>                <span class="p">)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Ref&quot;</span><span class="p">,</span> <span class="s2">&quot;INDEX&quot;</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;_RIGHT&quot;</span><span class="p">))</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Start Position&quot;</span><span class="p">)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_RIGHT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_LEFT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>                    <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>                <span class="p">)</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>                <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>            <span class="p">),</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">,</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>        <span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>        <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;Start Position&quot;</span><span class="p">,</span> <span class="s2">&quot;Stop Position&quot;</span><span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>    <span class="p">)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>    <span class="k">return</span> <span class="n">gene_df</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="k">def</span> <span class="nf">construct_long_df</span><span class="p">(</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>    <span class="n">all_contigs</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">gene_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">codon_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a><span class="sd">        Function `construct_long_df()` constructs a &quot;long&quot; dataframe (or more specifically,</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a><span class="sd">        a Polars LazyFrame query that, when evaluated downstream, will produce a dataframe)</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a><span class="sd">        that lists each mutation in each contig alongside whether it is noncoding, synonymous,</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a><span class="sd">        and nonsynonymous.</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a><span class="sd">    Args:</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a><span class="sd">        `all_contigs: pl.LazyFrame`: A Polars lazyframe that, when queried, will produce</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a><span class="sd">        a dataframe out of all iVar tables merged together.</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">        `gene_df: pl.LazyFrame`: A Polars lazyframe that, when queried, will produce a</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a><span class="sd">        dataframe where each row represents an amplicon, its start and stop positions, and</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a><span class="sd">        which gene it is in.</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a><span class="sd">        `codon_df: pl.LazyFrame`: A Polars lazyframe that, when queried, will be a table of</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">        nucleotide mutations and associated codons within the protein versions of the gene</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="sd">    Returns:</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame query that will be evaluated downstream.</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Using a series of joins to construct a long dataframe of all mutations.&quot;</span><span class="p">)</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>    <span class="n">long_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>        <span class="n">all_contigs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>            <span class="p">[</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>                <span class="s2">&quot;REGION&quot;</span><span class="p">,</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>                <span class="s2">&quot;POS&quot;</span><span class="p">,</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>                <span class="s2">&quot;REF&quot;</span><span class="p">,</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>                <span class="s2">&quot;ALT&quot;</span><span class="p">,</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>                <span class="s2">&quot;REF_AA&quot;</span><span class="p">,</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                <span class="s2">&quot;ALT_AA&quot;</span><span class="p">,</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>                <span class="s2">&quot;Amplicon&quot;</span><span class="p">,</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>                <span class="s2">&quot;Sample ID&quot;</span><span class="p">,</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>                <span class="s2">&quot;Contig&quot;</span><span class="p">,</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>                <span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>            <span class="p">]</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>        <span class="p">)</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>        <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>            <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>                <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;REF&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;POS&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ALT&quot;</span><span class="p">)],</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>        <span class="p">)</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gene_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">)</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">codon_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>        <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>            <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;CODON&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">())</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>                    <span class="p">[</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>                        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;REF_AA&quot;</span><span class="p">),</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>                        <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">),</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>                        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ALT_AA&quot;</span><span class="p">),</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>                        <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;at nuc. position&quot;</span><span class="p">),</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>                        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;POS&quot;</span><span class="p">),</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>                    <span class="p">],</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>                    <span class="n">separator</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>                <span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>            <span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>            <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>                    <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;REF_AA&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;CODON&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ALT_AA&quot;</span><span class="p">)],</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>                <span class="p">)</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>            <span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>        <span class="p">)</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>        <span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;REF&quot;</span><span class="p">,</span> <span class="s2">&quot;POS&quot;</span><span class="p">,</span> <span class="s2">&quot;ALT&quot;</span><span class="p">])</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>            <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">([</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Gene&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)],</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>                <span class="s2">&quot;AA_SUB&quot;</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>            <span class="p">)</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>        <span class="p">)</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ALT_AA&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;REF_AA&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Noncoding&quot;</span><span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>        <span class="p">)</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>            <span class="p">(</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                <span class="c1"># pylint: disable-next=singleton-comparison</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ALT_AA&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;REF_AA&quot;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Noncoding&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># noqa: E712</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Synonymous&quot;</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>        <span class="p">)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>            <span class="p">(</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>                <span class="c1"># pylint: disable-next=singleton-comparison</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ALT_AA&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;REF_AA&quot;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Noncoding&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># noqa: E712</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Nonsynonymous&quot;</span><span class="p">)</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>        <span class="p">)</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>        <span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;REF_AA&quot;</span><span class="p">,</span> <span class="s2">&quot;ALT_AA&quot;</span><span class="p">,</span> <span class="s2">&quot;CODON&quot;</span><span class="p">])</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>    <span class="p">)</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>    <span class="n">long_df</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">write_ipc</span><span class="p">(</span><span class="s2">&quot;haplotype_long_table.arrow&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;zstd&quot;</span><span class="p">)</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>    <span class="k">return</span> <span class="n">long_df</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="k">def</span> <span class="nf">construct_short_df</span><span class="p">(</span><span class="n">long_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">gene_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="sd">        Function `construct_short_df()` essentially &quot;pivots&quot; the polars lazyframe produced</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">        in `construct_long_df()` such that mutations are stored in comma-delimited list and</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a><span class="sd">        counts of nucleotide, synonymous, and non-synonymous mutations are added.</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a><span class="sd">    Args:</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a><span class="sd">        `long_df: pl.LazyFrame`: A Polars lazyframe that, when queried, will produce</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a><span class="sd">        a long dataframe of all individual mutations in all contigs.</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="sd">        `gene_df: pl.LazyFrame`: A Polars lazyframe that, when queried, will produce a</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">        dataframe where each row represents an amplicon, its start and stop positions, and</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">        which gene it is in.</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">    Returns:</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame query that will be evaluated downstream.</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Constructing a pivoted dataframe of all unique contigs from each amplicon.&quot;</span><span class="p">)</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>    <span class="n">short_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="n">long_df</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">])</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>                <span class="p">[</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">,</span> <span class="s2">&quot;Sample ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">]</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>                    <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Sample ID&quot;</span><span class="p">)],</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample&quot;</span><span class="p">)</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>            <span class="p">),</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>        <span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>        <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gene_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="s2">&quot;NUC_SUB&quot;</span><span class="p">])</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">))</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Nucleotide Substitutions&quot;</span><span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>            <span class="p">)</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">),</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>        <span class="p">)</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="s2">&quot;NUC_SUB&quot;</span><span class="p">])</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Nuc Mut Count&quot;</span><span class="p">))</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">),</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>        <span class="p">)</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="s2">&quot;AA_SUB&quot;</span><span class="p">,</span> <span class="s2">&quot;Synonymous&quot;</span><span class="p">])</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Synonymous&quot;</span><span class="p">))</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">))</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Synonymous Mutations&quot;</span><span class="p">)</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>            <span class="p">)</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">),</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>        <span class="p">)</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="s2">&quot;AA_SUB&quot;</span><span class="p">,</span> <span class="s2">&quot;Synonymous&quot;</span><span class="p">])</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Synonymous&quot;</span><span class="p">))</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Syn count&quot;</span><span class="p">))</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">),</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>        <span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="s2">&quot;AA_SUB&quot;</span><span class="p">,</span> <span class="s2">&quot;Nonsynonymous&quot;</span><span class="p">])</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Nonsynonymous&quot;</span><span class="p">))</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">))</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Nonsynonymous Mutations&quot;</span><span class="p">)</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>            <span class="p">)</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">),</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="p">)</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="s2">&quot;AA_SUB&quot;</span><span class="p">,</span> <span class="s2">&quot;Nonsynonymous&quot;</span><span class="p">])</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Nonsynonymous&quot;</span><span class="p">))</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Nonsyn count&quot;</span><span class="p">))</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">),</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        <span class="p">)</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample&quot;</span><span class="p">)</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>        <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>    <span class="p">)</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>    <span class="k">return</span> <span class="n">short_df</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="k">def</span> <span class="nf">compute_crude_dnds_ratio</span><span class="p">(</span><span class="n">short_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a><span class="sd">        Function `compute_crude_dnds_ratio()` constructs a very crude approximation of</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a><span class="sd">        πN/πS, the ratio of nonsynonymous to synonymous mutations and joins it onto</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a><span class="sd">        the &quot;short&quot; lazyframe from `construct_short_df()`.</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a><span class="sd">    Args:</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a><span class="sd">        `short_df: pl.LazyFrame`: A Polars lazyframe that, when queried, will produce</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a><span class="sd">        a short dataframe of all contigs, where mutations are comma-separated in a single</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="sd">        column.</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a><span class="sd">    Returns:</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame query that will be evaluated downstream.</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Computing a crude dN/dS ratio for each contig in each sample.&quot;</span><span class="p">)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>    <span class="n">new_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="n">short_df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Stop Position&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Start Position&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>                <span class="s2">&quot;Amplicon Length&quot;</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>            <span class="p">)</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>        <span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>            <span class="p">(</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Nonsyn count&quot;</span><span class="p">)</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>                <span class="o">/</span> <span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Amplicon Length&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Syn count&quot;</span><span class="p">))</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pn&quot;</span><span class="p">)</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>        <span class="p">)</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>            <span class="p">(</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Syn count&quot;</span><span class="p">)</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>                <span class="o">/</span> <span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Amplicon Length&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Nonsyn count&quot;</span><span class="p">))</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ps&quot;</span><span class="p">)</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="p">)</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="o">-</span><span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;pn&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">log</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;dn&quot;</span><span class="p">))</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="o">-</span><span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ps&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">log</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ds&quot;</span><span class="p">))</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dn&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ds&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Crude dN/dS Ratio&quot;</span><span class="p">))</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;pn&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">,</span> <span class="s2">&quot;dn&quot;</span><span class="p">,</span> <span class="s2">&quot;ds&quot;</span><span class="p">)</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>        <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>    <span class="p">)</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>    <span class="k">return</span> <span class="n">new_df</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a><span class="k">def</span> <span class="nf">assign_haplotype_names</span><span class="p">(</span><span class="n">unnamed_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="sd">        Function `assign_haplotype_names()` sorts haplotypes/contigs within each sample</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a><span class="sd">        in descending order by how well-supported by reads they are. It then gives those</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="sd">        sorted haplotypes a name based on their frequences.</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a><span class="sd">    Args:</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a><span class="sd">        `unnamed_df: pl.LazyFrame`: A Polars lazyframe that, when queried, will produce</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a><span class="sd">        a short dataframe of all contigs, where mutations are comma-separated in a single</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a><span class="sd">        column, along with crude N/S ratios.</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">    Returns:</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a><span class="sd">        `pl.DataFrame`: A collected Polars DataFrame with complete information for</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a><span class="sd">        reporting.</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Assigning names to each putative haplotype based on their frequencies.&quot;</span><span class="p">)</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>    <span class="n">sample_amp_dfs</span> <span class="o">=</span> <span class="n">unnamed_df</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">partition_by</span><span class="p">(</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="s2">&quot;Amplicon&quot;</span><span class="p">,</span> <span class="s2">&quot;Sample ID&quot;</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>    <span class="p">)</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Naming each haplotype.&quot;</span><span class="p">)</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_amp_dfs</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_amp_dfs</span><span class="p">):</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="n">new_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Haplotype&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="n">new_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;Depth of Coverage&quot;</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>            <span class="o">.</span><span class="n">with_row_count</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>            <span class="o">.</span><span class="n">cast</span><span class="p">({</span><span class="s2">&quot;row_nr&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">})</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>                    <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Haplotype&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;row_nr&quot;</span><span class="p">)],</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>                    <span class="n">separator</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Haplotype&quot;</span><span class="p">)</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>            <span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;row_nr&quot;</span><span class="p">)</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">new_cols</span><span class="p">)</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="p">)</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>        <span class="n">sample_amp_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_df</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sample_amp_dfs</span><span class="p">,</span> <span class="n">rechunk</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>    <span class="k">return</span> <span class="n">final_df</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="k">def</span> <span class="nf">aggregate_haplotype_df</span><span class="p">(</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>    <span class="n">long_contigs</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>    <span class="n">tvcf_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>    <span class="n">clean_fasta_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>    <span class="n">gene_bed</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>    <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParams</span><span class="p">,</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>    <span class="n">whether_resume</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">        Function `aggregate_haplotype_df()` oversees the construction of a final</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">        dataframe, which will be reported out as an intricately sorted Excel file.</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">    Args:</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">        `long_contigs: pl.LazyFrame`: A Polars LazyFrame query that was amassed</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="sd">        from many iVar tables.</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="sd">        `clean_fasta_list: List[Path]`: A list of Pathlib Paths pointing toward</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">        any number of FASTA files.</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a><span class="sd">        `gene_bed: Path`: A Pathlib Path type pointing to the location of a BED file</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">        with of all primers, which must contain start and stop positions for each primer,</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">        amplicon names, and genes</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">    Returns:</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="sd">        `pl.DataFrame`: A fully evaluated Polars dataframe that can be written</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="sd">        out as an excel file.</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>    <span class="n">ic</span><span class="p">(</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>        <span class="s2">&quot;Running function that manages the many steps of aggregating the haplotype table.&quot;</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>    <span class="p">)</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>    <span class="c1"># construct data frame mapping genes to amplicons</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>    <span class="n">gene_df</span> <span class="o">=</span> <span class="n">generate_gene_df</span><span class="p">(</span><span class="n">gene_bed</span><span class="p">)</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>    <span class="c1"># construct a codon table for all mutations</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>    <span class="n">codon_df</span> <span class="o">=</span> <span class="n">compile_mutation_codons</span><span class="p">(</span><span class="n">tvcf_list</span><span class="p">,</span> <span class="n">whether_resume</span><span class="p">)</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>    <span class="c1"># construct long dataframe</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>    <span class="n">long_df</span> <span class="o">=</span> <span class="n">construct_long_df</span><span class="p">(</span><span class="n">long_contigs</span><span class="p">,</span> <span class="n">gene_df</span><span class="p">,</span> <span class="n">codon_df</span><span class="p">)</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>    <span class="c1"># aggregate into short dataframe</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>    <span class="n">short_df</span> <span class="o">=</span> <span class="n">construct_short_df</span><span class="p">(</span><span class="n">long_df</span><span class="p">,</span> <span class="n">gene_df</span><span class="p">)</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>    <span class="c1"># Compile depths from contig FASTA files</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>    <span class="n">depth_df</span> <span class="o">=</span> <span class="n">compile_contig_depths</span><span class="p">(</span><span class="n">clean_fasta_list</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>    <span class="c1"># add FASTA information about depth of coverage per-contig consensus</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>    <span class="c1"># onto the lazyframe with a join</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Joining per-contig depth information.&quot;</span><span class="p">)</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>    <span class="n">short_df_with_depth</span> <span class="o">=</span> <span class="n">short_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="n">depth_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Depth of Coverage&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">())</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>    <span class="c1"># generate crude dn/ds ratios</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>    <span class="n">ratio_df</span> <span class="o">=</span> <span class="n">compute_crude_dnds_ratio</span><span class="p">(</span><span class="n">short_df_with_depth</span><span class="p">)</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>    <span class="c1"># Dynamically assign haplotype names per amplicon-sample combination</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>    <span class="n">final_df</span> <span class="o">=</span> <span class="n">assign_haplotype_names</span><span class="p">(</span><span class="n">ratio_df</span><span class="p">)</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>    <span class="k">return</span> <span class="n">final_df</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>        <span class="s2">&quot;Sample ID&quot;</span><span class="p">,</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>        <span class="s2">&quot;Start Position&quot;</span><span class="p">,</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>        <span class="s2">&quot;Depth of Coverage&quot;</span><span class="p">,</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>        <span class="s2">&quot;Nonsyn count&quot;</span><span class="p">,</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>        <span class="n">descending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a><span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a><span class="sd">    Main coordinates the flow of data through the functions defined in `read_zap_report.py`.</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a><span class="sd">    It also handles errors and error messages so that the script can be debugged without</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="sd">    long tracebacks.</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>    <span class="c1"># parse command line arguments while handling any errors</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>    <span class="n">args_result</span> <span class="o">=</span> <span class="n">parse_command_line_args</span><span class="p">()</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args_result</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>            <span class="sa">f</span><span class="s2">&quot;Command line argument parsing encountered an error.</span><span class="se">\n</span><span class="si">{</span><span class="n">args_result</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="p">)</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>    <span class="n">results_dir</span> <span class="o">=</span> <span class="n">args_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">results_dir</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">args_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">config</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>    <span class="n">gene_bed</span> <span class="o">=</span> <span class="n">args_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">gene_bed</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>    <span class="n">whether_resume</span> <span class="o">=</span> <span class="n">args_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">resume</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>    <span class="c1"># parse configurations from the config YAML file</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>    <span class="n">config_result</span> <span class="o">=</span> <span class="n">parse_configurations</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_result</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>            <span class="sa">f</span><span class="s2">&quot;Config file parsing parsing encountered an error.</span><span class="se">\n</span><span class="si">{</span><span class="n">config_result</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>        <span class="p">)</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>    <span class="c1"># collect all necessary file lists</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>    <span class="n">collect_results</span> <span class="o">=</span> <span class="n">collect_file_lists</span><span class="p">(</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>        <span class="n">results_dir</span><span class="p">,</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>        <span class="n">config_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">ivar_pattern</span><span class="p">,</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>        <span class="n">config_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">fasta_pattern</span><span class="p">,</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>        <span class="n">config_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">tidyvcf_pattern</span><span class="p">,</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>    <span class="p">)</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collect_results</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>            <span class="sa">f</span><span class="s2">&quot;Glob-based file listing encountered an error.</span><span class="se">\n</span><span class="si">{</span><span class="n">collect_results</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        <span class="p">)</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>    <span class="c1"># pylint: disable-next=assignment-from-no-return</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>    <span class="n">clean_ivar_list</span><span class="p">,</span> <span class="n">clean_fasta_list</span><span class="p">,</span> <span class="n">clean_tvcf_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>    <span class="c1"># compile all files into one Polars LazyFrame to be queried downstream</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>    <span class="n">all_contigs_result</span> <span class="o">=</span> <span class="n">compile_data_with_io</span><span class="p">(</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>        <span class="n">clean_ivar_list</span><span class="p">,</span> <span class="n">config_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(),</span> <span class="n">whether_resume</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>    <span class="p">)</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_contigs_result</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>            <span class="sa">f</span><span class="s2">&quot;A dataframe could not be compiled.</span><span class="se">\n</span><span class="si">{</span><span class="n">all_contigs_result</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>        <span class="p">)</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>    <span class="c1"># aggregate a dataframe containing information to be reported out for review</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>    <span class="n">final_df</span> <span class="o">=</span> <span class="n">aggregate_haplotype_df</span><span class="p">(</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="n">all_contigs_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(),</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>        <span class="n">clean_tvcf_list</span><span class="p">,</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="n">clean_fasta_list</span><span class="p">,</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>        <span class="n">gene_bed</span><span class="p">,</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>        <span class="n">config_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(),</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="n">whether_resume</span><span class="p">,</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>    <span class="p">)</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>    <span class="c1"># Sort the lazyframe first by contig frequency and then by position/amplicon</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>    <span class="n">final_df</span><span class="o">.</span><span class="n">write_excel</span><span class="p">(</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>        <span class="s2">&quot;final_report.xlsx&quot;</span><span class="p">,</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="n">autofit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>        <span class="n">freeze_panes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>        <span class="n">header_format</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;bold&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>        <span class="n">conditional_formats</span><span class="o">=</span><span class="p">{</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>            <span class="s2">&quot;Crude dN/dS Ratio&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;3_color_scale&quot;</span><span class="p">,</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>                <span class="s2">&quot;mid_value&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>                <span class="s2">&quot;min_value&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>                <span class="s2">&quot;mid_color&quot;</span><span class="p">:</span> <span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>            <span class="p">}</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>        <span class="p">},</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>    <span class="p">)</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>    <span class="c1"># clear temporary arrow structure</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">):</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">)</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>    <span class="n">main</span><span class="p">()</span>
</span></pre></div>


            </section>
                <section id="ConfigParams">
                            <input id="ConfigParams-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator">@dataclass(frozen=True, kw_only=True)</div>

    <span class="def">class</span>
    <span class="name">ConfigParams</span>:

                <label class="view-source-button" for="ConfigParams-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConfigParams"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConfigParams-43"><a href="#ConfigParams-43"><span class="linenos">43</span></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ConfigParams-44"><a href="#ConfigParams-44"><span class="linenos">44</span></a><span class="k">class</span> <span class="nc">ConfigParams</span><span class="p">:</span>
</span><span id="ConfigParams-45"><a href="#ConfigParams-45"><span class="linenos">45</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ConfigParams-46"><a href="#ConfigParams-46"><span class="linenos">46</span></a><span class="sd">    The available config parameters provided in YAML format to this module are</span>
</span><span id="ConfigParams-47"><a href="#ConfigParams-47"><span class="linenos">47</span></a><span class="sd">    converted into this dataclass for easier access downstream and more strict</span>
</span><span id="ConfigParams-48"><a href="#ConfigParams-48"><span class="linenos">48</span></a><span class="sd">    typing of each field.</span>
</span><span id="ConfigParams-49"><a href="#ConfigParams-49"><span class="linenos">49</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ConfigParams-50"><a href="#ConfigParams-50"><span class="linenos">50</span></a>
</span><span id="ConfigParams-51"><a href="#ConfigParams-51"><span class="linenos">51</span></a>    <span class="n">ivar_pattern</span><span class="p">:</span> <span class="n">Path</span>
</span><span id="ConfigParams-52"><a href="#ConfigParams-52"><span class="linenos">52</span></a>    <span class="n">fasta_pattern</span><span class="p">:</span> <span class="n">Path</span>
</span><span id="ConfigParams-53"><a href="#ConfigParams-53"><span class="linenos">53</span></a>    <span class="n">tidyvcf_pattern</span><span class="p">:</span> <span class="n">Path</span>
</span><span id="ConfigParams-54"><a href="#ConfigParams-54"><span class="linenos">54</span></a>    <span class="n">fasta_split_char</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="ConfigParams-55"><a href="#ConfigParams-55"><span class="linenos">55</span></a>    <span class="n">fasta_split_index</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="ConfigParams-56"><a href="#ConfigParams-56"><span class="linenos">56</span></a>    <span class="n">ivar_split_char</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="ConfigParams-57"><a href="#ConfigParams-57"><span class="linenos">57</span></a>    <span class="n">id_split_index</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="ConfigParams-58"><a href="#ConfigParams-58"><span class="linenos">58</span></a>    <span class="n">hap_split_index</span><span class="p">:</span> <span class="nb">int</span>
</span></pre></div>


            <div class="docstring"><p>The available config parameters provided in YAML format to this module are
converted into this dataclass for easier access downstream and more strict
typing of each field.</p>
</div>


                            <div id="ConfigParams.__init__" class="classattr">
                                        <input id="ConfigParams.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="name">ConfigParams</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span></span>)</span>

                <label class="view-source-button" for="ConfigParams.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConfigParams.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConfigParams.__init__-132"><a href="#ConfigParams.__init__-132"><span class="linenos">132</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">__dataclass_self__</span><span class="p">:</span> <span class="n">PydanticDataclass</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ConfigParams.__init__-133"><a href="#ConfigParams.__init__-133"><span class="linenos">133</span></a>        <span class="n">__tracebackhide__</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ConfigParams.__init__-134"><a href="#ConfigParams.__init__-134"><span class="linenos">134</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">__dataclass_self__</span>
</span><span id="ConfigParams.__init__-135"><a href="#ConfigParams.__init__-135"><span class="linenos">135</span></a>        <span class="n">s</span><span class="o">.</span><span class="n">__pydantic_validator__</span><span class="o">.</span><span class="n">validate_python</span><span class="p">(</span><span class="n">ArgsKwargs</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">),</span> <span class="n">self_instance</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
</span></pre></div>




                            </div>
                            <div id="ConfigParams.ivar_pattern" class="classattr">
                                <div class="attr variable">
            <span class="name">ivar_pattern</span><span class="annotation">: pathlib.Path</span>


    </div>
    <a class="headerlink" href="#ConfigParams.ivar_pattern"></a>



                            </div>
                            <div id="ConfigParams.fasta_pattern" class="classattr">
                                <div class="attr variable">
            <span class="name">fasta_pattern</span><span class="annotation">: pathlib.Path</span>


    </div>
    <a class="headerlink" href="#ConfigParams.fasta_pattern"></a>



                            </div>
                            <div id="ConfigParams.tidyvcf_pattern" class="classattr">
                                <div class="attr variable">
            <span class="name">tidyvcf_pattern</span><span class="annotation">: pathlib.Path</span>


    </div>
    <a class="headerlink" href="#ConfigParams.tidyvcf_pattern"></a>



                            </div>
                            <div id="ConfigParams.fasta_split_char" class="classattr">
                                <div class="attr variable">
            <span class="name">fasta_split_char</span><span class="annotation">: str</span>


    </div>
    <a class="headerlink" href="#ConfigParams.fasta_split_char"></a>



                            </div>
                            <div id="ConfigParams.fasta_split_index" class="classattr">
                                <div class="attr variable">
            <span class="name">fasta_split_index</span><span class="annotation">: int</span>


    </div>
    <a class="headerlink" href="#ConfigParams.fasta_split_index"></a>



                            </div>
                            <div id="ConfigParams.ivar_split_char" class="classattr">
                                <div class="attr variable">
            <span class="name">ivar_split_char</span><span class="annotation">: str</span>


    </div>
    <a class="headerlink" href="#ConfigParams.ivar_split_char"></a>



                            </div>
                            <div id="ConfigParams.id_split_index" class="classattr">
                                <div class="attr variable">
            <span class="name">id_split_index</span><span class="annotation">: int</span>


    </div>
    <a class="headerlink" href="#ConfigParams.id_split_index"></a>



                            </div>
                            <div id="ConfigParams.hap_split_index" class="classattr">
                                <div class="attr variable">
            <span class="name">hap_split_index</span><span class="annotation">: int</span>


    </div>
    <a class="headerlink" href="#ConfigParams.hap_split_index"></a>



                            </div>
                </section>
                <section id="parse_command_line_args">
                            <input id="parse_command_line_args-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">parse_command_line_args</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="n">Union</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">Ok</span><span class="p">[</span><span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">],</span> <span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">Err</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="parse_command_line_args-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#parse_command_line_args"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="parse_command_line_args-61"><a href="#parse_command_line_args-61"><span class="linenos"> 61</span></a><span class="k">def</span> <span class="nf">parse_command_line_args</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="parse_command_line_args-62"><a href="#parse_command_line_args-62"><span class="linenos"> 62</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="parse_command_line_args-63"><a href="#parse_command_line_args-63"><span class="linenos"> 63</span></a><span class="sd">        Parse command line arguments while passing errors onto main.</span>
</span><span id="parse_command_line_args-64"><a href="#parse_command_line_args-64"><span class="linenos"> 64</span></a>
</span><span id="parse_command_line_args-65"><a href="#parse_command_line_args-65"><span class="linenos"> 65</span></a><span class="sd">    Args:</span>
</span><span id="parse_command_line_args-66"><a href="#parse_command_line_args-66"><span class="linenos"> 66</span></a><span class="sd">        `None`</span>
</span><span id="parse_command_line_args-67"><a href="#parse_command_line_args-67"><span class="linenos"> 67</span></a>
</span><span id="parse_command_line_args-68"><a href="#parse_command_line_args-68"><span class="linenos"> 68</span></a><span class="sd">    Returns:</span>
</span><span id="parse_command_line_args-69"><a href="#parse_command_line_args-69"><span class="linenos"> 69</span></a><span class="sd">        `Result[argparse.Namespace, str]`: A Result type containing an `argparse` namespace</span>
</span><span id="parse_command_line_args-70"><a href="#parse_command_line_args-70"><span class="linenos"> 70</span></a><span class="sd">        or an error message string.</span>
</span><span id="parse_command_line_args-71"><a href="#parse_command_line_args-71"><span class="linenos"> 71</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="parse_command_line_args-72"><a href="#parse_command_line_args-72"><span class="linenos"> 72</span></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
</span><span id="parse_command_line_args-73"><a href="#parse_command_line_args-73"><span class="linenos"> 73</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="parse_command_line_args-74"><a href="#parse_command_line_args-74"><span class="linenos"> 74</span></a>        <span class="s2">&quot;--results_dir&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-75"><a href="#parse_command_line_args-75"><span class="linenos"> 75</span></a>        <span class="s2">&quot;-d&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-76"><a href="#parse_command_line_args-76"><span class="linenos"> 76</span></a>        <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span><span id="parse_command_line_args-77"><a href="#parse_command_line_args-77"><span class="linenos"> 77</span></a>        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="parse_command_line_args-78"><a href="#parse_command_line_args-78"><span class="linenos"> 78</span></a>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Results &#39;root&#39; directory to traverse in search if iVar tables and other files&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-79"><a href="#parse_command_line_args-79"><span class="linenos"> 79</span></a>    <span class="p">)</span>
</span><span id="parse_command_line_args-80"><a href="#parse_command_line_args-80"><span class="linenos"> 80</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="parse_command_line_args-81"><a href="#parse_command_line_args-81"><span class="linenos"> 81</span></a>        <span class="s2">&quot;--gene_bed&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-82"><a href="#parse_command_line_args-82"><span class="linenos"> 82</span></a>        <span class="s2">&quot;-b&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-83"><a href="#parse_command_line_args-83"><span class="linenos"> 83</span></a>        <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span><span id="parse_command_line_args-84"><a href="#parse_command_line_args-84"><span class="linenos"> 84</span></a>        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="parse_command_line_args-85"><a href="#parse_command_line_args-85"><span class="linenos"> 85</span></a>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;BED of amplicons where the final column contains genes associated with each amplicon&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-86"><a href="#parse_command_line_args-86"><span class="linenos"> 86</span></a>    <span class="p">)</span>
</span><span id="parse_command_line_args-87"><a href="#parse_command_line_args-87"><span class="linenos"> 87</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="parse_command_line_args-88"><a href="#parse_command_line_args-88"><span class="linenos"> 88</span></a>        <span class="s2">&quot;--config&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-89"><a href="#parse_command_line_args-89"><span class="linenos"> 89</span></a>        <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-90"><a href="#parse_command_line_args-90"><span class="linenos"> 90</span></a>        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="parse_command_line_args-91"><a href="#parse_command_line_args-91"><span class="linenos"> 91</span></a>        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="parse_command_line_args-92"><a href="#parse_command_line_args-92"><span class="linenos"> 92</span></a>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-93"><a href="#parse_command_line_args-93"><span class="linenos"> 93</span></a>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;YAML file used to configure module such that it avoids harcoding&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-94"><a href="#parse_command_line_args-94"><span class="linenos"> 94</span></a>    <span class="p">)</span>
</span><span id="parse_command_line_args-95"><a href="#parse_command_line_args-95"><span class="linenos"> 95</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="parse_command_line_args-96"><a href="#parse_command_line_args-96"><span class="linenos"> 96</span></a>        <span class="s2">&quot;--resume&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-97"><a href="#parse_command_line_args-97"><span class="linenos"> 97</span></a>        <span class="s2">&quot;-r&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-98"><a href="#parse_command_line_args-98"><span class="linenos"> 98</span></a>        <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
</span><span id="parse_command_line_args-99"><a href="#parse_command_line_args-99"><span class="linenos"> 99</span></a>        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="parse_command_line_args-100"><a href="#parse_command_line_args-100"><span class="linenos">100</span></a>        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="parse_command_line_args-101"><a href="#parse_command_line_args-101"><span class="linenos">101</span></a>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to resume if intermediate files from previous runs are detected.&quot;</span><span class="p">,</span>
</span><span id="parse_command_line_args-102"><a href="#parse_command_line_args-102"><span class="linenos">102</span></a>    <span class="p">)</span>
</span><span id="parse_command_line_args-103"><a href="#parse_command_line_args-103"><span class="linenos">103</span></a>    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span><span id="parse_command_line_args-104"><a href="#parse_command_line_args-104"><span class="linenos">104</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="parse_command_line_args-105"><a href="#parse_command_line_args-105"><span class="linenos">105</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span><span class="s2">&quot;Arguments could not properly be parsed.&quot;</span><span class="p">)</span>
</span><span id="parse_command_line_args-106"><a href="#parse_command_line_args-106"><span class="linenos">106</span></a>
</span><span id="parse_command_line_args-107"><a href="#parse_command_line_args-107"><span class="linenos">107</span></a>    <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Parse command line arguments while passing errors onto main.</p>

<p>Args:
    <code>None</code></p>

<p>Returns:
    <code>Result[argparse.Namespace, str]</code>: A Result type containing an <code>argparse</code> namespace
    or an error message string.</p>
</div>


                </section>
                <section id="parse_configurations">
                            <input id="parse_configurations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">parse_configurations</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">config_path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span></span><span class="return-annotation">) -> <span class="n">Union</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">Ok</span><span class="p">[</span><span class="n"><a href="#ConfigParams">ConfigParams</a></span><span class="p">],</span> <span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">Err</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="parse_configurations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#parse_configurations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="parse_configurations-110"><a href="#parse_configurations-110"><span class="linenos">110</span></a><span class="k">def</span> <span class="nf">parse_configurations</span><span class="p">(</span><span class="n">config_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">ConfigParams</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="parse_configurations-111"><a href="#parse_configurations-111"><span class="linenos">111</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="parse_configurations-112"><a href="#parse_configurations-112"><span class="linenos">112</span></a><span class="sd">        This module uses the library `strictYAML` to perform very strict, statically</span>
</span><span id="parse_configurations-113"><a href="#parse_configurations-113"><span class="linenos">113</span></a><span class="sd">        typed configuration. This helps catch errors downstream while also doing away with</span>
</span><span id="parse_configurations-114"><a href="#parse_configurations-114"><span class="linenos">114</span></a><span class="sd">        most hardcoding, which is likely to cause runtime errors for other users. Like</span>
</span><span id="parse_configurations-115"><a href="#parse_configurations-115"><span class="linenos">115</span></a><span class="sd">        the other functions in this module, it uses Rust-like result types to handle</span>
</span><span id="parse_configurations-116"><a href="#parse_configurations-116"><span class="linenos">116</span></a><span class="sd">        potential errors and pass them &quot;up&quot; to the main function.</span>
</span><span id="parse_configurations-117"><a href="#parse_configurations-117"><span class="linenos">117</span></a>
</span><span id="parse_configurations-118"><a href="#parse_configurations-118"><span class="linenos">118</span></a><span class="sd">    Args:</span>
</span><span id="parse_configurations-119"><a href="#parse_configurations-119"><span class="linenos">119</span></a><span class="sd">        `config_path: str`: A simple file path to a YAML-formatted config file in string</span>
</span><span id="parse_configurations-120"><a href="#parse_configurations-120"><span class="linenos">120</span></a><span class="sd">        format.</span>
</span><span id="parse_configurations-121"><a href="#parse_configurations-121"><span class="linenos">121</span></a>
</span><span id="parse_configurations-122"><a href="#parse_configurations-122"><span class="linenos">122</span></a><span class="sd">    Returns:</span>
</span><span id="parse_configurations-123"><a href="#parse_configurations-123"><span class="linenos">123</span></a><span class="sd">        `Result[ConfigParams, str]`: A result-type containing either an instance of the</span>
</span><span id="parse_configurations-124"><a href="#parse_configurations-124"><span class="linenos">124</span></a><span class="sd">        dataclass `ConfigParams` or an error message in string format.</span>
</span><span id="parse_configurations-125"><a href="#parse_configurations-125"><span class="linenos">125</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="parse_configurations-126"><a href="#parse_configurations-126"><span class="linenos">126</span></a>
</span><span id="parse_configurations-127"><a href="#parse_configurations-127"><span class="linenos">127</span></a>    <span class="c1"># define the statically typed schema for the config parameters</span>
</span><span id="parse_configurations-128"><a href="#parse_configurations-128"><span class="linenos">128</span></a>    <span class="n">schema</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span>
</span><span id="parse_configurations-129"><a href="#parse_configurations-129"><span class="linenos">129</span></a>        <span class="p">{</span>
</span><span id="parse_configurations-130"><a href="#parse_configurations-130"><span class="linenos">130</span></a>            <span class="s2">&quot;ivar_pattern&quot;</span><span class="p">:</span> <span class="n">Str</span><span class="p">(),</span>
</span><span id="parse_configurations-131"><a href="#parse_configurations-131"><span class="linenos">131</span></a>            <span class="s2">&quot;fasta_pattern&quot;</span><span class="p">:</span> <span class="n">Str</span><span class="p">(),</span>
</span><span id="parse_configurations-132"><a href="#parse_configurations-132"><span class="linenos">132</span></a>            <span class="s2">&quot;tidyvcf_pattern&quot;</span><span class="p">:</span> <span class="n">Str</span><span class="p">(),</span>
</span><span id="parse_configurations-133"><a href="#parse_configurations-133"><span class="linenos">133</span></a>            <span class="s2">&quot;fasta_split_char&quot;</span><span class="p">:</span> <span class="n">Str</span><span class="p">(),</span>
</span><span id="parse_configurations-134"><a href="#parse_configurations-134"><span class="linenos">134</span></a>            <span class="s2">&quot;fasta_split_index&quot;</span><span class="p">:</span> <span class="n">Int</span><span class="p">(),</span>
</span><span id="parse_configurations-135"><a href="#parse_configurations-135"><span class="linenos">135</span></a>            <span class="s2">&quot;ivar_split_char&quot;</span><span class="p">:</span> <span class="n">Str</span><span class="p">(),</span>
</span><span id="parse_configurations-136"><a href="#parse_configurations-136"><span class="linenos">136</span></a>            <span class="s2">&quot;id_split_index&quot;</span><span class="p">:</span> <span class="n">Int</span><span class="p">(),</span>
</span><span id="parse_configurations-137"><a href="#parse_configurations-137"><span class="linenos">137</span></a>            <span class="s2">&quot;hap_split_index&quot;</span><span class="p">:</span> <span class="n">Int</span><span class="p">(),</span>
</span><span id="parse_configurations-138"><a href="#parse_configurations-138"><span class="linenos">138</span></a>        <span class="p">}</span>
</span><span id="parse_configurations-139"><a href="#parse_configurations-139"><span class="linenos">139</span></a>    <span class="p">)</span>
</span><span id="parse_configurations-140"><a href="#parse_configurations-140"><span class="linenos">140</span></a>
</span><span id="parse_configurations-141"><a href="#parse_configurations-141"><span class="linenos">141</span></a>    <span class="c1"># use the schema and the provided path to parse out a dictionary of parameters</span>
</span><span id="parse_configurations-142"><a href="#parse_configurations-142"><span class="linenos">142</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="parse_configurations-143"><a href="#parse_configurations-143"><span class="linenos">143</span></a>        <span class="n">config_dict</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span id="parse_configurations-144"><a href="#parse_configurations-144"><span class="linenos">144</span></a>            <span class="nb">dict</span><span class="p">,</span> <span class="n">load</span><span class="p">((</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="o">/</span> <span class="n">config_path</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">(),</span> <span class="n">schema</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</span><span id="parse_configurations-145"><a href="#parse_configurations-145"><span class="linenos">145</span></a>        <span class="p">)</span>
</span><span id="parse_configurations-146"><a href="#parse_configurations-146"><span class="linenos">146</span></a>    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">message</span><span class="p">:</span>
</span><span id="parse_configurations-147"><a href="#parse_configurations-147"><span class="linenos">147</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The provided YAML file could not be parsed:</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="parse_configurations-148"><a href="#parse_configurations-148"><span class="linenos">148</span></a>    <span class="k">except</span> <span class="n">YAMLError</span> <span class="k">as</span> <span class="n">message</span><span class="p">:</span>
</span><span id="parse_configurations-149"><a href="#parse_configurations-149"><span class="linenos">149</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The provided YAML file could not be parsed:</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="parse_configurations-150"><a href="#parse_configurations-150"><span class="linenos">150</span></a>
</span><span id="parse_configurations-151"><a href="#parse_configurations-151"><span class="linenos">151</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">ConfigParams</span><span class="p">(</span>
</span><span id="parse_configurations-152"><a href="#parse_configurations-152"><span class="linenos">152</span></a>        <span class="n">ivar_pattern</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ivar_pattern&quot;</span><span class="p">)),</span>
</span><span id="parse_configurations-153"><a href="#parse_configurations-153"><span class="linenos">153</span></a>        <span class="n">fasta_pattern</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fasta_pattern&quot;</span><span class="p">)),</span>
</span><span id="parse_configurations-154"><a href="#parse_configurations-154"><span class="linenos">154</span></a>        <span class="n">tidyvcf_pattern</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tidyvcf_pattern&quot;</span><span class="p">)),</span>
</span><span id="parse_configurations-155"><a href="#parse_configurations-155"><span class="linenos">155</span></a>        <span class="n">fasta_split_char</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fasta_split_char&quot;</span><span class="p">)),</span>
</span><span id="parse_configurations-156"><a href="#parse_configurations-156"><span class="linenos">156</span></a>        <span class="n">fasta_split_index</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fasta_split_index&quot;</span><span class="p">)),</span>
</span><span id="parse_configurations-157"><a href="#parse_configurations-157"><span class="linenos">157</span></a>        <span class="n">ivar_split_char</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ivar_split_char&quot;</span><span class="p">)),</span>
</span><span id="parse_configurations-158"><a href="#parse_configurations-158"><span class="linenos">158</span></a>        <span class="n">id_split_index</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id_split_index&quot;</span><span class="p">)),</span>
</span><span id="parse_configurations-159"><a href="#parse_configurations-159"><span class="linenos">159</span></a>        <span class="n">hap_split_index</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hap_split_index&quot;</span><span class="p">)),</span>
</span><span id="parse_configurations-160"><a href="#parse_configurations-160"><span class="linenos">160</span></a>    <span class="p">)</span>
</span><span id="parse_configurations-161"><a href="#parse_configurations-161"><span class="linenos">161</span></a>
</span><span id="parse_configurations-162"><a href="#parse_configurations-162"><span class="linenos">162</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Configurations parsed.&quot;</span><span class="p">)</span>
</span><span id="parse_configurations-163"><a href="#parse_configurations-163"><span class="linenos">163</span></a>    <span class="n">ic</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span id="parse_configurations-164"><a href="#parse_configurations-164"><span class="linenos">164</span></a>
</span><span id="parse_configurations-165"><a href="#parse_configurations-165"><span class="linenos">165</span></a>    <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This module uses the library <code>strictYAML</code> to perform very strict, statically
    typed configuration. This helps catch errors downstream while also doing away with
    most hardcoding, which is likely to cause runtime errors for other users. Like
    the other functions in this module, it uses Rust-like result types to handle
    potential errors and pass them "up" to the main function.</p>

<p>Args:
    <code>config_path: str</code>: A simple file path to a YAML-formatted config file in string
    format.</p>

<p>Returns:
    <code>Result[ConfigParams, str]</code>: A result-type containing either an instance of the
    dataclass <code><a href="#ConfigParams">ConfigParams</a></code> or an error message in string format.</p>
</div>


                </section>
                <section id="construct_file_list">
                            <input id="construct_file_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">construct_file_list</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">results_dir</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span>,</span><span class="param">	<span class="n">glob_pattern</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span></span><span class="return-annotation">) -> <span class="n">Union</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">Ok</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]],</span> <span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">Err</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="construct_file_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#construct_file_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="construct_file_list-168"><a href="#construct_file_list-168"><span class="linenos">168</span></a><span class="k">def</span> <span class="nf">construct_file_list</span><span class="p">(</span>
</span><span id="construct_file_list-169"><a href="#construct_file_list-169"><span class="linenos">169</span></a>    <span class="n">results_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">glob_pattern</span><span class="p">:</span> <span class="n">Path</span>
</span><span id="construct_file_list-170"><a href="#construct_file_list-170"><span class="linenos">170</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="construct_file_list-171"><a href="#construct_file_list-171"><span class="linenos">171</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="construct_file_list-172"><a href="#construct_file_list-172"><span class="linenos">172</span></a><span class="sd">        Function `construct_file_list()` uses the provided path of wildcards</span>
</span><span id="construct_file_list-173"><a href="#construct_file_list-173"><span class="linenos">173</span></a><span class="sd">        to expand out all available files to be compiled downstream.</span>
</span><span id="construct_file_list-174"><a href="#construct_file_list-174"><span class="linenos">174</span></a>
</span><span id="construct_file_list-175"><a href="#construct_file_list-175"><span class="linenos">175</span></a><span class="sd">    Args:</span>
</span><span id="construct_file_list-176"><a href="#construct_file_list-176"><span class="linenos">176</span></a><span class="sd">        `results_dir: Path`: A Pathlib path instance recording the results</span>
</span><span id="construct_file_list-177"><a href="#construct_file_list-177"><span class="linenos">177</span></a><span class="sd">        &quot;root&quot; directory, which is the top of the Amplityper results hierarchy.</span>
</span><span id="construct_file_list-178"><a href="#construct_file_list-178"><span class="linenos">178</span></a><span class="sd">        `ivar_pattern: Path`: A Pathlib path instance containing wildcards</span>
</span><span id="construct_file_list-179"><a href="#construct_file_list-179"><span class="linenos">179</span></a><span class="sd">        that can be expanded to the desired files.</span>
</span><span id="construct_file_list-180"><a href="#construct_file_list-180"><span class="linenos">180</span></a>
</span><span id="construct_file_list-181"><a href="#construct_file_list-181"><span class="linenos">181</span></a><span class="sd">    Returns:</span>
</span><span id="construct_file_list-182"><a href="#construct_file_list-182"><span class="linenos">182</span></a><span class="sd">        `Result[List[Path], str]`: A Result type instance containing either</span>
</span><span id="construct_file_list-183"><a href="#construct_file_list-183"><span class="linenos">183</span></a><span class="sd">        a list of paths to the desired files, or an error message string.</span>
</span><span id="construct_file_list-184"><a href="#construct_file_list-184"><span class="linenos">184</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="construct_file_list-185"><a href="#construct_file_list-185"><span class="linenos">185</span></a>
</span><span id="construct_file_list-186"><a href="#construct_file_list-186"><span class="linenos">186</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Constructing file list:&quot;</span><span class="p">)</span>
</span><span id="construct_file_list-187"><a href="#construct_file_list-187"><span class="linenos">187</span></a>    <span class="n">ic</span><span class="p">(</span><span class="n">glob_pattern</span><span class="p">)</span>
</span><span id="construct_file_list-188"><a href="#construct_file_list-188"><span class="linenos">188</span></a>
</span><span id="construct_file_list-189"><a href="#construct_file_list-189"><span class="linenos">189</span></a>    <span class="c1"># collect a list of all the files to search</span>
</span><span id="construct_file_list-190"><a href="#construct_file_list-190"><span class="linenos">190</span></a>    <span class="c1"># pylint: disable-next=c-extension-no-member</span>
</span><span id="construct_file_list-191"><a href="#construct_file_list-191"><span class="linenos">191</span></a>    <span class="n">files_to_query</span> <span class="o">=</span> <span class="n">atc</span><span class="o">.</span><span class="n">build_file_list</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">results_dir</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">glob_pattern</span><span class="p">))</span>
</span><span id="construct_file_list-192"><a href="#construct_file_list-192"><span class="linenos">192</span></a>
</span><span id="construct_file_list-193"><a href="#construct_file_list-193"><span class="linenos">193</span></a>    <span class="c1"># make sure that there aren&#39;t duplicates</span>
</span><span id="construct_file_list-194"><a href="#construct_file_list-194"><span class="linenos">194</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="construct_file_list-195"><a href="#construct_file_list-195"><span class="linenos">195</span></a>        <span class="nb">set</span><span class="p">(</span><span class="n">files_to_query</span><span class="p">)</span>
</span><span id="construct_file_list-196"><a href="#construct_file_list-196"><span class="linenos">196</span></a>    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">message</span><span class="p">:</span>
</span><span id="construct_file_list-197"><a href="#construct_file_list-197"><span class="linenos">197</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Redundant files present that may corrupt results:</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="construct_file_list-198"><a href="#construct_file_list-198"><span class="linenos">198</span></a>
</span><span id="construct_file_list-199"><a href="#construct_file_list-199"><span class="linenos">199</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_to_query</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="construct_file_list-200"><a href="#construct_file_list-200"><span class="linenos">200</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span>
</span><span id="construct_file_list-201"><a href="#construct_file_list-201"><span class="linenos">201</span></a>            <span class="sa">f</span><span class="s2">&quot;No files found that match the wildcard path:</span><span class="se">\n</span><span class="si">{</span><span class="n">glob_pattern</span><span class="si">}</span><span class="se">\n</span><span class="s2">within </span><span class="si">{</span><span class="n">results_dir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="construct_file_list-202"><a href="#construct_file_list-202"><span class="linenos">202</span></a>        <span class="p">)</span>
</span><span id="construct_file_list-203"><a href="#construct_file_list-203"><span class="linenos">203</span></a>
</span><span id="construct_file_list-204"><a href="#construct_file_list-204"><span class="linenos">204</span></a>    <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">files_to_query</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Function <code><a href="#construct_file_list">construct_file_list()</a></code> uses the provided path of wildcards
    to expand out all available files to be compiled downstream.</p>

<p>Args:
    <code>results_dir: Path</code>: A Pathlib path instance recording the results
    "root" directory, which is the top of the Amplityper results hierarchy.
    <code>ivar_pattern: Path</code>: A Pathlib path instance containing wildcards
    that can be expanded to the desired files.</p>

<p>Returns:
    <code>Result[List[Path], str]</code>: A Result type instance containing either
    a list of paths to the desired files, or an error message string.</p>
</div>


                </section>
                <section id="compile_data_with_io">
                            <input id="compile_data_with_io-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">compile_data_with_io</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">file_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span>,</span><span class="param">	<span class="n">config</span><span class="p">:</span> <span class="n"><a href="#ConfigParams">ConfigParams</a></span>,</span><span class="param">	<span class="n">whether_resume</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">) -> <span class="n">Union</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">Ok</span><span class="p">[</span><span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">],</span> <span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">Err</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="compile_data_with_io-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compile_data_with_io"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compile_data_with_io-207"><a href="#compile_data_with_io-207"><span class="linenos">207</span></a><span class="k">def</span> <span class="nf">compile_data_with_io</span><span class="p">(</span>
</span><span id="compile_data_with_io-208"><a href="#compile_data_with_io-208"><span class="linenos">208</span></a>    <span class="n">file_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParams</span><span class="p">,</span> <span class="n">whether_resume</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="compile_data_with_io-209"><a href="#compile_data_with_io-209"><span class="linenos">209</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="compile_data_with_io-210"><a href="#compile_data_with_io-210"><span class="linenos">210</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compile_data_with_io-211"><a href="#compile_data_with_io-211"><span class="linenos">211</span></a><span class="sd">        Function `compile_data_with_io()` takes the list of paths and</span>
</span><span id="compile_data_with_io-212"><a href="#compile_data_with_io-212"><span class="linenos">212</span></a><span class="sd">        reads each file, parsing it with Polars, and writing it into one</span>
</span><span id="compile_data_with_io-213"><a href="#compile_data_with_io-213"><span class="linenos">213</span></a><span class="sd">        large temporary TSV file. This method for compiling all files into</span>
</span><span id="compile_data_with_io-214"><a href="#compile_data_with_io-214"><span class="linenos">214</span></a><span class="sd">        one involves a great deal of read-write, but it also avoids potential</span>
</span><span id="compile_data_with_io-215"><a href="#compile_data_with_io-215"><span class="linenos">215</span></a><span class="sd">        type mismatch issues between a type schema inferred for one dataframe</span>
</span><span id="compile_data_with_io-216"><a href="#compile_data_with_io-216"><span class="linenos">216</span></a><span class="sd">        and the type schema inferred for the next. Downstream, the new</span>
</span><span id="compile_data_with_io-217"><a href="#compile_data_with_io-217"><span class="linenos">217</span></a><span class="sd">        TSV can be parsed into a single dataframe where it&#39;s possible to</span>
</span><span id="compile_data_with_io-218"><a href="#compile_data_with_io-218"><span class="linenos">218</span></a><span class="sd">        infer a type scheme from many rows.</span>
</span><span id="compile_data_with_io-219"><a href="#compile_data_with_io-219"><span class="linenos">219</span></a>
</span><span id="compile_data_with_io-220"><a href="#compile_data_with_io-220"><span class="linenos">220</span></a><span class="sd">    Args:</span>
</span><span id="compile_data_with_io-221"><a href="#compile_data_with_io-221"><span class="linenos">221</span></a><span class="sd">        `file_list: List[Path]`: A list of paths, where each path points to</span>
</span><span id="compile_data_with_io-222"><a href="#compile_data_with_io-222"><span class="linenos">222</span></a><span class="sd">        a TSV file generated by iVar.</span>
</span><span id="compile_data_with_io-223"><a href="#compile_data_with_io-223"><span class="linenos">223</span></a>
</span><span id="compile_data_with_io-224"><a href="#compile_data_with_io-224"><span class="linenos">224</span></a><span class="sd">    Returns:</span>
</span><span id="compile_data_with_io-225"><a href="#compile_data_with_io-225"><span class="linenos">225</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame to be queries and transformed</span>
</span><span id="compile_data_with_io-226"><a href="#compile_data_with_io-226"><span class="linenos">226</span></a><span class="sd">        downstream.</span>
</span><span id="compile_data_with_io-227"><a href="#compile_data_with_io-227"><span class="linenos">227</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compile_data_with_io-228"><a href="#compile_data_with_io-228"><span class="linenos">228</span></a>
</span><span id="compile_data_with_io-229"><a href="#compile_data_with_io-229"><span class="linenos">229</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">whether_resume</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="compile_data_with_io-230"><a href="#compile_data_with_io-230"><span class="linenos">230</span></a>        <span class="n">all_contigs</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_ipc</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">,</span> <span class="n">memory_map</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="compile_data_with_io-231"><a href="#compile_data_with_io-231"><span class="linenos">231</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">)</span>
</span><span id="compile_data_with_io-232"><a href="#compile_data_with_io-232"><span class="linenos">232</span></a>        <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">all_contigs</span><span class="p">)</span>
</span><span id="compile_data_with_io-233"><a href="#compile_data_with_io-233"><span class="linenos">233</span></a>
</span><span id="compile_data_with_io-234"><a href="#compile_data_with_io-234"><span class="linenos">234</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Compiling variant data for each contig.&quot;</span><span class="p">)</span>
</span><span id="compile_data_with_io-235"><a href="#compile_data_with_io-235"><span class="linenos">235</span></a>    <span class="n">ic</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="compile_data_with_io-236"><a href="#compile_data_with_io-236"><span class="linenos">236</span></a>
</span><span id="compile_data_with_io-237"><a href="#compile_data_with_io-237"><span class="linenos">237</span></a>    <span class="c1"># Use core module written in Rust to traverse the file system and run</span>
</span><span id="compile_data_with_io-238"><a href="#compile_data_with_io-238"><span class="linenos">238</span></a>    <span class="c1"># read/writes quickly</span>
</span><span id="compile_data_with_io-239"><a href="#compile_data_with_io-239"><span class="linenos">239</span></a>    <span class="n">atc</span><span class="o">.</span><span class="n">collate_results</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span>  <span class="c1"># pylint: disable=c-extension-no-member</span>
</span><span id="compile_data_with_io-240"><a href="#compile_data_with_io-240"><span class="linenos">240</span></a>
</span><span id="compile_data_with_io-241"><a href="#compile_data_with_io-241"><span class="linenos">241</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Converting variant data to compressed arrow format.&quot;</span><span class="p">)</span>
</span><span id="compile_data_with_io-242"><a href="#compile_data_with_io-242"><span class="linenos">242</span></a>
</span><span id="compile_data_with_io-243"><a href="#compile_data_with_io-243"><span class="linenos">243</span></a>    <span class="c1"># lazily scan the new tmp tsv for usage downstream</span>
</span><span id="compile_data_with_io-244"><a href="#compile_data_with_io-244"><span class="linenos">244</span></a>    <span class="n">pl</span><span class="o">.</span><span class="n">scan_csv</span><span class="p">(</span><span class="s2">&quot;tmp.tsv&quot;</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">infer_schema_length</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
</span><span id="compile_data_with_io-245"><a href="#compile_data_with_io-245"><span class="linenos">245</span></a>        <span class="s2">&quot;POS&quot;</span>
</span><span id="compile_data_with_io-246"><a href="#compile_data_with_io-246"><span class="linenos">246</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">sink_ipc</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;zstd&quot;</span><span class="p">)</span>
</span><span id="compile_data_with_io-247"><a href="#compile_data_with_io-247"><span class="linenos">247</span></a>
</span><span id="compile_data_with_io-248"><a href="#compile_data_with_io-248"><span class="linenos">248</span></a>    <span class="n">all_contigs</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_ipc</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">,</span> <span class="n">memory_map</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="compile_data_with_io-249"><a href="#compile_data_with_io-249"><span class="linenos">249</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.tsv&quot;</span><span class="p">)</span>
</span><span id="compile_data_with_io-250"><a href="#compile_data_with_io-250"><span class="linenos">250</span></a>
</span><span id="compile_data_with_io-251"><a href="#compile_data_with_io-251"><span class="linenos">251</span></a>    <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span><span class="n">all_contigs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Function <code><a href="#compile_data_with_io">compile_data_with_io()</a></code> takes the list of paths and
    reads each file, parsing it with Polars, and writing it into one
    large temporary TSV file. This method for compiling all files into
    one involves a great deal of read-write, but it also avoids potential
    type mismatch issues between a type schema inferred for one dataframe
    and the type schema inferred for the next. Downstream, the new
    TSV can be parsed into a single dataframe where it's possible to
    infer a type scheme from many rows.</p>

<p>Args:
    <code>file_list: List[Path]</code>: A list of paths, where each path points to
    a TSV file generated by iVar.</p>

<p>Returns:
    <code>pl.LazyFrame</code>: A Polars LazyFrame to be queries and transformed
    downstream.</p>
</div>


                </section>
                <section id="collect_file_lists">
                            <input id="collect_file_lists-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">collect_file_lists</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">results_dir</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span>,</span><span class="param">	<span class="n">pattern1</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span>,</span><span class="param">	<span class="n">pattern2</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span>,</span><span class="param">	<span class="n">pattern3</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span></span><span class="return-annotation">) -> <span class="n">Union</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">Ok</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]]],</span> <span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">Err</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="collect_file_lists-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#collect_file_lists"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="collect_file_lists-254"><a href="#collect_file_lists-254"><span class="linenos">254</span></a><span class="k">def</span> <span class="nf">collect_file_lists</span><span class="p">(</span>
</span><span id="collect_file_lists-255"><a href="#collect_file_lists-255"><span class="linenos">255</span></a>    <span class="n">results_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">pattern1</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">pattern2</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">pattern3</span><span class="p">:</span> <span class="n">Path</span>
</span><span id="collect_file_lists-256"><a href="#collect_file_lists-256"><span class="linenos">256</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="collect_file_lists-257"><a href="#collect_file_lists-257"><span class="linenos">257</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="collect_file_lists-258"><a href="#collect_file_lists-258"><span class="linenos">258</span></a><span class="sd">        Function `collect_file_lists()` quarterbacks sequential executions of</span>
</span><span id="collect_file_lists-259"><a href="#collect_file_lists-259"><span class="linenos">259</span></a><span class="sd">        the `construct_file_list()` function, each with a different wildcard</span>
</span><span id="collect_file_lists-260"><a href="#collect_file_lists-260"><span class="linenos">260</span></a><span class="sd">        pattern. Doing so keeps the size of `main()` more reasonable and will</span>
</span><span id="collect_file_lists-261"><a href="#collect_file_lists-261"><span class="linenos">261</span></a><span class="sd">        also make potential refactoring easier in the future.</span>
</span><span id="collect_file_lists-262"><a href="#collect_file_lists-262"><span class="linenos">262</span></a>
</span><span id="collect_file_lists-263"><a href="#collect_file_lists-263"><span class="linenos">263</span></a><span class="sd">    Args:</span>
</span><span id="collect_file_lists-264"><a href="#collect_file_lists-264"><span class="linenos">264</span></a><span class="sd">        `results_dir: Path`: A Pathlib Path type pointing to the results &quot;root&quot;</span>
</span><span id="collect_file_lists-265"><a href="#collect_file_lists-265"><span class="linenos">265</span></a><span class="sd">        directory to be searched with the following glob wildcard patterns.</span>
</span><span id="collect_file_lists-266"><a href="#collect_file_lists-266"><span class="linenos">266</span></a><span class="sd">        `pattern1: Path`: A Pathlib Path type, which can contain wildcards to</span>
</span><span id="collect_file_lists-267"><a href="#collect_file_lists-267"><span class="linenos">267</span></a><span class="sd">        be expanded with the glob library.</span>
</span><span id="collect_file_lists-268"><a href="#collect_file_lists-268"><span class="linenos">268</span></a><span class="sd">        `pattern2: Path`: A Pathlib Path type, which can contain wildcards to</span>
</span><span id="collect_file_lists-269"><a href="#collect_file_lists-269"><span class="linenos">269</span></a><span class="sd">        be expanded with the glob library.</span>
</span><span id="collect_file_lists-270"><a href="#collect_file_lists-270"><span class="linenos">270</span></a><span class="sd">        `pattern3: Path`: A Pathlib Path type, which can contain wildcards to</span>
</span><span id="collect_file_lists-271"><a href="#collect_file_lists-271"><span class="linenos">271</span></a><span class="sd">        be expanded with the glob library.</span>
</span><span id="collect_file_lists-272"><a href="#collect_file_lists-272"><span class="linenos">272</span></a>
</span><span id="collect_file_lists-273"><a href="#collect_file_lists-273"><span class="linenos">273</span></a><span class="sd">    Returns:</span>
</span><span id="collect_file_lists-274"><a href="#collect_file_lists-274"><span class="linenos">274</span></a><span class="sd">        `Result[List[List[Path]], str]`: A Result type containing eaither a list of</span>
</span><span id="collect_file_lists-275"><a href="#collect_file_lists-275"><span class="linenos">275</span></a><span class="sd">        lists or an error message string.</span>
</span><span id="collect_file_lists-276"><a href="#collect_file_lists-276"><span class="linenos">276</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="collect_file_lists-277"><a href="#collect_file_lists-277"><span class="linenos">277</span></a>
</span><span id="collect_file_lists-278"><a href="#collect_file_lists-278"><span class="linenos">278</span></a>    <span class="c1"># make a list of the iVar files to query based on the provided wildcard path</span>
</span><span id="collect_file_lists-279"><a href="#collect_file_lists-279"><span class="linenos">279</span></a>    <span class="n">ivar_list_result</span> <span class="o">=</span> <span class="n">construct_file_list</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="n">pattern1</span><span class="p">)</span>
</span><span id="collect_file_lists-280"><a href="#collect_file_lists-280"><span class="linenos">280</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ivar_list_result</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="collect_file_lists-281"><a href="#collect_file_lists-281"><span class="linenos">281</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span>
</span><span id="collect_file_lists-282"><a href="#collect_file_lists-282"><span class="linenos">282</span></a>            <span class="sa">f</span><span class="s2">&quot;No files found at the provided wildcard path:</span><span class="se">\n</span><span class="si">{</span><span class="n">ivar_list_result</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="collect_file_lists-283"><a href="#collect_file_lists-283"><span class="linenos">283</span></a>        <span class="p">)</span>
</span><span id="collect_file_lists-284"><a href="#collect_file_lists-284"><span class="linenos">284</span></a>
</span><span id="collect_file_lists-285"><a href="#collect_file_lists-285"><span class="linenos">285</span></a>    <span class="c1"># Make a list of FASTA files to pull information from</span>
</span><span id="collect_file_lists-286"><a href="#collect_file_lists-286"><span class="linenos">286</span></a>    <span class="n">fasta_list_result</span> <span class="o">=</span> <span class="n">construct_file_list</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="n">pattern2</span><span class="p">)</span>
</span><span id="collect_file_lists-287"><a href="#collect_file_lists-287"><span class="linenos">287</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fasta_list_result</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="collect_file_lists-288"><a href="#collect_file_lists-288"><span class="linenos">288</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span>
</span><span id="collect_file_lists-289"><a href="#collect_file_lists-289"><span class="linenos">289</span></a>            <span class="sa">f</span><span class="s2">&quot;No FASTAs found at the provided wildcard path:</span><span class="se">\n</span><span class="si">{</span><span class="n">fasta_list_result</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="collect_file_lists-290"><a href="#collect_file_lists-290"><span class="linenos">290</span></a>        <span class="p">)</span>
</span><span id="collect_file_lists-291"><a href="#collect_file_lists-291"><span class="linenos">291</span></a>
</span><span id="collect_file_lists-292"><a href="#collect_file_lists-292"><span class="linenos">292</span></a>    <span class="c1"># Make a list of &quot;tidy&quot; vcf files to pull codon information from</span>
</span><span id="collect_file_lists-293"><a href="#collect_file_lists-293"><span class="linenos">293</span></a>    <span class="n">tvcf_result</span> <span class="o">=</span> <span class="n">construct_file_list</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="n">pattern3</span><span class="p">)</span>
</span><span id="collect_file_lists-294"><a href="#collect_file_lists-294"><span class="linenos">294</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tvcf_result</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="collect_file_lists-295"><a href="#collect_file_lists-295"><span class="linenos">295</span></a>        <span class="k">return</span> <span class="n">Err</span><span class="p">(</span>
</span><span id="collect_file_lists-296"><a href="#collect_file_lists-296"><span class="linenos">296</span></a>            <span class="sa">f</span><span class="s2">&quot;No &#39;tidy&#39; VCF tables found at the provided wildcard path:</span><span class="se">\n</span><span class="si">{</span><span class="n">tvcf_result</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="collect_file_lists-297"><a href="#collect_file_lists-297"><span class="linenos">297</span></a>        <span class="p">)</span>
</span><span id="collect_file_lists-298"><a href="#collect_file_lists-298"><span class="linenos">298</span></a>
</span><span id="collect_file_lists-299"><a href="#collect_file_lists-299"><span class="linenos">299</span></a>    <span class="k">return</span> <span class="n">Ok</span><span class="p">(</span>
</span><span id="collect_file_lists-300"><a href="#collect_file_lists-300"><span class="linenos">300</span></a>        <span class="p">(</span>
</span><span id="collect_file_lists-301"><a href="#collect_file_lists-301"><span class="linenos">301</span></a>            <span class="n">ivar_list_result</span><span class="o">.</span><span class="n">unwrap_or</span><span class="p">([]),</span>
</span><span id="collect_file_lists-302"><a href="#collect_file_lists-302"><span class="linenos">302</span></a>            <span class="n">fasta_list_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(),</span>
</span><span id="collect_file_lists-303"><a href="#collect_file_lists-303"><span class="linenos">303</span></a>            <span class="n">tvcf_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(),</span>
</span><span id="collect_file_lists-304"><a href="#collect_file_lists-304"><span class="linenos">304</span></a>        <span class="p">)</span>
</span><span id="collect_file_lists-305"><a href="#collect_file_lists-305"><span class="linenos">305</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Function <code><a href="#collect_file_lists">collect_file_lists()</a></code> quarterbacks sequential executions of
    the <code><a href="#construct_file_list">construct_file_list()</a></code> function, each with a different wildcard
    pattern. Doing so keeps the size of <code><a href="#main">main()</a></code> more reasonable and will
    also make potential refactoring easier in the future.</p>

<p>Args:
    <code>results_dir: Path</code>: A Pathlib Path type pointing to the results "root"
    directory to be searched with the following glob wildcard patterns.
    <code>pattern1: Path</code>: A Pathlib Path type, which can contain wildcards to
    be expanded with the glob library.
    <code>pattern2: Path</code>: A Pathlib Path type, which can contain wildcards to
    be expanded with the glob library.
    <code>pattern3: Path</code>: A Pathlib Path type, which can contain wildcards to
    be expanded with the glob library.</p>

<p>Returns:
    <code>Result[List[List[Path]], str]</code>: A Result type containing eaither a list of
    lists or an error message string.</p>
</div>


                </section>
                <section id="generate_seq_dict">
                            <input id="generate_seq_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">generate_seq_dict</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">input_fasta</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>,</span><span class="param">	<span class="n">config</span><span class="p">:</span> <span class="n"><a href="#ConfigParams">ConfigParams</a></span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span>:</span></span>

                <label class="view-source-button" for="generate_seq_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#generate_seq_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="generate_seq_dict-356"><a href="#generate_seq_dict-356"><span class="linenos">356</span></a><span class="k">def</span> <span class="nf">generate_seq_dict</span><span class="p">(</span>
</span><span id="generate_seq_dict-357"><a href="#generate_seq_dict-357"><span class="linenos">357</span></a>    <span class="n">input_fasta</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParams</span>
</span><span id="generate_seq_dict-358"><a href="#generate_seq_dict-358"><span class="linenos">358</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
</span><span id="generate_seq_dict-359"><a href="#generate_seq_dict-359"><span class="linenos">359</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="generate_seq_dict-360"><a href="#generate_seq_dict-360"><span class="linenos">360</span></a><span class="sd">        The function `generate_seq_dict()` uses a series of list comprehensions</span>
</span><span id="generate_seq_dict-361"><a href="#generate_seq_dict-361"><span class="linenos">361</span></a><span class="sd">        to 1) Test that a FASTA file can be decoded into proper UTF-8 text; 2)</span>
</span><span id="generate_seq_dict-362"><a href="#generate_seq_dict-362"><span class="linenos">362</span></a><span class="sd">        Parse out the name of the current amplicon; And 3) Parse out a FASTA&#39;s</span>
</span><span id="generate_seq_dict-363"><a href="#generate_seq_dict-363"><span class="linenos">363</span></a><span class="sd">        defline and extract a sample ID and a depth of coverage. It then saves</span>
</span><span id="generate_seq_dict-364"><a href="#generate_seq_dict-364"><span class="linenos">364</span></a><span class="sd">        these pieces of information into a dictionary, where each key is a</span>
</span><span id="generate_seq_dict-365"><a href="#generate_seq_dict-365"><span class="linenos">365</span></a><span class="sd">        contig&#39;s unique identifier, and each value is the integer depth-of-</span>
</span><span id="generate_seq_dict-366"><a href="#generate_seq_dict-366"><span class="linenos">366</span></a><span class="sd">        coverage.</span>
</span><span id="generate_seq_dict-367"><a href="#generate_seq_dict-367"><span class="linenos">367</span></a>
</span><span id="generate_seq_dict-368"><a href="#generate_seq_dict-368"><span class="linenos">368</span></a><span class="sd">    Args:</span>
</span><span id="generate_seq_dict-369"><a href="#generate_seq_dict-369"><span class="linenos">369</span></a><span class="sd">        `input_fasta: List[str]`: Parsed FASTA lines store as strings in a list.</span>
</span><span id="generate_seq_dict-370"><a href="#generate_seq_dict-370"><span class="linenos">370</span></a><span class="sd">        `split_char: str`: The character, e.g. &quot;-&quot;, to use for splitting the</span>
</span><span id="generate_seq_dict-371"><a href="#generate_seq_dict-371"><span class="linenos">371</span></a><span class="sd">        FASTA defline to parse out information.</span>
</span><span id="generate_seq_dict-372"><a href="#generate_seq_dict-372"><span class="linenos">372</span></a>
</span><span id="generate_seq_dict-373"><a href="#generate_seq_dict-373"><span class="linenos">373</span></a><span class="sd">    Returns:</span>
</span><span id="generate_seq_dict-374"><a href="#generate_seq_dict-374"><span class="linenos">374</span></a><span class="sd">        `Optional[Dict[Optional[str], Optional[int]]]`: An option type, with</span>
</span><span id="generate_seq_dict-375"><a href="#generate_seq_dict-375"><span class="linenos">375</span></a><span class="sd">        option types being a union of type T or None, that wraps the contig</span>
</span><span id="generate_seq_dict-376"><a href="#generate_seq_dict-376"><span class="linenos">376</span></a><span class="sd">        identifier-depth dictionary. Each item in the dictionary can also be</span>
</span><span id="generate_seq_dict-377"><a href="#generate_seq_dict-377"><span class="linenos">377</span></a><span class="sd">        None.</span>
</span><span id="generate_seq_dict-378"><a href="#generate_seq_dict-378"><span class="linenos">378</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="generate_seq_dict-379"><a href="#generate_seq_dict-379"><span class="linenos">379</span></a>
</span><span id="generate_seq_dict-380"><a href="#generate_seq_dict-380"><span class="linenos">380</span></a>    <span class="c1"># make sure the lines can be decoded</span>
</span><span id="generate_seq_dict-381"><a href="#generate_seq_dict-381"><span class="linenos">381</span></a>    <span class="n">decodable</span> <span class="o">=</span> <span class="p">[</span><span class="n">_is_valid_utf8</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">input_fasta</span><span class="p">]</span>
</span><span id="generate_seq_dict-382"><a href="#generate_seq_dict-382"><span class="linenos">382</span></a>    <span class="k">if</span> <span class="kc">False</span> <span class="ow">in</span> <span class="n">decodable</span><span class="p">:</span>
</span><span id="generate_seq_dict-383"><a href="#generate_seq_dict-383"><span class="linenos">383</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="generate_seq_dict-384"><a href="#generate_seq_dict-384"><span class="linenos">384</span></a>
</span><span id="generate_seq_dict-385"><a href="#generate_seq_dict-385"><span class="linenos">385</span></a>    <span class="n">deflines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">input_fasta</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)]</span>
</span><span id="generate_seq_dict-386"><a href="#generate_seq_dict-386"><span class="linenos">386</span></a>    <span class="n">supports</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="generate_seq_dict-387"><a href="#generate_seq_dict-387"><span class="linenos">387</span></a>        <span class="n">_try_parse_int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">fasta_split_char</span><span class="p">)[</span><span class="n">config</span><span class="o">.</span><span class="n">fasta_split_index</span><span class="p">])</span>
</span><span id="generate_seq_dict-388"><a href="#generate_seq_dict-388"><span class="linenos">388</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">input_fasta</span>
</span><span id="generate_seq_dict-389"><a href="#generate_seq_dict-389"><span class="linenos">389</span></a>        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
</span><span id="generate_seq_dict-390"><a href="#generate_seq_dict-390"><span class="linenos">390</span></a>    <span class="p">]</span>
</span><span id="generate_seq_dict-391"><a href="#generate_seq_dict-391"><span class="linenos">391</span></a>    <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="n">_try_parse_identifier</span><span class="p">(</span><span class="n">defline</span><span class="p">)</span> <span class="k">for</span> <span class="n">defline</span> <span class="ow">in</span> <span class="n">deflines</span><span class="p">]</span>
</span><span id="generate_seq_dict-392"><a href="#generate_seq_dict-392"><span class="linenos">392</span></a>
</span><span id="generate_seq_dict-393"><a href="#generate_seq_dict-393"><span class="linenos">393</span></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">deflines</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="generate_seq_dict-394"><a href="#generate_seq_dict-394"><span class="linenos">394</span></a>        <span class="n">identifiers</span>
</span><span id="generate_seq_dict-395"><a href="#generate_seq_dict-395"><span class="linenos">395</span></a>    <span class="p">),</span> <span class="s2">&quot;Mismatch between the number of deflines and number of sequences&quot;</span>
</span><span id="generate_seq_dict-396"><a href="#generate_seq_dict-396"><span class="linenos">396</span></a>
</span><span id="generate_seq_dict-397"><a href="#generate_seq_dict-397"><span class="linenos">397</span></a>    <span class="n">seq_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">identifiers</span><span class="p">,</span> <span class="n">supports</span><span class="p">))</span>
</span><span id="generate_seq_dict-398"><a href="#generate_seq_dict-398"><span class="linenos">398</span></a>
</span><span id="generate_seq_dict-399"><a href="#generate_seq_dict-399"><span class="linenos">399</span></a>    <span class="k">return</span> <span class="n">seq_dict</span>
</span></pre></div>


            <div class="docstring"><p>The function <code><a href="#generate_seq_dict">generate_seq_dict()</a></code> uses a series of list comprehensions
    to 1) Test that a FASTA file can be decoded into proper UTF-8 text; 2)
    Parse out the name of the current amplicon; And 3) Parse out a FASTA's
    defline and extract a sample ID and a depth of coverage. It then saves
    these pieces of information into a dictionary, where each key is a
    contig's unique identifier, and each value is the integer depth-of-
    coverage.</p>

<p>Args:
    <code>input_fasta: List[str]</code>: Parsed FASTA lines store as strings in a list.
    <code>split_char: str</code>: The character, e.g. "-", to use for splitting the
    FASTA defline to parse out information.</p>

<p>Returns:
    <code>Optional[Dict[Optional[str], Optional[int]]]</code>: An option type, with
    option types being a union of type T or None, that wraps the contig
    identifier-depth dictionary. Each item in the dictionary can also be
    None.</p>
</div>


                </section>
                <section id="compile_mutation_codons">
                            <input id="compile_mutation_codons-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">compile_mutation_codons</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">tvcf_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span>,</span><span class="param">	<span class="n">whether_resume</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">) -> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span>:</span></span>

                <label class="view-source-button" for="compile_mutation_codons-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compile_mutation_codons"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compile_mutation_codons-402"><a href="#compile_mutation_codons-402"><span class="linenos">402</span></a><span class="k">def</span> <span class="nf">compile_mutation_codons</span><span class="p">(</span>
</span><span id="compile_mutation_codons-403"><a href="#compile_mutation_codons-403"><span class="linenos">403</span></a>    <span class="n">tvcf_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">whether_resume</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="compile_mutation_codons-404"><a href="#compile_mutation_codons-404"><span class="linenos">404</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="compile_mutation_codons-405"><a href="#compile_mutation_codons-405"><span class="linenos">405</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compile_mutation_codons-406"><a href="#compile_mutation_codons-406"><span class="linenos">406</span></a><span class="sd">        Function `compile_mutation_codons()` loops through all &quot;tidy&quot; VCF files</span>
</span><span id="compile_mutation_codons-407"><a href="#compile_mutation_codons-407"><span class="linenos">407</span></a><span class="sd">        in a provided list of Paths and creates a Polars LazyFrame containing</span>
</span><span id="compile_mutation_codons-408"><a href="#compile_mutation_codons-408"><span class="linenos">408</span></a><span class="sd">        1) A column of nucleotide mutation strings, and 2) a column of codon</span>
</span><span id="compile_mutation_codons-409"><a href="#compile_mutation_codons-409"><span class="linenos">409</span></a><span class="sd">        numbers for use with amino acid substitutions.</span>
</span><span id="compile_mutation_codons-410"><a href="#compile_mutation_codons-410"><span class="linenos">410</span></a>
</span><span id="compile_mutation_codons-411"><a href="#compile_mutation_codons-411"><span class="linenos">411</span></a><span class="sd">    Args:</span>
</span><span id="compile_mutation_codons-412"><a href="#compile_mutation_codons-412"><span class="linenos">412</span></a><span class="sd">        `tvcf_list: List[Path]`: A list containing Pathlib Path types pointing to</span>
</span><span id="compile_mutation_codons-413"><a href="#compile_mutation_codons-413"><span class="linenos">413</span></a><span class="sd">        any number of tidy VCF files to be assessed.</span>
</span><span id="compile_mutation_codons-414"><a href="#compile_mutation_codons-414"><span class="linenos">414</span></a>
</span><span id="compile_mutation_codons-415"><a href="#compile_mutation_codons-415"><span class="linenos">415</span></a><span class="sd">    Returns:</span>
</span><span id="compile_mutation_codons-416"><a href="#compile_mutation_codons-416"><span class="linenos">416</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame query that will be evaluated downstream.</span>
</span><span id="compile_mutation_codons-417"><a href="#compile_mutation_codons-417"><span class="linenos">417</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compile_mutation_codons-418"><a href="#compile_mutation_codons-418"><span class="linenos">418</span></a>
</span><span id="compile_mutation_codons-419"><a href="#compile_mutation_codons-419"><span class="linenos">419</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Compiling codon numbers for all coding mutations.&quot;</span><span class="p">)</span>
</span><span id="compile_mutation_codons-420"><a href="#compile_mutation_codons-420"><span class="linenos">420</span></a>
</span><span id="compile_mutation_codons-421"><a href="#compile_mutation_codons-421"><span class="linenos">421</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">whether_resume</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="compile_mutation_codons-422"><a href="#compile_mutation_codons-422"><span class="linenos">422</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">)</span>
</span><span id="compile_mutation_codons-423"><a href="#compile_mutation_codons-423"><span class="linenos">423</span></a>
</span><span id="compile_mutation_codons-424"><a href="#compile_mutation_codons-424"><span class="linenos">424</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">whether_resume</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="compile_mutation_codons-425"><a href="#compile_mutation_codons-425"><span class="linenos">425</span></a>        <span class="n">amassed_codons</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
</span><span id="compile_mutation_codons-426"><a href="#compile_mutation_codons-426"><span class="linenos">426</span></a>            <span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span>
</span><span id="compile_mutation_codons-427"><a href="#compile_mutation_codons-427"><span class="linenos">427</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
</span><span id="compile_mutation_codons-428"><a href="#compile_mutation_codons-428"><span class="linenos">428</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">)</span>
</span><span id="compile_mutation_codons-429"><a href="#compile_mutation_codons-429"><span class="linenos">429</span></a>        <span class="k">return</span> <span class="n">amassed_codons</span>
</span><span id="compile_mutation_codons-430"><a href="#compile_mutation_codons-430"><span class="linenos">430</span></a>
</span><span id="compile_mutation_codons-431"><a href="#compile_mutation_codons-431"><span class="linenos">431</span></a>    <span class="n">header_written</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="compile_mutation_codons-432"><a href="#compile_mutation_codons-432"><span class="linenos">432</span></a>
</span><span id="compile_mutation_codons-433"><a href="#compile_mutation_codons-433"><span class="linenos">433</span></a>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tvcf_list</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="compile_mutation_codons-434"><a href="#compile_mutation_codons-434"><span class="linenos">434</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp_file</span><span class="p">:</span>
</span><span id="compile_mutation_codons-435"><a href="#compile_mutation_codons-435"><span class="linenos">435</span></a>        <span class="k">for</span> <span class="n">tidy_vcf</span> <span class="ow">in</span> <span class="n">tvcf_list</span><span class="p">:</span>
</span><span id="compile_mutation_codons-436"><a href="#compile_mutation_codons-436"><span class="linenos">436</span></a>            <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="compile_mutation_codons-437"><a href="#compile_mutation_codons-437"><span class="linenos">437</span></a>            <span class="n">variants</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">tidy_vcf</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="compile_mutation_codons-438"><a href="#compile_mutation_codons-438"><span class="linenos">438</span></a>
</span><span id="compile_mutation_codons-439"><a href="#compile_mutation_codons-439"><span class="linenos">439</span></a>            <span class="c1"># do a few checks to make sure the loop doesn&#39;t hang on unexpected</span>
</span><span id="compile_mutation_codons-440"><a href="#compile_mutation_codons-440"><span class="linenos">440</span></a>            <span class="c1"># file writes</span>
</span><span id="compile_mutation_codons-441"><a href="#compile_mutation_codons-441"><span class="linenos">441</span></a>            <span class="k">if</span> <span class="n">variants</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="compile_mutation_codons-442"><a href="#compile_mutation_codons-442"><span class="linenos">442</span></a>                <span class="k">continue</span>
</span><span id="compile_mutation_codons-443"><a href="#compile_mutation_codons-443"><span class="linenos">443</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">variants</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">({</span><span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;alt&quot;</span><span class="p">}))</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="compile_mutation_codons-444"><a href="#compile_mutation_codons-444"><span class="linenos">444</span></a>                <span class="k">continue</span>
</span><span id="compile_mutation_codons-445"><a href="#compile_mutation_codons-445"><span class="linenos">445</span></a>            <span class="k">if</span> <span class="s2">&quot;info_ANN&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variants</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;NUC_SUB&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variants</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="compile_mutation_codons-446"><a href="#compile_mutation_codons-446"><span class="linenos">446</span></a>                <span class="k">continue</span>
</span><span id="compile_mutation_codons-447"><a href="#compile_mutation_codons-447"><span class="linenos">447</span></a>
</span><span id="compile_mutation_codons-448"><a href="#compile_mutation_codons-448"><span class="linenos">448</span></a>            <span class="n">variants</span> <span class="o">=</span> <span class="n">variants</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="compile_mutation_codons-449"><a href="#compile_mutation_codons-449"><span class="linenos">449</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
</span><span id="compile_mutation_codons-450"><a href="#compile_mutation_codons-450"><span class="linenos">450</span></a>                    <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ref&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;alt&quot;</span><span class="p">)],</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>
</span><span id="compile_mutation_codons-451"><a href="#compile_mutation_codons-451"><span class="linenos">451</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span>
</span><span id="compile_mutation_codons-452"><a href="#compile_mutation_codons-452"><span class="linenos">452</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">,</span> <span class="s2">&quot;info_ANN&quot;</span><span class="p">])</span>
</span><span id="compile_mutation_codons-453"><a href="#compile_mutation_codons-453"><span class="linenos">453</span></a>
</span><span id="compile_mutation_codons-454"><a href="#compile_mutation_codons-454"><span class="linenos">454</span></a>            <span class="c1"># separate out nucleotide substitutions and annotations</span>
</span><span id="compile_mutation_codons-455"><a href="#compile_mutation_codons-455"><span class="linenos">455</span></a>            <span class="n">nuc_subs</span> <span class="o">=</span> <span class="n">variants</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="compile_mutation_codons-456"><a href="#compile_mutation_codons-456"><span class="linenos">456</span></a>            <span class="n">anns</span> <span class="o">=</span> <span class="n">variants</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;info_ANN&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="compile_mutation_codons-457"><a href="#compile_mutation_codons-457"><span class="linenos">457</span></a>
</span><span id="compile_mutation_codons-458"><a href="#compile_mutation_codons-458"><span class="linenos">458</span></a>            <span class="c1"># Separate out the tenth annotation, which is the amino acid substitution</span>
</span><span id="compile_mutation_codons-459"><a href="#compile_mutation_codons-459"><span class="linenos">459</span></a>            <span class="n">aa_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">ann</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="mi">10</span><span class="p">]</span> <span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">anns</span><span class="p">]</span>
</span><span id="compile_mutation_codons-460"><a href="#compile_mutation_codons-460"><span class="linenos">460</span></a>
</span><span id="compile_mutation_codons-461"><a href="#compile_mutation_codons-461"><span class="linenos">461</span></a>            <span class="c1"># Separate out the codon numbers and make sure they are a numeric type</span>
</span><span id="compile_mutation_codons-462"><a href="#compile_mutation_codons-462"><span class="linenos">462</span></a>            <span class="n">codons</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">codon</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()))</span> <span class="k">for</span> <span class="n">codon</span> <span class="ow">in</span> <span class="n">aa_vars</span><span class="p">]</span>
</span><span id="compile_mutation_codons-463"><a href="#compile_mutation_codons-463"><span class="linenos">463</span></a>            <span class="n">num_codons</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">codon</span><span class="p">)</span> <span class="k">if</span> <span class="n">codon</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">codon</span> <span class="ow">in</span> <span class="n">codons</span><span class="p">]</span>
</span><span id="compile_mutation_codons-464"><a href="#compile_mutation_codons-464"><span class="linenos">464</span></a>
</span><span id="compile_mutation_codons-465"><a href="#compile_mutation_codons-465"><span class="linenos">465</span></a>            <span class="c1"># decide whether to write header or just append rows</span>
</span><span id="compile_mutation_codons-466"><a href="#compile_mutation_codons-466"><span class="linenos">466</span></a>            <span class="k">if</span> <span class="n">header_written</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="compile_mutation_codons-467"><a href="#compile_mutation_codons-467"><span class="linenos">467</span></a>                <span class="n">write_header</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="compile_mutation_codons-468"><a href="#compile_mutation_codons-468"><span class="linenos">468</span></a>                <span class="n">header_written</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="compile_mutation_codons-469"><a href="#compile_mutation_codons-469"><span class="linenos">469</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="compile_mutation_codons-470"><a href="#compile_mutation_codons-470"><span class="linenos">470</span></a>                <span class="n">write_header</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="compile_mutation_codons-471"><a href="#compile_mutation_codons-471"><span class="linenos">471</span></a>
</span><span id="compile_mutation_codons-472"><a href="#compile_mutation_codons-472"><span class="linenos">472</span></a>            <span class="c1"># write out</span>
</span><span id="compile_mutation_codons-473"><a href="#compile_mutation_codons-473"><span class="linenos">473</span></a>            <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">:</span> <span class="n">nuc_subs</span><span class="p">,</span> <span class="s2">&quot;CODON&quot;</span><span class="p">:</span> <span class="n">num_codons</span><span class="p">})</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">write_csv</span><span class="p">(</span>
</span><span id="compile_mutation_codons-474"><a href="#compile_mutation_codons-474"><span class="linenos">474</span></a>                <span class="n">tmp_file</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">include_header</span><span class="o">=</span><span class="n">write_header</span>
</span><span id="compile_mutation_codons-475"><a href="#compile_mutation_codons-475"><span class="linenos">475</span></a>            <span class="p">)</span>
</span><span id="compile_mutation_codons-476"><a href="#compile_mutation_codons-476"><span class="linenos">476</span></a>    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="compile_mutation_codons-477"><a href="#compile_mutation_codons-477"><span class="linenos">477</span></a>
</span><span id="compile_mutation_codons-478"><a href="#compile_mutation_codons-478"><span class="linenos">478</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;All codons compiled in temporary file.&quot;</span><span class="p">)</span>
</span><span id="compile_mutation_codons-479"><a href="#compile_mutation_codons-479"><span class="linenos">479</span></a>
</span><span id="compile_mutation_codons-480"><a href="#compile_mutation_codons-480"><span class="linenos">480</span></a>    <span class="c1"># When the full dataset is ammassed read and &quot;lazify&quot; it</span>
</span><span id="compile_mutation_codons-481"><a href="#compile_mutation_codons-481"><span class="linenos">481</span></a>    <span class="n">amassed_codons</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
</span><span id="compile_mutation_codons-482"><a href="#compile_mutation_codons-482"><span class="linenos">482</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.tvcf&quot;</span><span class="p">)</span>
</span><span id="compile_mutation_codons-483"><a href="#compile_mutation_codons-483"><span class="linenos">483</span></a>    <span class="k">return</span> <span class="n">amassed_codons</span>
</span></pre></div>


            <div class="docstring"><p>Function <code><a href="#compile_mutation_codons">compile_mutation_codons()</a></code> loops through all "tidy" VCF files
    in a provided list of Paths and creates a Polars LazyFrame containing
    1) A column of nucleotide mutation strings, and 2) a column of codon
    numbers for use with amino acid substitutions.</p>

<p>Args:
    <code>tvcf_list: List[Path]</code>: A list containing Pathlib Path types pointing to
    any number of tidy VCF files to be assessed.</p>

<p>Returns:
    <code>pl.LazyFrame</code>: A Polars LazyFrame query that will be evaluated downstream.</p>
</div>


                </section>
                <section id="compile_contig_depths">
                            <input id="compile_contig_depths-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">compile_contig_depths</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">fasta_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span>,</span><span class="param">	<span class="n">config</span><span class="p">:</span> <span class="n"><a href="#ConfigParams">ConfigParams</a></span></span><span class="return-annotation">) -> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span>:</span></span>

                <label class="view-source-button" for="compile_contig_depths-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compile_contig_depths"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compile_contig_depths-486"><a href="#compile_contig_depths-486"><span class="linenos">486</span></a><span class="k">def</span> <span class="nf">compile_contig_depths</span><span class="p">(</span><span class="n">fasta_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParams</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="compile_contig_depths-487"><a href="#compile_contig_depths-487"><span class="linenos">487</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compile_contig_depths-488"><a href="#compile_contig_depths-488"><span class="linenos">488</span></a><span class="sd">        Function `compile_contig_depths()` loops through all FASTA files</span>
</span><span id="compile_contig_depths-489"><a href="#compile_contig_depths-489"><span class="linenos">489</span></a><span class="sd">        in a provided list of FASTA Paths and creates a Polars LazyFrame containing</span>
</span><span id="compile_contig_depths-490"><a href="#compile_contig_depths-490"><span class="linenos">490</span></a><span class="sd">        1) A column of unique identifiers for each contig, and 2) a column of read</span>
</span><span id="compile_contig_depths-491"><a href="#compile_contig_depths-491"><span class="linenos">491</span></a><span class="sd">        supports/depths of coverage for each contig.</span>
</span><span id="compile_contig_depths-492"><a href="#compile_contig_depths-492"><span class="linenos">492</span></a>
</span><span id="compile_contig_depths-493"><a href="#compile_contig_depths-493"><span class="linenos">493</span></a><span class="sd">    Args:</span>
</span><span id="compile_contig_depths-494"><a href="#compile_contig_depths-494"><span class="linenos">494</span></a><span class="sd">        `fasta_list: List[Path]`: A list containing Pathlib Path types pointing to</span>
</span><span id="compile_contig_depths-495"><a href="#compile_contig_depths-495"><span class="linenos">495</span></a><span class="sd">        any number of FASTA files to be assessed.</span>
</span><span id="compile_contig_depths-496"><a href="#compile_contig_depths-496"><span class="linenos">496</span></a>
</span><span id="compile_contig_depths-497"><a href="#compile_contig_depths-497"><span class="linenos">497</span></a><span class="sd">    Returns:</span>
</span><span id="compile_contig_depths-498"><a href="#compile_contig_depths-498"><span class="linenos">498</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame query that will be evaluated downstream.</span>
</span><span id="compile_contig_depths-499"><a href="#compile_contig_depths-499"><span class="linenos">499</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compile_contig_depths-500"><a href="#compile_contig_depths-500"><span class="linenos">500</span></a>
</span><span id="compile_contig_depths-501"><a href="#compile_contig_depths-501"><span class="linenos">501</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Compiling contig depths for each contig FASTA.&quot;</span><span class="p">)</span>
</span><span id="compile_contig_depths-502"><a href="#compile_contig_depths-502"><span class="linenos">502</span></a>
</span><span id="compile_contig_depths-503"><a href="#compile_contig_depths-503"><span class="linenos">503</span></a>    <span class="n">seq_dicts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="compile_contig_depths-504"><a href="#compile_contig_depths-504"><span class="linenos">504</span></a>
</span><span id="compile_contig_depths-505"><a href="#compile_contig_depths-505"><span class="linenos">505</span></a>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fasta_list</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="compile_contig_depths-506"><a href="#compile_contig_depths-506"><span class="linenos">506</span></a>    <span class="k">for</span> <span class="n">fasta</span> <span class="ow">in</span> <span class="n">fasta_list</span><span class="p">:</span>
</span><span id="compile_contig_depths-507"><a href="#compile_contig_depths-507"><span class="linenos">507</span></a>        <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="compile_contig_depths-508"><a href="#compile_contig_depths-508"><span class="linenos">508</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fasta_contents</span><span class="p">:</span>
</span><span id="compile_contig_depths-509"><a href="#compile_contig_depths-509"><span class="linenos">509</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="compile_contig_depths-510"><a href="#compile_contig_depths-510"><span class="linenos">510</span></a>                <span class="n">fasta_lines</span> <span class="o">=</span> <span class="n">fasta_contents</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="compile_contig_depths-511"><a href="#compile_contig_depths-511"><span class="linenos">511</span></a>            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
</span><span id="compile_contig_depths-512"><a href="#compile_contig_depths-512"><span class="linenos">512</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="compile_contig_depths-513"><a href="#compile_contig_depths-513"><span class="linenos">513</span></a>                    <span class="sa">f</span><span class="s2">&quot;The FASTA at the following path could not be decoded to utf-8:</span><span class="se">\n</span><span class="si">{</span><span class="n">fasta</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="compile_contig_depths-514"><a href="#compile_contig_depths-514"><span class="linenos">514</span></a>                <span class="p">)</span>
</span><span id="compile_contig_depths-515"><a href="#compile_contig_depths-515"><span class="linenos">515</span></a>                <span class="k">continue</span>
</span><span id="compile_contig_depths-516"><a href="#compile_contig_depths-516"><span class="linenos">516</span></a>            <span class="n">seq_dict</span> <span class="o">=</span> <span class="n">generate_seq_dict</span><span class="p">(</span><span class="n">fasta_lines</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="compile_contig_depths-517"><a href="#compile_contig_depths-517"><span class="linenos">517</span></a>            <span class="k">if</span> <span class="n">seq_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="compile_contig_depths-518"><a href="#compile_contig_depths-518"><span class="linenos">518</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="compile_contig_depths-519"><a href="#compile_contig_depths-519"><span class="linenos">519</span></a>                    <span class="sa">f</span><span class="s2">&quot;The FASTA at the following path could not be decoded to utf-8:</span><span class="se">\n</span><span class="si">{</span><span class="n">fasta</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="compile_contig_depths-520"><a href="#compile_contig_depths-520"><span class="linenos">520</span></a>                <span class="p">)</span>
</span><span id="compile_contig_depths-521"><a href="#compile_contig_depths-521"><span class="linenos">521</span></a>                <span class="k">continue</span>
</span><span id="compile_contig_depths-522"><a href="#compile_contig_depths-522"><span class="linenos">522</span></a>            <span class="n">seq_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_dict</span><span class="p">)</span>
</span><span id="compile_contig_depths-523"><a href="#compile_contig_depths-523"><span class="linenos">523</span></a>    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="compile_contig_depths-524"><a href="#compile_contig_depths-524"><span class="linenos">524</span></a>
</span><span id="compile_contig_depths-525"><a href="#compile_contig_depths-525"><span class="linenos">525</span></a>    <span class="n">identifiers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="compile_contig_depths-526"><a href="#compile_contig_depths-526"><span class="linenos">526</span></a>        <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">seq_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">seq_dict</span> <span class="ow">in</span> <span class="n">seq_dicts</span><span class="p">)</span>
</span><span id="compile_contig_depths-527"><a href="#compile_contig_depths-527"><span class="linenos">527</span></a>    <span class="p">)</span>
</span><span id="compile_contig_depths-528"><a href="#compile_contig_depths-528"><span class="linenos">528</span></a>    <span class="n">supports</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="compile_contig_depths-529"><a href="#compile_contig_depths-529"><span class="linenos">529</span></a>        <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">seq_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">seq_dict</span> <span class="ow">in</span> <span class="n">seq_dicts</span><span class="p">)</span>
</span><span id="compile_contig_depths-530"><a href="#compile_contig_depths-530"><span class="linenos">530</span></a>    <span class="p">)</span>
</span><span id="compile_contig_depths-531"><a href="#compile_contig_depths-531"><span class="linenos">531</span></a>
</span><span id="compile_contig_depths-532"><a href="#compile_contig_depths-532"><span class="linenos">532</span></a>    <span class="n">depth_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">(</span>
</span><span id="compile_contig_depths-533"><a href="#compile_contig_depths-533"><span class="linenos">533</span></a>        <span class="p">{</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">:</span> <span class="n">identifiers</span><span class="p">,</span> <span class="s2">&quot;Depth of Coverage&quot;</span><span class="p">:</span> <span class="n">supports</span><span class="p">}</span>
</span><span id="compile_contig_depths-534"><a href="#compile_contig_depths-534"><span class="linenos">534</span></a>    <span class="p">)</span>
</span><span id="compile_contig_depths-535"><a href="#compile_contig_depths-535"><span class="linenos">535</span></a>
</span><span id="compile_contig_depths-536"><a href="#compile_contig_depths-536"><span class="linenos">536</span></a>    <span class="k">return</span> <span class="n">depth_df</span>
</span></pre></div>


            <div class="docstring"><p>Function <code><a href="#compile_contig_depths">compile_contig_depths()</a></code> loops through all FASTA files
    in a provided list of FASTA Paths and creates a Polars LazyFrame containing
    1) A column of unique identifiers for each contig, and 2) a column of read
    supports/depths of coverage for each contig.</p>

<p>Args:
    <code>fasta_list: List[Path]</code>: A list containing Pathlib Path types pointing to
    any number of FASTA files to be assessed.</p>

<p>Returns:
    <code>pl.LazyFrame</code>: A Polars LazyFrame query that will be evaluated downstream.</p>
</div>


                </section>
                <section id="generate_gene_df">
                            <input id="generate_gene_df-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">generate_gene_df</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">gene_bed</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span></span><span class="return-annotation">) -> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span>:</span></span>

                <label class="view-source-button" for="generate_gene_df-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#generate_gene_df"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="generate_gene_df-539"><a href="#generate_gene_df-539"><span class="linenos">539</span></a><span class="k">def</span> <span class="nf">generate_gene_df</span><span class="p">(</span><span class="n">gene_bed</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="generate_gene_df-540"><a href="#generate_gene_df-540"><span class="linenos">540</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="generate_gene_df-541"><a href="#generate_gene_df-541"><span class="linenos">541</span></a><span class="sd">        Function `generate_gene_df()` uses series of joins on a BED file of amplicons</span>
</span><span id="generate_gene_df-542"><a href="#generate_gene_df-542"><span class="linenos">542</span></a><span class="sd">        and genes to extract an &quot;amplicon basename&quot; alongside the start/stop positions</span>
</span><span id="generate_gene_df-543"><a href="#generate_gene_df-543"><span class="linenos">543</span></a><span class="sd">        and genes associated with each amplicon.</span>
</span><span id="generate_gene_df-544"><a href="#generate_gene_df-544"><span class="linenos">544</span></a>
</span><span id="generate_gene_df-545"><a href="#generate_gene_df-545"><span class="linenos">545</span></a><span class="sd">    Args:</span>
</span><span id="generate_gene_df-546"><a href="#generate_gene_df-546"><span class="linenos">546</span></a><span class="sd">        `gene_bed: Path`: A Pathlib Path type pointing to the location of a BED file</span>
</span><span id="generate_gene_df-547"><a href="#generate_gene_df-547"><span class="linenos">547</span></a><span class="sd">        with of all primers, which must contain start and stop positions for each primer,</span>
</span><span id="generate_gene_df-548"><a href="#generate_gene_df-548"><span class="linenos">548</span></a><span class="sd">        amplicon names, and genes</span>
</span><span id="generate_gene_df-549"><a href="#generate_gene_df-549"><span class="linenos">549</span></a>
</span><span id="generate_gene_df-550"><a href="#generate_gene_df-550"><span class="linenos">550</span></a><span class="sd">    Returns:</span>
</span><span id="generate_gene_df-551"><a href="#generate_gene_df-551"><span class="linenos">551</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame query that will be evaluated downstream.</span>
</span><span id="generate_gene_df-552"><a href="#generate_gene_df-552"><span class="linenos">552</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="generate_gene_df-553"><a href="#generate_gene_df-553"><span class="linenos">553</span></a>
</span><span id="generate_gene_df-554"><a href="#generate_gene_df-554"><span class="linenos">554</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Generating gene dataframe.&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-555"><a href="#generate_gene_df-555"><span class="linenos">555</span></a>
</span><span id="generate_gene_df-556"><a href="#generate_gene_df-556"><span class="linenos">556</span></a>    <span class="n">gene_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="generate_gene_df-557"><a href="#generate_gene_df-557"><span class="linenos">557</span></a>        <span class="n">pl</span><span class="o">.</span><span class="n">scan_csv</span><span class="p">(</span>
</span><span id="generate_gene_df-558"><a href="#generate_gene_df-558"><span class="linenos">558</span></a>            <span class="n">gene_bed</span><span class="p">,</span>
</span><span id="generate_gene_df-559"><a href="#generate_gene_df-559"><span class="linenos">559</span></a>            <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-560"><a href="#generate_gene_df-560"><span class="linenos">560</span></a>            <span class="n">has_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="generate_gene_df-561"><a href="#generate_gene_df-561"><span class="linenos">561</span></a>            <span class="n">new_columns</span><span class="o">=</span><span class="p">[</span>
</span><span id="generate_gene_df-562"><a href="#generate_gene_df-562"><span class="linenos">562</span></a>                <span class="s2">&quot;Ref&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-563"><a href="#generate_gene_df-563"><span class="linenos">563</span></a>                <span class="s2">&quot;Start Position&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-564"><a href="#generate_gene_df-564"><span class="linenos">564</span></a>                <span class="s2">&quot;Stop Position&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-565"><a href="#generate_gene_df-565"><span class="linenos">565</span></a>                <span class="s2">&quot;NAME&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-566"><a href="#generate_gene_df-566"><span class="linenos">566</span></a>                <span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-567"><a href="#generate_gene_df-567"><span class="linenos">567</span></a>                <span class="s2">&quot;INDEX&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-568"><a href="#generate_gene_df-568"><span class="linenos">568</span></a>                <span class="s2">&quot;Gene&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-569"><a href="#generate_gene_df-569"><span class="linenos">569</span></a>            <span class="p">],</span>
</span><span id="generate_gene_df-570"><a href="#generate_gene_df-570"><span class="linenos">570</span></a>        <span class="p">)</span>
</span><span id="generate_gene_df-571"><a href="#generate_gene_df-571"><span class="linenos">571</span></a>        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-572"><a href="#generate_gene_df-572"><span class="linenos">572</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="generate_gene_df-573"><a href="#generate_gene_df-573"><span class="linenos">573</span></a>            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-574"><a href="#generate_gene_df-574"><span class="linenos">574</span></a>            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_RIGHT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-575"><a href="#generate_gene_df-575"><span class="linenos">575</span></a>            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_LEFT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-576"><a href="#generate_gene_df-576"><span class="linenos">576</span></a>            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-577"><a href="#generate_gene_df-577"><span class="linenos">577</span></a>        <span class="p">)</span>
</span><span id="generate_gene_df-578"><a href="#generate_gene_df-578"><span class="linenos">578</span></a>        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-579"><a href="#generate_gene_df-579"><span class="linenos">579</span></a>        <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="generate_gene_df-580"><a href="#generate_gene_df-580"><span class="linenos">580</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="generate_gene_df-581"><a href="#generate_gene_df-581"><span class="linenos">581</span></a>            <span class="p">(</span>
</span><span id="generate_gene_df-582"><a href="#generate_gene_df-582"><span class="linenos">582</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">scan_csv</span><span class="p">(</span>
</span><span id="generate_gene_df-583"><a href="#generate_gene_df-583"><span class="linenos">583</span></a>                    <span class="n">gene_bed</span><span class="p">,</span>
</span><span id="generate_gene_df-584"><a href="#generate_gene_df-584"><span class="linenos">584</span></a>                    <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-585"><a href="#generate_gene_df-585"><span class="linenos">585</span></a>                    <span class="n">has_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="generate_gene_df-586"><a href="#generate_gene_df-586"><span class="linenos">586</span></a>                    <span class="n">new_columns</span><span class="o">=</span><span class="p">[</span>
</span><span id="generate_gene_df-587"><a href="#generate_gene_df-587"><span class="linenos">587</span></a>                        <span class="s2">&quot;Ref&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-588"><a href="#generate_gene_df-588"><span class="linenos">588</span></a>                        <span class="s2">&quot;Start Position&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-589"><a href="#generate_gene_df-589"><span class="linenos">589</span></a>                        <span class="s2">&quot;Stop Position&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-590"><a href="#generate_gene_df-590"><span class="linenos">590</span></a>                        <span class="s2">&quot;NAME&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-591"><a href="#generate_gene_df-591"><span class="linenos">591</span></a>                        <span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-592"><a href="#generate_gene_df-592"><span class="linenos">592</span></a>                        <span class="s2">&quot;INDEX&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-593"><a href="#generate_gene_df-593"><span class="linenos">593</span></a>                        <span class="s2">&quot;Gene&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-594"><a href="#generate_gene_df-594"><span class="linenos">594</span></a>                    <span class="p">],</span>
</span><span id="generate_gene_df-595"><a href="#generate_gene_df-595"><span class="linenos">595</span></a>                <span class="p">)</span>
</span><span id="generate_gene_df-596"><a href="#generate_gene_df-596"><span class="linenos">596</span></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Ref&quot;</span><span class="p">,</span> <span class="s2">&quot;INDEX&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-597"><a href="#generate_gene_df-597"><span class="linenos">597</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;_LEFT&quot;</span><span class="p">))</span>
</span><span id="generate_gene_df-598"><a href="#generate_gene_df-598"><span class="linenos">598</span></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Stop Position&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-599"><a href="#generate_gene_df-599"><span class="linenos">599</span></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="generate_gene_df-600"><a href="#generate_gene_df-600"><span class="linenos">600</span></a>                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-601"><a href="#generate_gene_df-601"><span class="linenos">601</span></a>                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_RIGHT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-602"><a href="#generate_gene_df-602"><span class="linenos">602</span></a>                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_LEFT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-603"><a href="#generate_gene_df-603"><span class="linenos">603</span></a>                    <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-604"><a href="#generate_gene_df-604"><span class="linenos">604</span></a>                <span class="p">)</span>
</span><span id="generate_gene_df-605"><a href="#generate_gene_df-605"><span class="linenos">605</span></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-606"><a href="#generate_gene_df-606"><span class="linenos">606</span></a>                <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="generate_gene_df-607"><a href="#generate_gene_df-607"><span class="linenos">607</span></a>            <span class="p">),</span>
</span><span id="generate_gene_df-608"><a href="#generate_gene_df-608"><span class="linenos">608</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-609"><a href="#generate_gene_df-609"><span class="linenos">609</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-610"><a href="#generate_gene_df-610"><span class="linenos">610</span></a>        <span class="p">)</span>
</span><span id="generate_gene_df-611"><a href="#generate_gene_df-611"><span class="linenos">611</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="generate_gene_df-612"><a href="#generate_gene_df-612"><span class="linenos">612</span></a>            <span class="p">(</span>
</span><span id="generate_gene_df-613"><a href="#generate_gene_df-613"><span class="linenos">613</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">scan_csv</span><span class="p">(</span>
</span><span id="generate_gene_df-614"><a href="#generate_gene_df-614"><span class="linenos">614</span></a>                    <span class="n">gene_bed</span><span class="p">,</span>
</span><span id="generate_gene_df-615"><a href="#generate_gene_df-615"><span class="linenos">615</span></a>                    <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-616"><a href="#generate_gene_df-616"><span class="linenos">616</span></a>                    <span class="n">has_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="generate_gene_df-617"><a href="#generate_gene_df-617"><span class="linenos">617</span></a>                    <span class="n">new_columns</span><span class="o">=</span><span class="p">[</span>
</span><span id="generate_gene_df-618"><a href="#generate_gene_df-618"><span class="linenos">618</span></a>                        <span class="s2">&quot;Ref&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-619"><a href="#generate_gene_df-619"><span class="linenos">619</span></a>                        <span class="s2">&quot;Start Position&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-620"><a href="#generate_gene_df-620"><span class="linenos">620</span></a>                        <span class="s2">&quot;Stop Position&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-621"><a href="#generate_gene_df-621"><span class="linenos">621</span></a>                        <span class="s2">&quot;NAME&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-622"><a href="#generate_gene_df-622"><span class="linenos">622</span></a>                        <span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-623"><a href="#generate_gene_df-623"><span class="linenos">623</span></a>                        <span class="s2">&quot;INDEX&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-624"><a href="#generate_gene_df-624"><span class="linenos">624</span></a>                        <span class="s2">&quot;Gene&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-625"><a href="#generate_gene_df-625"><span class="linenos">625</span></a>                    <span class="p">],</span>
</span><span id="generate_gene_df-626"><a href="#generate_gene_df-626"><span class="linenos">626</span></a>                <span class="p">)</span>
</span><span id="generate_gene_df-627"><a href="#generate_gene_df-627"><span class="linenos">627</span></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Ref&quot;</span><span class="p">,</span> <span class="s2">&quot;INDEX&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-628"><a href="#generate_gene_df-628"><span class="linenos">628</span></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;_RIGHT&quot;</span><span class="p">))</span>
</span><span id="generate_gene_df-629"><a href="#generate_gene_df-629"><span class="linenos">629</span></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Start Position&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-630"><a href="#generate_gene_df-630"><span class="linenos">630</span></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="generate_gene_df-631"><a href="#generate_gene_df-631"><span class="linenos">631</span></a>                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-632"><a href="#generate_gene_df-632"><span class="linenos">632</span></a>                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_RIGHT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-633"><a href="#generate_gene_df-633"><span class="linenos">633</span></a>                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_LEFT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-634"><a href="#generate_gene_df-634"><span class="linenos">634</span></a>                    <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-635"><a href="#generate_gene_df-635"><span class="linenos">635</span></a>                <span class="p">)</span>
</span><span id="generate_gene_df-636"><a href="#generate_gene_df-636"><span class="linenos">636</span></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;RESPLICE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-637"><a href="#generate_gene_df-637"><span class="linenos">637</span></a>                <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="generate_gene_df-638"><a href="#generate_gene_df-638"><span class="linenos">638</span></a>            <span class="p">),</span>
</span><span id="generate_gene_df-639"><a href="#generate_gene_df-639"><span class="linenos">639</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-640"><a href="#generate_gene_df-640"><span class="linenos">640</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">,</span>
</span><span id="generate_gene_df-641"><a href="#generate_gene_df-641"><span class="linenos">641</span></a>        <span class="p">)</span>
</span><span id="generate_gene_df-642"><a href="#generate_gene_df-642"><span class="linenos">642</span></a>        <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;Start Position&quot;</span><span class="p">,</span> <span class="s2">&quot;Stop Position&quot;</span><span class="p">)</span>
</span><span id="generate_gene_df-643"><a href="#generate_gene_df-643"><span class="linenos">643</span></a>    <span class="p">)</span>
</span><span id="generate_gene_df-644"><a href="#generate_gene_df-644"><span class="linenos">644</span></a>
</span><span id="generate_gene_df-645"><a href="#generate_gene_df-645"><span class="linenos">645</span></a>    <span class="k">return</span> <span class="n">gene_df</span>
</span></pre></div>


            <div class="docstring"><p>Function <code><a href="#generate_gene_df">generate_gene_df()</a></code> uses series of joins on a BED file of amplicons
    and genes to extract an "amplicon basename" alongside the start/stop positions
    and genes associated with each amplicon.</p>

<p>Args:
    <code>gene_bed: Path</code>: A Pathlib Path type pointing to the location of a BED file
    with of all primers, which must contain start and stop positions for each primer,
    amplicon names, and genes</p>

<p>Returns:
    <code>pl.LazyFrame</code>: A Polars LazyFrame query that will be evaluated downstream.</p>
</div>


                </section>
                <section id="construct_long_df">
                            <input id="construct_long_df-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">construct_long_df</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">all_contigs</span><span class="p">:</span> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span>,</span><span class="param">	<span class="n">gene_df</span><span class="p">:</span> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span>,</span><span class="param">	<span class="n">codon_df</span><span class="p">:</span> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span></span><span class="return-annotation">) -> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span>:</span></span>

                <label class="view-source-button" for="construct_long_df-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#construct_long_df"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="construct_long_df-648"><a href="#construct_long_df-648"><span class="linenos">648</span></a><span class="k">def</span> <span class="nf">construct_long_df</span><span class="p">(</span>
</span><span id="construct_long_df-649"><a href="#construct_long_df-649"><span class="linenos">649</span></a>    <span class="n">all_contigs</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">gene_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">codon_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span>
</span><span id="construct_long_df-650"><a href="#construct_long_df-650"><span class="linenos">650</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="construct_long_df-651"><a href="#construct_long_df-651"><span class="linenos">651</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="construct_long_df-652"><a href="#construct_long_df-652"><span class="linenos">652</span></a><span class="sd">        Function `construct_long_df()` constructs a &quot;long&quot; dataframe (or more specifically,</span>
</span><span id="construct_long_df-653"><a href="#construct_long_df-653"><span class="linenos">653</span></a><span class="sd">        a Polars LazyFrame query that, when evaluated downstream, will produce a dataframe)</span>
</span><span id="construct_long_df-654"><a href="#construct_long_df-654"><span class="linenos">654</span></a><span class="sd">        that lists each mutation in each contig alongside whether it is noncoding, synonymous,</span>
</span><span id="construct_long_df-655"><a href="#construct_long_df-655"><span class="linenos">655</span></a><span class="sd">        and nonsynonymous.</span>
</span><span id="construct_long_df-656"><a href="#construct_long_df-656"><span class="linenos">656</span></a>
</span><span id="construct_long_df-657"><a href="#construct_long_df-657"><span class="linenos">657</span></a><span class="sd">    Args:</span>
</span><span id="construct_long_df-658"><a href="#construct_long_df-658"><span class="linenos">658</span></a><span class="sd">        `all_contigs: pl.LazyFrame`: A Polars lazyframe that, when queried, will produce</span>
</span><span id="construct_long_df-659"><a href="#construct_long_df-659"><span class="linenos">659</span></a><span class="sd">        a dataframe out of all iVar tables merged together.</span>
</span><span id="construct_long_df-660"><a href="#construct_long_df-660"><span class="linenos">660</span></a><span class="sd">        `gene_df: pl.LazyFrame`: A Polars lazyframe that, when queried, will produce a</span>
</span><span id="construct_long_df-661"><a href="#construct_long_df-661"><span class="linenos">661</span></a><span class="sd">        dataframe where each row represents an amplicon, its start and stop positions, and</span>
</span><span id="construct_long_df-662"><a href="#construct_long_df-662"><span class="linenos">662</span></a><span class="sd">        which gene it is in.</span>
</span><span id="construct_long_df-663"><a href="#construct_long_df-663"><span class="linenos">663</span></a><span class="sd">        `codon_df: pl.LazyFrame`: A Polars lazyframe that, when queried, will be a table of</span>
</span><span id="construct_long_df-664"><a href="#construct_long_df-664"><span class="linenos">664</span></a><span class="sd">        nucleotide mutations and associated codons within the protein versions of the gene</span>
</span><span id="construct_long_df-665"><a href="#construct_long_df-665"><span class="linenos">665</span></a>
</span><span id="construct_long_df-666"><a href="#construct_long_df-666"><span class="linenos">666</span></a><span class="sd">    Returns:</span>
</span><span id="construct_long_df-667"><a href="#construct_long_df-667"><span class="linenos">667</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame query that will be evaluated downstream.</span>
</span><span id="construct_long_df-668"><a href="#construct_long_df-668"><span class="linenos">668</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="construct_long_df-669"><a href="#construct_long_df-669"><span class="linenos">669</span></a>
</span><span id="construct_long_df-670"><a href="#construct_long_df-670"><span class="linenos">670</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Using a series of joins to construct a long dataframe of all mutations.&quot;</span><span class="p">)</span>
</span><span id="construct_long_df-671"><a href="#construct_long_df-671"><span class="linenos">671</span></a>
</span><span id="construct_long_df-672"><a href="#construct_long_df-672"><span class="linenos">672</span></a>    <span class="n">long_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="construct_long_df-673"><a href="#construct_long_df-673"><span class="linenos">673</span></a>        <span class="n">all_contigs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
</span><span id="construct_long_df-674"><a href="#construct_long_df-674"><span class="linenos">674</span></a>            <span class="p">[</span>
</span><span id="construct_long_df-675"><a href="#construct_long_df-675"><span class="linenos">675</span></a>                <span class="s2">&quot;REGION&quot;</span><span class="p">,</span>
</span><span id="construct_long_df-676"><a href="#construct_long_df-676"><span class="linenos">676</span></a>                <span class="s2">&quot;POS&quot;</span><span class="p">,</span>
</span><span id="construct_long_df-677"><a href="#construct_long_df-677"><span class="linenos">677</span></a>                <span class="s2">&quot;REF&quot;</span><span class="p">,</span>
</span><span id="construct_long_df-678"><a href="#construct_long_df-678"><span class="linenos">678</span></a>                <span class="s2">&quot;ALT&quot;</span><span class="p">,</span>
</span><span id="construct_long_df-679"><a href="#construct_long_df-679"><span class="linenos">679</span></a>                <span class="s2">&quot;REF_AA&quot;</span><span class="p">,</span>
</span><span id="construct_long_df-680"><a href="#construct_long_df-680"><span class="linenos">680</span></a>                <span class="s2">&quot;ALT_AA&quot;</span><span class="p">,</span>
</span><span id="construct_long_df-681"><a href="#construct_long_df-681"><span class="linenos">681</span></a>                <span class="s2">&quot;Amplicon&quot;</span><span class="p">,</span>
</span><span id="construct_long_df-682"><a href="#construct_long_df-682"><span class="linenos">682</span></a>                <span class="s2">&quot;Sample ID&quot;</span><span class="p">,</span>
</span><span id="construct_long_df-683"><a href="#construct_long_df-683"><span class="linenos">683</span></a>                <span class="s2">&quot;Contig&quot;</span><span class="p">,</span>
</span><span id="construct_long_df-684"><a href="#construct_long_df-684"><span class="linenos">684</span></a>                <span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="construct_long_df-685"><a href="#construct_long_df-685"><span class="linenos">685</span></a>            <span class="p">]</span>
</span><span id="construct_long_df-686"><a href="#construct_long_df-686"><span class="linenos">686</span></a>        <span class="p">)</span>
</span><span id="construct_long_df-687"><a href="#construct_long_df-687"><span class="linenos">687</span></a>        <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="construct_long_df-688"><a href="#construct_long_df-688"><span class="linenos">688</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="construct_long_df-689"><a href="#construct_long_df-689"><span class="linenos">689</span></a>            <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
</span><span id="construct_long_df-690"><a href="#construct_long_df-690"><span class="linenos">690</span></a>                <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;REF&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;POS&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ALT&quot;</span><span class="p">)],</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>
</span><span id="construct_long_df-691"><a href="#construct_long_df-691"><span class="linenos">691</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span>
</span><span id="construct_long_df-692"><a href="#construct_long_df-692"><span class="linenos">692</span></a>        <span class="p">)</span>
</span><span id="construct_long_df-693"><a href="#construct_long_df-693"><span class="linenos">693</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gene_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">)</span>
</span><span id="construct_long_df-694"><a href="#construct_long_df-694"><span class="linenos">694</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">codon_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span>
</span><span id="construct_long_df-695"><a href="#construct_long_df-695"><span class="linenos">695</span></a>        <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="construct_long_df-696"><a href="#construct_long_df-696"><span class="linenos">696</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="construct_long_df-697"><a href="#construct_long_df-697"><span class="linenos">697</span></a>            <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;CODON&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">())</span>
</span><span id="construct_long_df-698"><a href="#construct_long_df-698"><span class="linenos">698</span></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span>
</span><span id="construct_long_df-699"><a href="#construct_long_df-699"><span class="linenos">699</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
</span><span id="construct_long_df-700"><a href="#construct_long_df-700"><span class="linenos">700</span></a>                    <span class="p">[</span>
</span><span id="construct_long_df-701"><a href="#construct_long_df-701"><span class="linenos">701</span></a>                        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;REF_AA&quot;</span><span class="p">),</span>
</span><span id="construct_long_df-702"><a href="#construct_long_df-702"><span class="linenos">702</span></a>                        <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">),</span>
</span><span id="construct_long_df-703"><a href="#construct_long_df-703"><span class="linenos">703</span></a>                        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ALT_AA&quot;</span><span class="p">),</span>
</span><span id="construct_long_df-704"><a href="#construct_long_df-704"><span class="linenos">704</span></a>                        <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;at nuc. position&quot;</span><span class="p">),</span>
</span><span id="construct_long_df-705"><a href="#construct_long_df-705"><span class="linenos">705</span></a>                        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;POS&quot;</span><span class="p">),</span>
</span><span id="construct_long_df-706"><a href="#construct_long_df-706"><span class="linenos">706</span></a>                    <span class="p">],</span>
</span><span id="construct_long_df-707"><a href="#construct_long_df-707"><span class="linenos">707</span></a>                    <span class="n">separator</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span>
</span><span id="construct_long_df-708"><a href="#construct_long_df-708"><span class="linenos">708</span></a>                <span class="p">)</span>
</span><span id="construct_long_df-709"><a href="#construct_long_df-709"><span class="linenos">709</span></a>            <span class="p">)</span>
</span><span id="construct_long_df-710"><a href="#construct_long_df-710"><span class="linenos">710</span></a>            <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span>
</span><span id="construct_long_df-711"><a href="#construct_long_df-711"><span class="linenos">711</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
</span><span id="construct_long_df-712"><a href="#construct_long_df-712"><span class="linenos">712</span></a>                    <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;REF_AA&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;CODON&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ALT_AA&quot;</span><span class="p">)],</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>
</span><span id="construct_long_df-713"><a href="#construct_long_df-713"><span class="linenos">713</span></a>                <span class="p">)</span>
</span><span id="construct_long_df-714"><a href="#construct_long_df-714"><span class="linenos">714</span></a>            <span class="p">)</span>
</span><span id="construct_long_df-715"><a href="#construct_long_df-715"><span class="linenos">715</span></a>            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span>
</span><span id="construct_long_df-716"><a href="#construct_long_df-716"><span class="linenos">716</span></a>        <span class="p">)</span>
</span><span id="construct_long_df-717"><a href="#construct_long_df-717"><span class="linenos">717</span></a>        <span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;REF&quot;</span><span class="p">,</span> <span class="s2">&quot;POS&quot;</span><span class="p">,</span> <span class="s2">&quot;ALT&quot;</span><span class="p">])</span>
</span><span id="construct_long_df-718"><a href="#construct_long_df-718"><span class="linenos">718</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="construct_long_df-719"><a href="#construct_long_df-719"><span class="linenos">719</span></a>            <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">([</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Gene&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)],</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span>
</span><span id="construct_long_df-720"><a href="#construct_long_df-720"><span class="linenos">720</span></a>                <span class="s2">&quot;AA_SUB&quot;</span>
</span><span id="construct_long_df-721"><a href="#construct_long_df-721"><span class="linenos">721</span></a>            <span class="p">)</span>
</span><span id="construct_long_df-722"><a href="#construct_long_df-722"><span class="linenos">722</span></a>        <span class="p">)</span>
</span><span id="construct_long_df-723"><a href="#construct_long_df-723"><span class="linenos">723</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="construct_long_df-724"><a href="#construct_long_df-724"><span class="linenos">724</span></a>            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ALT_AA&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;REF_AA&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Noncoding&quot;</span><span class="p">)</span>
</span><span id="construct_long_df-725"><a href="#construct_long_df-725"><span class="linenos">725</span></a>        <span class="p">)</span>
</span><span id="construct_long_df-726"><a href="#construct_long_df-726"><span class="linenos">726</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="construct_long_df-727"><a href="#construct_long_df-727"><span class="linenos">727</span></a>            <span class="p">(</span>
</span><span id="construct_long_df-728"><a href="#construct_long_df-728"><span class="linenos">728</span></a>                <span class="c1"># pylint: disable-next=singleton-comparison</span>
</span><span id="construct_long_df-729"><a href="#construct_long_df-729"><span class="linenos">729</span></a>                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ALT_AA&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;REF_AA&quot;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Noncoding&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># noqa: E712</span>
</span><span id="construct_long_df-730"><a href="#construct_long_df-730"><span class="linenos">730</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Synonymous&quot;</span><span class="p">)</span>
</span><span id="construct_long_df-731"><a href="#construct_long_df-731"><span class="linenos">731</span></a>        <span class="p">)</span>
</span><span id="construct_long_df-732"><a href="#construct_long_df-732"><span class="linenos">732</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="construct_long_df-733"><a href="#construct_long_df-733"><span class="linenos">733</span></a>            <span class="p">(</span>
</span><span id="construct_long_df-734"><a href="#construct_long_df-734"><span class="linenos">734</span></a>                <span class="c1"># pylint: disable-next=singleton-comparison</span>
</span><span id="construct_long_df-735"><a href="#construct_long_df-735"><span class="linenos">735</span></a>                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ALT_AA&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;REF_AA&quot;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Noncoding&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># noqa: E712</span>
</span><span id="construct_long_df-736"><a href="#construct_long_df-736"><span class="linenos">736</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Nonsynonymous&quot;</span><span class="p">)</span>
</span><span id="construct_long_df-737"><a href="#construct_long_df-737"><span class="linenos">737</span></a>        <span class="p">)</span>
</span><span id="construct_long_df-738"><a href="#construct_long_df-738"><span class="linenos">738</span></a>        <span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;REF_AA&quot;</span><span class="p">,</span> <span class="s2">&quot;ALT_AA&quot;</span><span class="p">,</span> <span class="s2">&quot;CODON&quot;</span><span class="p">])</span>
</span><span id="construct_long_df-739"><a href="#construct_long_df-739"><span class="linenos">739</span></a>    <span class="p">)</span>
</span><span id="construct_long_df-740"><a href="#construct_long_df-740"><span class="linenos">740</span></a>
</span><span id="construct_long_df-741"><a href="#construct_long_df-741"><span class="linenos">741</span></a>    <span class="n">long_df</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">write_ipc</span><span class="p">(</span><span class="s2">&quot;haplotype_long_table.arrow&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;zstd&quot;</span><span class="p">)</span>
</span><span id="construct_long_df-742"><a href="#construct_long_df-742"><span class="linenos">742</span></a>
</span><span id="construct_long_df-743"><a href="#construct_long_df-743"><span class="linenos">743</span></a>    <span class="k">return</span> <span class="n">long_df</span>
</span></pre></div>


            <div class="docstring"><p>Function <code><a href="#construct_long_df">construct_long_df()</a></code> constructs a "long" dataframe (or more specifically,
    a Polars LazyFrame query that, when evaluated downstream, will produce a dataframe)
    that lists each mutation in each contig alongside whether it is noncoding, synonymous,
    and nonsynonymous.</p>

<p>Args:
    <code>all_contigs: pl.LazyFrame</code>: A Polars lazyframe that, when queried, will produce
    a dataframe out of all iVar tables merged together.
    <code>gene_df: pl.LazyFrame</code>: A Polars lazyframe that, when queried, will produce a
    dataframe where each row represents an amplicon, its start and stop positions, and
    which gene it is in.
    <code>codon_df: pl.LazyFrame</code>: A Polars lazyframe that, when queried, will be a table of
    nucleotide mutations and associated codons within the protein versions of the gene</p>

<p>Returns:
    <code>pl.LazyFrame</code>: A Polars LazyFrame query that will be evaluated downstream.</p>
</div>


                </section>
                <section id="construct_short_df">
                            <input id="construct_short_df-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">construct_short_df</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">long_df</span><span class="p">:</span> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span>,</span><span class="param">	<span class="n">gene_df</span><span class="p">:</span> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span></span><span class="return-annotation">) -> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span>:</span></span>

                <label class="view-source-button" for="construct_short_df-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#construct_short_df"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="construct_short_df-746"><a href="#construct_short_df-746"><span class="linenos">746</span></a><span class="k">def</span> <span class="nf">construct_short_df</span><span class="p">(</span><span class="n">long_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">gene_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="construct_short_df-747"><a href="#construct_short_df-747"><span class="linenos">747</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="construct_short_df-748"><a href="#construct_short_df-748"><span class="linenos">748</span></a><span class="sd">        Function `construct_short_df()` essentially &quot;pivots&quot; the polars lazyframe produced</span>
</span><span id="construct_short_df-749"><a href="#construct_short_df-749"><span class="linenos">749</span></a><span class="sd">        in `construct_long_df()` such that mutations are stored in comma-delimited list and</span>
</span><span id="construct_short_df-750"><a href="#construct_short_df-750"><span class="linenos">750</span></a><span class="sd">        counts of nucleotide, synonymous, and non-synonymous mutations are added.</span>
</span><span id="construct_short_df-751"><a href="#construct_short_df-751"><span class="linenos">751</span></a>
</span><span id="construct_short_df-752"><a href="#construct_short_df-752"><span class="linenos">752</span></a><span class="sd">    Args:</span>
</span><span id="construct_short_df-753"><a href="#construct_short_df-753"><span class="linenos">753</span></a><span class="sd">        `long_df: pl.LazyFrame`: A Polars lazyframe that, when queried, will produce</span>
</span><span id="construct_short_df-754"><a href="#construct_short_df-754"><span class="linenos">754</span></a><span class="sd">        a long dataframe of all individual mutations in all contigs.</span>
</span><span id="construct_short_df-755"><a href="#construct_short_df-755"><span class="linenos">755</span></a><span class="sd">        `gene_df: pl.LazyFrame`: A Polars lazyframe that, when queried, will produce a</span>
</span><span id="construct_short_df-756"><a href="#construct_short_df-756"><span class="linenos">756</span></a><span class="sd">        dataframe where each row represents an amplicon, its start and stop positions, and</span>
</span><span id="construct_short_df-757"><a href="#construct_short_df-757"><span class="linenos">757</span></a><span class="sd">        which gene it is in.</span>
</span><span id="construct_short_df-758"><a href="#construct_short_df-758"><span class="linenos">758</span></a>
</span><span id="construct_short_df-759"><a href="#construct_short_df-759"><span class="linenos">759</span></a><span class="sd">    Returns:</span>
</span><span id="construct_short_df-760"><a href="#construct_short_df-760"><span class="linenos">760</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame query that will be evaluated downstream.</span>
</span><span id="construct_short_df-761"><a href="#construct_short_df-761"><span class="linenos">761</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="construct_short_df-762"><a href="#construct_short_df-762"><span class="linenos">762</span></a>
</span><span id="construct_short_df-763"><a href="#construct_short_df-763"><span class="linenos">763</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Constructing a pivoted dataframe of all unique contigs from each amplicon.&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-764"><a href="#construct_short_df-764"><span class="linenos">764</span></a>
</span><span id="construct_short_df-765"><a href="#construct_short_df-765"><span class="linenos">765</span></a>    <span class="n">short_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="construct_short_df-766"><a href="#construct_short_df-766"><span class="linenos">766</span></a>        <span class="n">long_df</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-767"><a href="#construct_short_df-767"><span class="linenos">767</span></a>        <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">])</span>
</span><span id="construct_short_df-768"><a href="#construct_short_df-768"><span class="linenos">768</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="construct_short_df-769"><a href="#construct_short_df-769"><span class="linenos">769</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
</span><span id="construct_short_df-770"><a href="#construct_short_df-770"><span class="linenos">770</span></a>                <span class="p">[</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">,</span> <span class="s2">&quot;Sample ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">]</span>
</span><span id="construct_short_df-771"><a href="#construct_short_df-771"><span class="linenos">771</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="construct_short_df-772"><a href="#construct_short_df-772"><span class="linenos">772</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
</span><span id="construct_short_df-773"><a href="#construct_short_df-773"><span class="linenos">773</span></a>                    <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Sample ID&quot;</span><span class="p">)],</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>
</span><span id="construct_short_df-774"><a href="#construct_short_df-774"><span class="linenos">774</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-775"><a href="#construct_short_df-775"><span class="linenos">775</span></a>            <span class="p">),</span>
</span><span id="construct_short_df-776"><a href="#construct_short_df-776"><span class="linenos">776</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-777"><a href="#construct_short_df-777"><span class="linenos">777</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-778"><a href="#construct_short_df-778"><span class="linenos">778</span></a>        <span class="p">)</span>
</span><span id="construct_short_df-779"><a href="#construct_short_df-779"><span class="linenos">779</span></a>        <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="construct_short_df-780"><a href="#construct_short_df-780"><span class="linenos">780</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gene_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-781"><a href="#construct_short_df-781"><span class="linenos">781</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="construct_short_df-782"><a href="#construct_short_df-782"><span class="linenos">782</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="s2">&quot;NUC_SUB&quot;</span><span class="p">])</span>
</span><span id="construct_short_df-783"><a href="#construct_short_df-783"><span class="linenos">783</span></a>            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-784"><a href="#construct_short_df-784"><span class="linenos">784</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">))</span>
</span><span id="construct_short_df-785"><a href="#construct_short_df-785"><span class="linenos">785</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="construct_short_df-786"><a href="#construct_short_df-786"><span class="linenos">786</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Nucleotide Substitutions&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-787"><a href="#construct_short_df-787"><span class="linenos">787</span></a>            <span class="p">)</span>
</span><span id="construct_short_df-788"><a href="#construct_short_df-788"><span class="linenos">788</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">),</span>
</span><span id="construct_short_df-789"><a href="#construct_short_df-789"><span class="linenos">789</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-790"><a href="#construct_short_df-790"><span class="linenos">790</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-791"><a href="#construct_short_df-791"><span class="linenos">791</span></a>        <span class="p">)</span>
</span><span id="construct_short_df-792"><a href="#construct_short_df-792"><span class="linenos">792</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="construct_short_df-793"><a href="#construct_short_df-793"><span class="linenos">793</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="s2">&quot;NUC_SUB&quot;</span><span class="p">])</span>
</span><span id="construct_short_df-794"><a href="#construct_short_df-794"><span class="linenos">794</span></a>            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-795"><a href="#construct_short_df-795"><span class="linenos">795</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</span><span id="construct_short_df-796"><a href="#construct_short_df-796"><span class="linenos">796</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Nuc Mut Count&quot;</span><span class="p">))</span>
</span><span id="construct_short_df-797"><a href="#construct_short_df-797"><span class="linenos">797</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;NUC_SUB&quot;</span><span class="p">),</span>
</span><span id="construct_short_df-798"><a href="#construct_short_df-798"><span class="linenos">798</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-799"><a href="#construct_short_df-799"><span class="linenos">799</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-800"><a href="#construct_short_df-800"><span class="linenos">800</span></a>        <span class="p">)</span>
</span><span id="construct_short_df-801"><a href="#construct_short_df-801"><span class="linenos">801</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="construct_short_df-802"><a href="#construct_short_df-802"><span class="linenos">802</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="s2">&quot;AA_SUB&quot;</span><span class="p">,</span> <span class="s2">&quot;Synonymous&quot;</span><span class="p">])</span>
</span><span id="construct_short_df-803"><a href="#construct_short_df-803"><span class="linenos">803</span></a>            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Synonymous&quot;</span><span class="p">))</span>
</span><span id="construct_short_df-804"><a href="#construct_short_df-804"><span class="linenos">804</span></a>            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-805"><a href="#construct_short_df-805"><span class="linenos">805</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">))</span>
</span><span id="construct_short_df-806"><a href="#construct_short_df-806"><span class="linenos">806</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="construct_short_df-807"><a href="#construct_short_df-807"><span class="linenos">807</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Synonymous Mutations&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-808"><a href="#construct_short_df-808"><span class="linenos">808</span></a>            <span class="p">)</span>
</span><span id="construct_short_df-809"><a href="#construct_short_df-809"><span class="linenos">809</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">),</span>
</span><span id="construct_short_df-810"><a href="#construct_short_df-810"><span class="linenos">810</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-811"><a href="#construct_short_df-811"><span class="linenos">811</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-812"><a href="#construct_short_df-812"><span class="linenos">812</span></a>        <span class="p">)</span>
</span><span id="construct_short_df-813"><a href="#construct_short_df-813"><span class="linenos">813</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="construct_short_df-814"><a href="#construct_short_df-814"><span class="linenos">814</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="s2">&quot;AA_SUB&quot;</span><span class="p">,</span> <span class="s2">&quot;Synonymous&quot;</span><span class="p">])</span>
</span><span id="construct_short_df-815"><a href="#construct_short_df-815"><span class="linenos">815</span></a>            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Synonymous&quot;</span><span class="p">))</span>
</span><span id="construct_short_df-816"><a href="#construct_short_df-816"><span class="linenos">816</span></a>            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-817"><a href="#construct_short_df-817"><span class="linenos">817</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</span><span id="construct_short_df-818"><a href="#construct_short_df-818"><span class="linenos">818</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Syn count&quot;</span><span class="p">))</span>
</span><span id="construct_short_df-819"><a href="#construct_short_df-819"><span class="linenos">819</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">),</span>
</span><span id="construct_short_df-820"><a href="#construct_short_df-820"><span class="linenos">820</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-821"><a href="#construct_short_df-821"><span class="linenos">821</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-822"><a href="#construct_short_df-822"><span class="linenos">822</span></a>        <span class="p">)</span>
</span><span id="construct_short_df-823"><a href="#construct_short_df-823"><span class="linenos">823</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="construct_short_df-824"><a href="#construct_short_df-824"><span class="linenos">824</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="s2">&quot;AA_SUB&quot;</span><span class="p">,</span> <span class="s2">&quot;Nonsynonymous&quot;</span><span class="p">])</span>
</span><span id="construct_short_df-825"><a href="#construct_short_df-825"><span class="linenos">825</span></a>            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Nonsynonymous&quot;</span><span class="p">))</span>
</span><span id="construct_short_df-826"><a href="#construct_short_df-826"><span class="linenos">826</span></a>            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-827"><a href="#construct_short_df-827"><span class="linenos">827</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">))</span>
</span><span id="construct_short_df-828"><a href="#construct_short_df-828"><span class="linenos">828</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="construct_short_df-829"><a href="#construct_short_df-829"><span class="linenos">829</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Nonsynonymous Mutations&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-830"><a href="#construct_short_df-830"><span class="linenos">830</span></a>            <span class="p">)</span>
</span><span id="construct_short_df-831"><a href="#construct_short_df-831"><span class="linenos">831</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">),</span>
</span><span id="construct_short_df-832"><a href="#construct_short_df-832"><span class="linenos">832</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-833"><a href="#construct_short_df-833"><span class="linenos">833</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-834"><a href="#construct_short_df-834"><span class="linenos">834</span></a>        <span class="p">)</span>
</span><span id="construct_short_df-835"><a href="#construct_short_df-835"><span class="linenos">835</span></a>        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="construct_short_df-836"><a href="#construct_short_df-836"><span class="linenos">836</span></a>            <span class="n">long_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="s2">&quot;AA_SUB&quot;</span><span class="p">,</span> <span class="s2">&quot;Nonsynonymous&quot;</span><span class="p">])</span>
</span><span id="construct_short_df-837"><a href="#construct_short_df-837"><span class="linenos">837</span></a>            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Nonsynonymous&quot;</span><span class="p">))</span>
</span><span id="construct_short_df-838"><a href="#construct_short_df-838"><span class="linenos">838</span></a>            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-839"><a href="#construct_short_df-839"><span class="linenos">839</span></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</span><span id="construct_short_df-840"><a href="#construct_short_df-840"><span class="linenos">840</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Nonsyn count&quot;</span><span class="p">))</span>
</span><span id="construct_short_df-841"><a href="#construct_short_df-841"><span class="linenos">841</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;AA_SUB&quot;</span><span class="p">),</span>
</span><span id="construct_short_df-842"><a href="#construct_short_df-842"><span class="linenos">842</span></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-843"><a href="#construct_short_df-843"><span class="linenos">843</span></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="construct_short_df-844"><a href="#construct_short_df-844"><span class="linenos">844</span></a>        <span class="p">)</span>
</span><span id="construct_short_df-845"><a href="#construct_short_df-845"><span class="linenos">845</span></a>        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample&quot;</span><span class="p">)</span>
</span><span id="construct_short_df-846"><a href="#construct_short_df-846"><span class="linenos">846</span></a>        <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="construct_short_df-847"><a href="#construct_short_df-847"><span class="linenos">847</span></a>    <span class="p">)</span>
</span><span id="construct_short_df-848"><a href="#construct_short_df-848"><span class="linenos">848</span></a>
</span><span id="construct_short_df-849"><a href="#construct_short_df-849"><span class="linenos">849</span></a>    <span class="k">return</span> <span class="n">short_df</span>
</span></pre></div>


            <div class="docstring"><p>Function <code><a href="#construct_short_df">construct_short_df()</a></code> essentially "pivots" the polars lazyframe produced
    in <code><a href="#construct_long_df">construct_long_df()</a></code> such that mutations are stored in comma-delimited list and
    counts of nucleotide, synonymous, and non-synonymous mutations are added.</p>

<p>Args:
    <code>long_df: pl.LazyFrame</code>: A Polars lazyframe that, when queried, will produce
    a long dataframe of all individual mutations in all contigs.
    <code>gene_df: pl.LazyFrame</code>: A Polars lazyframe that, when queried, will produce a
    dataframe where each row represents an amplicon, its start and stop positions, and
    which gene it is in.</p>

<p>Returns:
    <code>pl.LazyFrame</code>: A Polars LazyFrame query that will be evaluated downstream.</p>
</div>


                </section>
                <section id="compute_crude_dnds_ratio">
                            <input id="compute_crude_dnds_ratio-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">compute_crude_dnds_ratio</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">short_df</span><span class="p">:</span> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span></span><span class="return-annotation">) -> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span>:</span></span>

                <label class="view-source-button" for="compute_crude_dnds_ratio-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compute_crude_dnds_ratio"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compute_crude_dnds_ratio-852"><a href="#compute_crude_dnds_ratio-852"><span class="linenos">852</span></a><span class="k">def</span> <span class="nf">compute_crude_dnds_ratio</span><span class="p">(</span><span class="n">short_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
</span><span id="compute_crude_dnds_ratio-853"><a href="#compute_crude_dnds_ratio-853"><span class="linenos">853</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compute_crude_dnds_ratio-854"><a href="#compute_crude_dnds_ratio-854"><span class="linenos">854</span></a><span class="sd">        Function `compute_crude_dnds_ratio()` constructs a very crude approximation of</span>
</span><span id="compute_crude_dnds_ratio-855"><a href="#compute_crude_dnds_ratio-855"><span class="linenos">855</span></a><span class="sd">        πN/πS, the ratio of nonsynonymous to synonymous mutations and joins it onto</span>
</span><span id="compute_crude_dnds_ratio-856"><a href="#compute_crude_dnds_ratio-856"><span class="linenos">856</span></a><span class="sd">        the &quot;short&quot; lazyframe from `construct_short_df()`.</span>
</span><span id="compute_crude_dnds_ratio-857"><a href="#compute_crude_dnds_ratio-857"><span class="linenos">857</span></a>
</span><span id="compute_crude_dnds_ratio-858"><a href="#compute_crude_dnds_ratio-858"><span class="linenos">858</span></a><span class="sd">    Args:</span>
</span><span id="compute_crude_dnds_ratio-859"><a href="#compute_crude_dnds_ratio-859"><span class="linenos">859</span></a><span class="sd">        `short_df: pl.LazyFrame`: A Polars lazyframe that, when queried, will produce</span>
</span><span id="compute_crude_dnds_ratio-860"><a href="#compute_crude_dnds_ratio-860"><span class="linenos">860</span></a><span class="sd">        a short dataframe of all contigs, where mutations are comma-separated in a single</span>
</span><span id="compute_crude_dnds_ratio-861"><a href="#compute_crude_dnds_ratio-861"><span class="linenos">861</span></a><span class="sd">        column.</span>
</span><span id="compute_crude_dnds_ratio-862"><a href="#compute_crude_dnds_ratio-862"><span class="linenos">862</span></a>
</span><span id="compute_crude_dnds_ratio-863"><a href="#compute_crude_dnds_ratio-863"><span class="linenos">863</span></a><span class="sd">    Returns:</span>
</span><span id="compute_crude_dnds_ratio-864"><a href="#compute_crude_dnds_ratio-864"><span class="linenos">864</span></a><span class="sd">        `pl.LazyFrame`: A Polars LazyFrame query that will be evaluated downstream.</span>
</span><span id="compute_crude_dnds_ratio-865"><a href="#compute_crude_dnds_ratio-865"><span class="linenos">865</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compute_crude_dnds_ratio-866"><a href="#compute_crude_dnds_ratio-866"><span class="linenos">866</span></a>
</span><span id="compute_crude_dnds_ratio-867"><a href="#compute_crude_dnds_ratio-867"><span class="linenos">867</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Computing a crude dN/dS ratio for each contig in each sample.&quot;</span><span class="p">)</span>
</span><span id="compute_crude_dnds_ratio-868"><a href="#compute_crude_dnds_ratio-868"><span class="linenos">868</span></a>
</span><span id="compute_crude_dnds_ratio-869"><a href="#compute_crude_dnds_ratio-869"><span class="linenos">869</span></a>    <span class="n">new_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="compute_crude_dnds_ratio-870"><a href="#compute_crude_dnds_ratio-870"><span class="linenos">870</span></a>        <span class="n">short_df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="compute_crude_dnds_ratio-871"><a href="#compute_crude_dnds_ratio-871"><span class="linenos">871</span></a>            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Stop Position&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Start Position&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span>
</span><span id="compute_crude_dnds_ratio-872"><a href="#compute_crude_dnds_ratio-872"><span class="linenos">872</span></a>                <span class="s2">&quot;Amplicon Length&quot;</span>
</span><span id="compute_crude_dnds_ratio-873"><a href="#compute_crude_dnds_ratio-873"><span class="linenos">873</span></a>            <span class="p">)</span>
</span><span id="compute_crude_dnds_ratio-874"><a href="#compute_crude_dnds_ratio-874"><span class="linenos">874</span></a>        <span class="p">)</span>
</span><span id="compute_crude_dnds_ratio-875"><a href="#compute_crude_dnds_ratio-875"><span class="linenos">875</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="compute_crude_dnds_ratio-876"><a href="#compute_crude_dnds_ratio-876"><span class="linenos">876</span></a>            <span class="p">(</span>
</span><span id="compute_crude_dnds_ratio-877"><a href="#compute_crude_dnds_ratio-877"><span class="linenos">877</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Nonsyn count&quot;</span><span class="p">)</span>
</span><span id="compute_crude_dnds_ratio-878"><a href="#compute_crude_dnds_ratio-878"><span class="linenos">878</span></a>                <span class="o">/</span> <span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Amplicon Length&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Syn count&quot;</span><span class="p">))</span>
</span><span id="compute_crude_dnds_ratio-879"><a href="#compute_crude_dnds_ratio-879"><span class="linenos">879</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pn&quot;</span><span class="p">)</span>
</span><span id="compute_crude_dnds_ratio-880"><a href="#compute_crude_dnds_ratio-880"><span class="linenos">880</span></a>        <span class="p">)</span>
</span><span id="compute_crude_dnds_ratio-881"><a href="#compute_crude_dnds_ratio-881"><span class="linenos">881</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="compute_crude_dnds_ratio-882"><a href="#compute_crude_dnds_ratio-882"><span class="linenos">882</span></a>            <span class="p">(</span>
</span><span id="compute_crude_dnds_ratio-883"><a href="#compute_crude_dnds_ratio-883"><span class="linenos">883</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Syn count&quot;</span><span class="p">)</span>
</span><span id="compute_crude_dnds_ratio-884"><a href="#compute_crude_dnds_ratio-884"><span class="linenos">884</span></a>                <span class="o">/</span> <span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Amplicon Length&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Nonsyn count&quot;</span><span class="p">))</span>
</span><span id="compute_crude_dnds_ratio-885"><a href="#compute_crude_dnds_ratio-885"><span class="linenos">885</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ps&quot;</span><span class="p">)</span>
</span><span id="compute_crude_dnds_ratio-886"><a href="#compute_crude_dnds_ratio-886"><span class="linenos">886</span></a>        <span class="p">)</span>
</span><span id="compute_crude_dnds_ratio-887"><a href="#compute_crude_dnds_ratio-887"><span class="linenos">887</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="o">-</span><span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;pn&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">log</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;dn&quot;</span><span class="p">))</span>
</span><span id="compute_crude_dnds_ratio-888"><a href="#compute_crude_dnds_ratio-888"><span class="linenos">888</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="o">-</span><span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ps&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">log</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ds&quot;</span><span class="p">))</span>
</span><span id="compute_crude_dnds_ratio-889"><a href="#compute_crude_dnds_ratio-889"><span class="linenos">889</span></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dn&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ds&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Crude dN/dS Ratio&quot;</span><span class="p">))</span>
</span><span id="compute_crude_dnds_ratio-890"><a href="#compute_crude_dnds_ratio-890"><span class="linenos">890</span></a>        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;pn&quot;</span><span class="p">,</span> <span class="s2">&quot;ps&quot;</span><span class="p">,</span> <span class="s2">&quot;dn&quot;</span><span class="p">,</span> <span class="s2">&quot;ds&quot;</span><span class="p">)</span>
</span><span id="compute_crude_dnds_ratio-891"><a href="#compute_crude_dnds_ratio-891"><span class="linenos">891</span></a>        <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="compute_crude_dnds_ratio-892"><a href="#compute_crude_dnds_ratio-892"><span class="linenos">892</span></a>    <span class="p">)</span>
</span><span id="compute_crude_dnds_ratio-893"><a href="#compute_crude_dnds_ratio-893"><span class="linenos">893</span></a>
</span><span id="compute_crude_dnds_ratio-894"><a href="#compute_crude_dnds_ratio-894"><span class="linenos">894</span></a>    <span class="k">return</span> <span class="n">new_df</span>
</span></pre></div>


            <div class="docstring"><p>Function <code><a href="#compute_crude_dnds_ratio">compute_crude_dnds_ratio()</a></code> constructs a very crude approximation of
    πN/πS, the ratio of nonsynonymous to synonymous mutations and joins it onto
    the "short" lazyframe from <code><a href="#construct_short_df">construct_short_df()</a></code>.</p>

<p>Args:
    <code>short_df: pl.LazyFrame</code>: A Polars lazyframe that, when queried, will produce
    a short dataframe of all contigs, where mutations are comma-separated in a single
    column.</p>

<p>Returns:
    <code>pl.LazyFrame</code>: A Polars LazyFrame query that will be evaluated downstream.</p>
</div>


                </section>
                <section id="assign_haplotype_names">
                            <input id="assign_haplotype_names-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">assign_haplotype_names</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">unnamed_df</span><span class="p">:</span> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span></span><span class="return-annotation">) -> <span class="n">polars</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="assign_haplotype_names-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#assign_haplotype_names"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="assign_haplotype_names-897"><a href="#assign_haplotype_names-897"><span class="linenos">897</span></a><span class="k">def</span> <span class="nf">assign_haplotype_names</span><span class="p">(</span><span class="n">unnamed_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="assign_haplotype_names-898"><a href="#assign_haplotype_names-898"><span class="linenos">898</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="assign_haplotype_names-899"><a href="#assign_haplotype_names-899"><span class="linenos">899</span></a><span class="sd">        Function `assign_haplotype_names()` sorts haplotypes/contigs within each sample</span>
</span><span id="assign_haplotype_names-900"><a href="#assign_haplotype_names-900"><span class="linenos">900</span></a><span class="sd">        in descending order by how well-supported by reads they are. It then gives those</span>
</span><span id="assign_haplotype_names-901"><a href="#assign_haplotype_names-901"><span class="linenos">901</span></a><span class="sd">        sorted haplotypes a name based on their frequences.</span>
</span><span id="assign_haplotype_names-902"><a href="#assign_haplotype_names-902"><span class="linenos">902</span></a>
</span><span id="assign_haplotype_names-903"><a href="#assign_haplotype_names-903"><span class="linenos">903</span></a><span class="sd">    Args:</span>
</span><span id="assign_haplotype_names-904"><a href="#assign_haplotype_names-904"><span class="linenos">904</span></a><span class="sd">        `unnamed_df: pl.LazyFrame`: A Polars lazyframe that, when queried, will produce</span>
</span><span id="assign_haplotype_names-905"><a href="#assign_haplotype_names-905"><span class="linenos">905</span></a><span class="sd">        a short dataframe of all contigs, where mutations are comma-separated in a single</span>
</span><span id="assign_haplotype_names-906"><a href="#assign_haplotype_names-906"><span class="linenos">906</span></a><span class="sd">        column, along with crude N/S ratios.</span>
</span><span id="assign_haplotype_names-907"><a href="#assign_haplotype_names-907"><span class="linenos">907</span></a>
</span><span id="assign_haplotype_names-908"><a href="#assign_haplotype_names-908"><span class="linenos">908</span></a><span class="sd">    Returns:</span>
</span><span id="assign_haplotype_names-909"><a href="#assign_haplotype_names-909"><span class="linenos">909</span></a><span class="sd">        `pl.DataFrame`: A collected Polars DataFrame with complete information for</span>
</span><span id="assign_haplotype_names-910"><a href="#assign_haplotype_names-910"><span class="linenos">910</span></a><span class="sd">        reporting.</span>
</span><span id="assign_haplotype_names-911"><a href="#assign_haplotype_names-911"><span class="linenos">911</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="assign_haplotype_names-912"><a href="#assign_haplotype_names-912"><span class="linenos">912</span></a>
</span><span id="assign_haplotype_names-913"><a href="#assign_haplotype_names-913"><span class="linenos">913</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Assigning names to each putative haplotype based on their frequencies.&quot;</span><span class="p">)</span>
</span><span id="assign_haplotype_names-914"><a href="#assign_haplotype_names-914"><span class="linenos">914</span></a>
</span><span id="assign_haplotype_names-915"><a href="#assign_haplotype_names-915"><span class="linenos">915</span></a>    <span class="n">sample_amp_dfs</span> <span class="o">=</span> <span class="n">unnamed_df</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">partition_by</span><span class="p">(</span>
</span><span id="assign_haplotype_names-916"><a href="#assign_haplotype_names-916"><span class="linenos">916</span></a>        <span class="s2">&quot;Amplicon&quot;</span><span class="p">,</span> <span class="s2">&quot;Sample ID&quot;</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">False</span>
</span><span id="assign_haplotype_names-917"><a href="#assign_haplotype_names-917"><span class="linenos">917</span></a>    <span class="p">)</span>
</span><span id="assign_haplotype_names-918"><a href="#assign_haplotype_names-918"><span class="linenos">918</span></a>
</span><span id="assign_haplotype_names-919"><a href="#assign_haplotype_names-919"><span class="linenos">919</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Naming each haplotype.&quot;</span><span class="p">)</span>
</span><span id="assign_haplotype_names-920"><a href="#assign_haplotype_names-920"><span class="linenos">920</span></a>
</span><span id="assign_haplotype_names-921"><a href="#assign_haplotype_names-921"><span class="linenos">921</span></a>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_amp_dfs</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="assign_haplotype_names-922"><a href="#assign_haplotype_names-922"><span class="linenos">922</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_amp_dfs</span><span class="p">):</span>
</span><span id="assign_haplotype_names-923"><a href="#assign_haplotype_names-923"><span class="linenos">923</span></a>        <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="assign_haplotype_names-924"><a href="#assign_haplotype_names-924"><span class="linenos">924</span></a>        <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
</span><span id="assign_haplotype_names-925"><a href="#assign_haplotype_names-925"><span class="linenos">925</span></a>        <span class="n">new_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Haplotype&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span>
</span><span id="assign_haplotype_names-926"><a href="#assign_haplotype_names-926"><span class="linenos">926</span></a>        <span class="n">new_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="assign_haplotype_names-927"><a href="#assign_haplotype_names-927"><span class="linenos">927</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="assign_haplotype_names-928"><a href="#assign_haplotype_names-928"><span class="linenos">928</span></a>            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;Depth of Coverage&quot;</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="assign_haplotype_names-929"><a href="#assign_haplotype_names-929"><span class="linenos">929</span></a>            <span class="o">.</span><span class="n">with_row_count</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="assign_haplotype_names-930"><a href="#assign_haplotype_names-930"><span class="linenos">930</span></a>            <span class="o">.</span><span class="n">cast</span><span class="p">({</span><span class="s2">&quot;row_nr&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">})</span>
</span><span id="assign_haplotype_names-931"><a href="#assign_haplotype_names-931"><span class="linenos">931</span></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
</span><span id="assign_haplotype_names-932"><a href="#assign_haplotype_names-932"><span class="linenos">932</span></a>                <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
</span><span id="assign_haplotype_names-933"><a href="#assign_haplotype_names-933"><span class="linenos">933</span></a>                    <span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Amplicon&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Haplotype&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;row_nr&quot;</span><span class="p">)],</span>
</span><span id="assign_haplotype_names-934"><a href="#assign_haplotype_names-934"><span class="linenos">934</span></a>                    <span class="n">separator</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span>
</span><span id="assign_haplotype_names-935"><a href="#assign_haplotype_names-935"><span class="linenos">935</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Haplotype&quot;</span><span class="p">)</span>
</span><span id="assign_haplotype_names-936"><a href="#assign_haplotype_names-936"><span class="linenos">936</span></a>            <span class="p">)</span>
</span><span id="assign_haplotype_names-937"><a href="#assign_haplotype_names-937"><span class="linenos">937</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;row_nr&quot;</span><span class="p">)</span>
</span><span id="assign_haplotype_names-938"><a href="#assign_haplotype_names-938"><span class="linenos">938</span></a>            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">new_cols</span><span class="p">)</span>
</span><span id="assign_haplotype_names-939"><a href="#assign_haplotype_names-939"><span class="linenos">939</span></a>        <span class="p">)</span>
</span><span id="assign_haplotype_names-940"><a href="#assign_haplotype_names-940"><span class="linenos">940</span></a>        <span class="n">sample_amp_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_df</span>
</span><span id="assign_haplotype_names-941"><a href="#assign_haplotype_names-941"><span class="linenos">941</span></a>    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="assign_haplotype_names-942"><a href="#assign_haplotype_names-942"><span class="linenos">942</span></a>
</span><span id="assign_haplotype_names-943"><a href="#assign_haplotype_names-943"><span class="linenos">943</span></a>    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sample_amp_dfs</span><span class="p">,</span> <span class="n">rechunk</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="assign_haplotype_names-944"><a href="#assign_haplotype_names-944"><span class="linenos">944</span></a>
</span><span id="assign_haplotype_names-945"><a href="#assign_haplotype_names-945"><span class="linenos">945</span></a>    <span class="k">return</span> <span class="n">final_df</span>
</span></pre></div>


            <div class="docstring"><p>Function <code><a href="#assign_haplotype_names">assign_haplotype_names()</a></code> sorts haplotypes/contigs within each sample
    in descending order by how well-supported by reads they are. It then gives those
    sorted haplotypes a name based on their frequences.</p>

<p>Args:
    <code>unnamed_df: pl.LazyFrame</code>: A Polars lazyframe that, when queried, will produce
    a short dataframe of all contigs, where mutations are comma-separated in a single
    column, along with crude N/S ratios.</p>

<p>Returns:
    <code>pl.DataFrame</code>: A collected Polars DataFrame with complete information for
    reporting.</p>
</div>


                </section>
                <section id="aggregate_haplotype_df">
                            <input id="aggregate_haplotype_df-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">aggregate_haplotype_df</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">long_contigs</span><span class="p">:</span> <span class="n">polars</span><span class="o">.</span><span class="n">lazyframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">LazyFrame</span>,</span><span class="param">	<span class="n">tvcf_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span>,</span><span class="param">	<span class="n">clean_fasta_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span>,</span><span class="param">	<span class="n">gene_bed</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span>,</span><span class="param">	<span class="n">config</span><span class="p">:</span> <span class="n"><a href="#ConfigParams">ConfigParams</a></span>,</span><span class="param">	<span class="n">whether_resume</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">) -> <span class="n">polars</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="aggregate_haplotype_df-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#aggregate_haplotype_df"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="aggregate_haplotype_df-948"><a href="#aggregate_haplotype_df-948"><span class="linenos"> 948</span></a><span class="k">def</span> <span class="nf">aggregate_haplotype_df</span><span class="p">(</span>
</span><span id="aggregate_haplotype_df-949"><a href="#aggregate_haplotype_df-949"><span class="linenos"> 949</span></a>    <span class="n">long_contigs</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
</span><span id="aggregate_haplotype_df-950"><a href="#aggregate_haplotype_df-950"><span class="linenos"> 950</span></a>    <span class="n">tvcf_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span>
</span><span id="aggregate_haplotype_df-951"><a href="#aggregate_haplotype_df-951"><span class="linenos"> 951</span></a>    <span class="n">clean_fasta_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span>
</span><span id="aggregate_haplotype_df-952"><a href="#aggregate_haplotype_df-952"><span class="linenos"> 952</span></a>    <span class="n">gene_bed</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
</span><span id="aggregate_haplotype_df-953"><a href="#aggregate_haplotype_df-953"><span class="linenos"> 953</span></a>    <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParams</span><span class="p">,</span>
</span><span id="aggregate_haplotype_df-954"><a href="#aggregate_haplotype_df-954"><span class="linenos"> 954</span></a>    <span class="n">whether_resume</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="aggregate_haplotype_df-955"><a href="#aggregate_haplotype_df-955"><span class="linenos"> 955</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="aggregate_haplotype_df-956"><a href="#aggregate_haplotype_df-956"><span class="linenos"> 956</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="aggregate_haplotype_df-957"><a href="#aggregate_haplotype_df-957"><span class="linenos"> 957</span></a><span class="sd">        Function `aggregate_haplotype_df()` oversees the construction of a final</span>
</span><span id="aggregate_haplotype_df-958"><a href="#aggregate_haplotype_df-958"><span class="linenos"> 958</span></a><span class="sd">        dataframe, which will be reported out as an intricately sorted Excel file.</span>
</span><span id="aggregate_haplotype_df-959"><a href="#aggregate_haplotype_df-959"><span class="linenos"> 959</span></a>
</span><span id="aggregate_haplotype_df-960"><a href="#aggregate_haplotype_df-960"><span class="linenos"> 960</span></a><span class="sd">    Args:</span>
</span><span id="aggregate_haplotype_df-961"><a href="#aggregate_haplotype_df-961"><span class="linenos"> 961</span></a><span class="sd">        `long_contigs: pl.LazyFrame`: A Polars LazyFrame query that was amassed</span>
</span><span id="aggregate_haplotype_df-962"><a href="#aggregate_haplotype_df-962"><span class="linenos"> 962</span></a><span class="sd">        from many iVar tables.</span>
</span><span id="aggregate_haplotype_df-963"><a href="#aggregate_haplotype_df-963"><span class="linenos"> 963</span></a><span class="sd">        `clean_fasta_list: List[Path]`: A list of Pathlib Paths pointing toward</span>
</span><span id="aggregate_haplotype_df-964"><a href="#aggregate_haplotype_df-964"><span class="linenos"> 964</span></a><span class="sd">        any number of FASTA files.</span>
</span><span id="aggregate_haplotype_df-965"><a href="#aggregate_haplotype_df-965"><span class="linenos"> 965</span></a><span class="sd">        `gene_bed: Path`: A Pathlib Path type pointing to the location of a BED file</span>
</span><span id="aggregate_haplotype_df-966"><a href="#aggregate_haplotype_df-966"><span class="linenos"> 966</span></a><span class="sd">        with of all primers, which must contain start and stop positions for each primer,</span>
</span><span id="aggregate_haplotype_df-967"><a href="#aggregate_haplotype_df-967"><span class="linenos"> 967</span></a><span class="sd">        amplicon names, and genes</span>
</span><span id="aggregate_haplotype_df-968"><a href="#aggregate_haplotype_df-968"><span class="linenos"> 968</span></a>
</span><span id="aggregate_haplotype_df-969"><a href="#aggregate_haplotype_df-969"><span class="linenos"> 969</span></a><span class="sd">    Returns:</span>
</span><span id="aggregate_haplotype_df-970"><a href="#aggregate_haplotype_df-970"><span class="linenos"> 970</span></a><span class="sd">        `pl.DataFrame`: A fully evaluated Polars dataframe that can be written</span>
</span><span id="aggregate_haplotype_df-971"><a href="#aggregate_haplotype_df-971"><span class="linenos"> 971</span></a><span class="sd">        out as an excel file.</span>
</span><span id="aggregate_haplotype_df-972"><a href="#aggregate_haplotype_df-972"><span class="linenos"> 972</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="aggregate_haplotype_df-973"><a href="#aggregate_haplotype_df-973"><span class="linenos"> 973</span></a>
</span><span id="aggregate_haplotype_df-974"><a href="#aggregate_haplotype_df-974"><span class="linenos"> 974</span></a>    <span class="n">ic</span><span class="p">(</span>
</span><span id="aggregate_haplotype_df-975"><a href="#aggregate_haplotype_df-975"><span class="linenos"> 975</span></a>        <span class="s2">&quot;Running function that manages the many steps of aggregating the haplotype table.&quot;</span>
</span><span id="aggregate_haplotype_df-976"><a href="#aggregate_haplotype_df-976"><span class="linenos"> 976</span></a>    <span class="p">)</span>
</span><span id="aggregate_haplotype_df-977"><a href="#aggregate_haplotype_df-977"><span class="linenos"> 977</span></a>
</span><span id="aggregate_haplotype_df-978"><a href="#aggregate_haplotype_df-978"><span class="linenos"> 978</span></a>    <span class="c1"># construct data frame mapping genes to amplicons</span>
</span><span id="aggregate_haplotype_df-979"><a href="#aggregate_haplotype_df-979"><span class="linenos"> 979</span></a>    <span class="n">gene_df</span> <span class="o">=</span> <span class="n">generate_gene_df</span><span class="p">(</span><span class="n">gene_bed</span><span class="p">)</span>
</span><span id="aggregate_haplotype_df-980"><a href="#aggregate_haplotype_df-980"><span class="linenos"> 980</span></a>
</span><span id="aggregate_haplotype_df-981"><a href="#aggregate_haplotype_df-981"><span class="linenos"> 981</span></a>    <span class="c1"># construct a codon table for all mutations</span>
</span><span id="aggregate_haplotype_df-982"><a href="#aggregate_haplotype_df-982"><span class="linenos"> 982</span></a>    <span class="n">codon_df</span> <span class="o">=</span> <span class="n">compile_mutation_codons</span><span class="p">(</span><span class="n">tvcf_list</span><span class="p">,</span> <span class="n">whether_resume</span><span class="p">)</span>
</span><span id="aggregate_haplotype_df-983"><a href="#aggregate_haplotype_df-983"><span class="linenos"> 983</span></a>
</span><span id="aggregate_haplotype_df-984"><a href="#aggregate_haplotype_df-984"><span class="linenos"> 984</span></a>    <span class="c1"># construct long dataframe</span>
</span><span id="aggregate_haplotype_df-985"><a href="#aggregate_haplotype_df-985"><span class="linenos"> 985</span></a>    <span class="n">long_df</span> <span class="o">=</span> <span class="n">construct_long_df</span><span class="p">(</span><span class="n">long_contigs</span><span class="p">,</span> <span class="n">gene_df</span><span class="p">,</span> <span class="n">codon_df</span><span class="p">)</span>
</span><span id="aggregate_haplotype_df-986"><a href="#aggregate_haplotype_df-986"><span class="linenos"> 986</span></a>
</span><span id="aggregate_haplotype_df-987"><a href="#aggregate_haplotype_df-987"><span class="linenos"> 987</span></a>    <span class="c1"># aggregate into short dataframe</span>
</span><span id="aggregate_haplotype_df-988"><a href="#aggregate_haplotype_df-988"><span class="linenos"> 988</span></a>    <span class="n">short_df</span> <span class="o">=</span> <span class="n">construct_short_df</span><span class="p">(</span><span class="n">long_df</span><span class="p">,</span> <span class="n">gene_df</span><span class="p">)</span>
</span><span id="aggregate_haplotype_df-989"><a href="#aggregate_haplotype_df-989"><span class="linenos"> 989</span></a>
</span><span id="aggregate_haplotype_df-990"><a href="#aggregate_haplotype_df-990"><span class="linenos"> 990</span></a>    <span class="c1"># Compile depths from contig FASTA files</span>
</span><span id="aggregate_haplotype_df-991"><a href="#aggregate_haplotype_df-991"><span class="linenos"> 991</span></a>    <span class="n">depth_df</span> <span class="o">=</span> <span class="n">compile_contig_depths</span><span class="p">(</span><span class="n">clean_fasta_list</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="aggregate_haplotype_df-992"><a href="#aggregate_haplotype_df-992"><span class="linenos"> 992</span></a>
</span><span id="aggregate_haplotype_df-993"><a href="#aggregate_haplotype_df-993"><span class="linenos"> 993</span></a>    <span class="c1"># add FASTA information about depth of coverage per-contig consensus</span>
</span><span id="aggregate_haplotype_df-994"><a href="#aggregate_haplotype_df-994"><span class="linenos"> 994</span></a>    <span class="c1"># onto the lazyframe with a join</span>
</span><span id="aggregate_haplotype_df-995"><a href="#aggregate_haplotype_df-995"><span class="linenos"> 995</span></a>    <span class="n">ic</span><span class="p">(</span><span class="s2">&quot;Joining per-contig depth information.&quot;</span><span class="p">)</span>
</span><span id="aggregate_haplotype_df-996"><a href="#aggregate_haplotype_df-996"><span class="linenos"> 996</span></a>    <span class="n">short_df_with_depth</span> <span class="o">=</span> <span class="n">short_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="aggregate_haplotype_df-997"><a href="#aggregate_haplotype_df-997"><span class="linenos"> 997</span></a>        <span class="n">depth_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
</span><span id="aggregate_haplotype_df-998"><a href="#aggregate_haplotype_df-998"><span class="linenos"> 998</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Depth of Coverage&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">())</span>
</span><span id="aggregate_haplotype_df-999"><a href="#aggregate_haplotype_df-999"><span class="linenos"> 999</span></a>
</span><span id="aggregate_haplotype_df-1000"><a href="#aggregate_haplotype_df-1000"><span class="linenos">1000</span></a>    <span class="c1"># generate crude dn/ds ratios</span>
</span><span id="aggregate_haplotype_df-1001"><a href="#aggregate_haplotype_df-1001"><span class="linenos">1001</span></a>    <span class="n">ratio_df</span> <span class="o">=</span> <span class="n">compute_crude_dnds_ratio</span><span class="p">(</span><span class="n">short_df_with_depth</span><span class="p">)</span>
</span><span id="aggregate_haplotype_df-1002"><a href="#aggregate_haplotype_df-1002"><span class="linenos">1002</span></a>
</span><span id="aggregate_haplotype_df-1003"><a href="#aggregate_haplotype_df-1003"><span class="linenos">1003</span></a>    <span class="c1"># Dynamically assign haplotype names per amplicon-sample combination</span>
</span><span id="aggregate_haplotype_df-1004"><a href="#aggregate_haplotype_df-1004"><span class="linenos">1004</span></a>    <span class="n">final_df</span> <span class="o">=</span> <span class="n">assign_haplotype_names</span><span class="p">(</span><span class="n">ratio_df</span><span class="p">)</span>
</span><span id="aggregate_haplotype_df-1005"><a href="#aggregate_haplotype_df-1005"><span class="linenos">1005</span></a>
</span><span id="aggregate_haplotype_df-1006"><a href="#aggregate_haplotype_df-1006"><span class="linenos">1006</span></a>    <span class="k">return</span> <span class="n">final_df</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
</span><span id="aggregate_haplotype_df-1007"><a href="#aggregate_haplotype_df-1007"><span class="linenos">1007</span></a>        <span class="s2">&quot;Sample ID&quot;</span><span class="p">,</span>
</span><span id="aggregate_haplotype_df-1008"><a href="#aggregate_haplotype_df-1008"><span class="linenos">1008</span></a>        <span class="s2">&quot;Start Position&quot;</span><span class="p">,</span>
</span><span id="aggregate_haplotype_df-1009"><a href="#aggregate_haplotype_df-1009"><span class="linenos">1009</span></a>        <span class="s2">&quot;Depth of Coverage&quot;</span><span class="p">,</span>
</span><span id="aggregate_haplotype_df-1010"><a href="#aggregate_haplotype_df-1010"><span class="linenos">1010</span></a>        <span class="s2">&quot;Nonsyn count&quot;</span><span class="p">,</span>
</span><span id="aggregate_haplotype_df-1011"><a href="#aggregate_haplotype_df-1011"><span class="linenos">1011</span></a>        <span class="n">descending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
</span><span id="aggregate_haplotype_df-1012"><a href="#aggregate_haplotype_df-1012"><span class="linenos">1012</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Amplicon-Sample-Contig&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Function <code><a href="#aggregate_haplotype_df">aggregate_haplotype_df()</a></code> oversees the construction of a final
    dataframe, which will be reported out as an intricately sorted Excel file.</p>

<p>Args:
    <code>long_contigs: pl.LazyFrame</code>: A Polars LazyFrame query that was amassed
    from many iVar tables.
    <code>clean_fasta_list: List[Path]</code>: A list of Pathlib Paths pointing toward
    any number of FASTA files.
    <code>gene_bed: Path</code>: A Pathlib Path type pointing to the location of a BED file
    with of all primers, which must contain start and stop positions for each primer,
    amplicon names, and genes</p>

<p>Returns:
    <code>pl.DataFrame</code>: A fully evaluated Polars dataframe that can be written
    out as an excel file.</p>
</div>


                </section>
                <section id="main">
                            <input id="main-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">main</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="main-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#main"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="main-1015"><a href="#main-1015"><span class="linenos">1015</span></a><span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="main-1016"><a href="#main-1016"><span class="linenos">1016</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="main-1017"><a href="#main-1017"><span class="linenos">1017</span></a><span class="sd">    Main coordinates the flow of data through the functions defined in `read_zap_report.py`.</span>
</span><span id="main-1018"><a href="#main-1018"><span class="linenos">1018</span></a><span class="sd">    It also handles errors and error messages so that the script can be debugged without</span>
</span><span id="main-1019"><a href="#main-1019"><span class="linenos">1019</span></a><span class="sd">    long tracebacks.</span>
</span><span id="main-1020"><a href="#main-1020"><span class="linenos">1020</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="main-1021"><a href="#main-1021"><span class="linenos">1021</span></a>
</span><span id="main-1022"><a href="#main-1022"><span class="linenos">1022</span></a>    <span class="c1"># parse command line arguments while handling any errors</span>
</span><span id="main-1023"><a href="#main-1023"><span class="linenos">1023</span></a>    <span class="n">args_result</span> <span class="o">=</span> <span class="n">parse_command_line_args</span><span class="p">()</span>
</span><span id="main-1024"><a href="#main-1024"><span class="linenos">1024</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args_result</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="main-1025"><a href="#main-1025"><span class="linenos">1025</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
</span><span id="main-1026"><a href="#main-1026"><span class="linenos">1026</span></a>            <span class="sa">f</span><span class="s2">&quot;Command line argument parsing encountered an error.</span><span class="se">\n</span><span class="si">{</span><span class="n">args_result</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="main-1027"><a href="#main-1027"><span class="linenos">1027</span></a>        <span class="p">)</span>
</span><span id="main-1028"><a href="#main-1028"><span class="linenos">1028</span></a>    <span class="n">results_dir</span> <span class="o">=</span> <span class="n">args_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">results_dir</span>
</span><span id="main-1029"><a href="#main-1029"><span class="linenos">1029</span></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">args_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">config</span>
</span><span id="main-1030"><a href="#main-1030"><span class="linenos">1030</span></a>    <span class="n">gene_bed</span> <span class="o">=</span> <span class="n">args_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">gene_bed</span>
</span><span id="main-1031"><a href="#main-1031"><span class="linenos">1031</span></a>    <span class="n">whether_resume</span> <span class="o">=</span> <span class="n">args_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">resume</span>
</span><span id="main-1032"><a href="#main-1032"><span class="linenos">1032</span></a>
</span><span id="main-1033"><a href="#main-1033"><span class="linenos">1033</span></a>    <span class="c1"># parse configurations from the config YAML file</span>
</span><span id="main-1034"><a href="#main-1034"><span class="linenos">1034</span></a>    <span class="n">config_result</span> <span class="o">=</span> <span class="n">parse_configurations</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="main-1035"><a href="#main-1035"><span class="linenos">1035</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_result</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="main-1036"><a href="#main-1036"><span class="linenos">1036</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
</span><span id="main-1037"><a href="#main-1037"><span class="linenos">1037</span></a>            <span class="sa">f</span><span class="s2">&quot;Config file parsing parsing encountered an error.</span><span class="se">\n</span><span class="si">{</span><span class="n">config_result</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="main-1038"><a href="#main-1038"><span class="linenos">1038</span></a>        <span class="p">)</span>
</span><span id="main-1039"><a href="#main-1039"><span class="linenos">1039</span></a>
</span><span id="main-1040"><a href="#main-1040"><span class="linenos">1040</span></a>    <span class="c1"># collect all necessary file lists</span>
</span><span id="main-1041"><a href="#main-1041"><span class="linenos">1041</span></a>    <span class="n">collect_results</span> <span class="o">=</span> <span class="n">collect_file_lists</span><span class="p">(</span>
</span><span id="main-1042"><a href="#main-1042"><span class="linenos">1042</span></a>        <span class="n">results_dir</span><span class="p">,</span>
</span><span id="main-1043"><a href="#main-1043"><span class="linenos">1043</span></a>        <span class="n">config_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">ivar_pattern</span><span class="p">,</span>
</span><span id="main-1044"><a href="#main-1044"><span class="linenos">1044</span></a>        <span class="n">config_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">fasta_pattern</span><span class="p">,</span>
</span><span id="main-1045"><a href="#main-1045"><span class="linenos">1045</span></a>        <span class="n">config_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">tidyvcf_pattern</span><span class="p">,</span>
</span><span id="main-1046"><a href="#main-1046"><span class="linenos">1046</span></a>    <span class="p">)</span>
</span><span id="main-1047"><a href="#main-1047"><span class="linenos">1047</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collect_results</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="main-1048"><a href="#main-1048"><span class="linenos">1048</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
</span><span id="main-1049"><a href="#main-1049"><span class="linenos">1049</span></a>            <span class="sa">f</span><span class="s2">&quot;Glob-based file listing encountered an error.</span><span class="se">\n</span><span class="si">{</span><span class="n">collect_results</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="main-1050"><a href="#main-1050"><span class="linenos">1050</span></a>        <span class="p">)</span>
</span><span id="main-1051"><a href="#main-1051"><span class="linenos">1051</span></a>    <span class="c1"># pylint: disable-next=assignment-from-no-return</span>
</span><span id="main-1052"><a href="#main-1052"><span class="linenos">1052</span></a>    <span class="n">clean_ivar_list</span><span class="p">,</span> <span class="n">clean_fasta_list</span><span class="p">,</span> <span class="n">clean_tvcf_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>
</span><span id="main-1053"><a href="#main-1053"><span class="linenos">1053</span></a>
</span><span id="main-1054"><a href="#main-1054"><span class="linenos">1054</span></a>    <span class="c1"># compile all files into one Polars LazyFrame to be queried downstream</span>
</span><span id="main-1055"><a href="#main-1055"><span class="linenos">1055</span></a>    <span class="n">all_contigs_result</span> <span class="o">=</span> <span class="n">compile_data_with_io</span><span class="p">(</span>
</span><span id="main-1056"><a href="#main-1056"><span class="linenos">1056</span></a>        <span class="n">clean_ivar_list</span><span class="p">,</span> <span class="n">config_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(),</span> <span class="n">whether_resume</span>
</span><span id="main-1057"><a href="#main-1057"><span class="linenos">1057</span></a>    <span class="p">)</span>
</span><span id="main-1058"><a href="#main-1058"><span class="linenos">1058</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_contigs_result</span><span class="p">,</span> <span class="n">Err</span><span class="p">):</span>
</span><span id="main-1059"><a href="#main-1059"><span class="linenos">1059</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
</span><span id="main-1060"><a href="#main-1060"><span class="linenos">1060</span></a>            <span class="sa">f</span><span class="s2">&quot;A dataframe could not be compiled.</span><span class="se">\n</span><span class="si">{</span><span class="n">all_contigs_result</span><span class="o">.</span><span class="n">unwrap_err</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="main-1061"><a href="#main-1061"><span class="linenos">1061</span></a>        <span class="p">)</span>
</span><span id="main-1062"><a href="#main-1062"><span class="linenos">1062</span></a>
</span><span id="main-1063"><a href="#main-1063"><span class="linenos">1063</span></a>    <span class="c1"># aggregate a dataframe containing information to be reported out for review</span>
</span><span id="main-1064"><a href="#main-1064"><span class="linenos">1064</span></a>    <span class="n">final_df</span> <span class="o">=</span> <span class="n">aggregate_haplotype_df</span><span class="p">(</span>
</span><span id="main-1065"><a href="#main-1065"><span class="linenos">1065</span></a>        <span class="n">all_contigs_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(),</span>
</span><span id="main-1066"><a href="#main-1066"><span class="linenos">1066</span></a>        <span class="n">clean_tvcf_list</span><span class="p">,</span>
</span><span id="main-1067"><a href="#main-1067"><span class="linenos">1067</span></a>        <span class="n">clean_fasta_list</span><span class="p">,</span>
</span><span id="main-1068"><a href="#main-1068"><span class="linenos">1068</span></a>        <span class="n">gene_bed</span><span class="p">,</span>
</span><span id="main-1069"><a href="#main-1069"><span class="linenos">1069</span></a>        <span class="n">config_result</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(),</span>
</span><span id="main-1070"><a href="#main-1070"><span class="linenos">1070</span></a>        <span class="n">whether_resume</span><span class="p">,</span>
</span><span id="main-1071"><a href="#main-1071"><span class="linenos">1071</span></a>    <span class="p">)</span>
</span><span id="main-1072"><a href="#main-1072"><span class="linenos">1072</span></a>
</span><span id="main-1073"><a href="#main-1073"><span class="linenos">1073</span></a>    <span class="c1"># Sort the lazyframe first by contig frequency and then by position/amplicon</span>
</span><span id="main-1074"><a href="#main-1074"><span class="linenos">1074</span></a>    <span class="n">final_df</span><span class="o">.</span><span class="n">write_excel</span><span class="p">(</span>
</span><span id="main-1075"><a href="#main-1075"><span class="linenos">1075</span></a>        <span class="s2">&quot;final_report.xlsx&quot;</span><span class="p">,</span>
</span><span id="main-1076"><a href="#main-1076"><span class="linenos">1076</span></a>        <span class="n">autofit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="main-1077"><a href="#main-1077"><span class="linenos">1077</span></a>        <span class="n">freeze_panes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="main-1078"><a href="#main-1078"><span class="linenos">1078</span></a>        <span class="n">header_format</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;bold&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span id="main-1079"><a href="#main-1079"><span class="linenos">1079</span></a>        <span class="n">conditional_formats</span><span class="o">=</span><span class="p">{</span>
</span><span id="main-1080"><a href="#main-1080"><span class="linenos">1080</span></a>            <span class="s2">&quot;Crude dN/dS Ratio&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="main-1081"><a href="#main-1081"><span class="linenos">1081</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;3_color_scale&quot;</span><span class="p">,</span>
</span><span id="main-1082"><a href="#main-1082"><span class="linenos">1082</span></a>                <span class="s2">&quot;mid_value&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="main-1083"><a href="#main-1083"><span class="linenos">1083</span></a>                <span class="s2">&quot;min_value&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="main-1084"><a href="#main-1084"><span class="linenos">1084</span></a>                <span class="s2">&quot;mid_color&quot;</span><span class="p">:</span> <span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span>
</span><span id="main-1085"><a href="#main-1085"><span class="linenos">1085</span></a>            <span class="p">}</span>
</span><span id="main-1086"><a href="#main-1086"><span class="linenos">1086</span></a>        <span class="p">},</span>
</span><span id="main-1087"><a href="#main-1087"><span class="linenos">1087</span></a>    <span class="p">)</span>
</span><span id="main-1088"><a href="#main-1088"><span class="linenos">1088</span></a>
</span><span id="main-1089"><a href="#main-1089"><span class="linenos">1089</span></a>    <span class="c1"># clear temporary arrow structure</span>
</span><span id="main-1090"><a href="#main-1090"><span class="linenos">1090</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">):</span>
</span><span id="main-1091"><a href="#main-1091"><span class="linenos">1091</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.arrow&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Main coordinates the flow of data through the functions defined in <code>read_zap_report.py</code>.
It also handles errors and error messages so that the script can be debugged without
long tracebacks.</p>
</div>


                </section>
    </main>
</body>
</html>
